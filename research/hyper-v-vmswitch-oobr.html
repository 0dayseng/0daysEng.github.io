<!DOCTYPE HTML>
<html lang="en">
   <head>
      <!-- Google tag (gtag.js) -->
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-RBMCFM6G1Z"></script>
      <script>
         window.dataLayer = window.dataLayer || [];
         function gtag(){dataLayer.push(arguments);}
         gtag('js', new Date());

         gtag('config', 'G-RBMCFM6G1Z');
      </script>
      <!--Meta Tags-->
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="description" content=""/>
      <meta name="keywords" content=""/>
      <meta name="author" content=""/>
      <base href="../"> 
      <!--Favicons-->
      <link rel="shortcut icon" href="images/favicon.png">
      <!--Page Title-->
      <title>Microsoft Hyper-V Virtual Network Switch VmsMpCommonPvtSetRequestCommon Out of Bounds Read – Zero Day Engineering Blog</title>
      <!-- Stylesheets -->
      <!-- bootstrap -->
      <link rel="stylesheet" href="css/bootstrap.min.css">
      <!-- Animate -->
      <link rel="stylesheet" href="css/animate.min.css">
      <!-- Owl carusel -->
      <link rel="stylesheet" href="css/owl.carousel.min.css">
      <!-- Aos Css-->
      <link rel="stylesheet" href="css/aos.css"/>
      <!-- font awesome -->
      <link rel="stylesheet" href="css/font-awesome.min.css">
      <!-- main css -->
      <link rel="stylesheet" href="css/style_20231213.css">
   </head>
   <body data-spy="scroll" data-target=".site-nav-target" data-offset="200">

      <!-- Nav mobile -->
      <nav class="site-mobile-menu">
         <div class="close-wrap d-flex">
            <a href="#" class="d-flex ml-auto js-menu-toggle">
               <span class="close-label">Close</span>
               <div class="close-times">
                  <span class="bar1"></span>
                  <span class="bar2"></span>
               </div>
            </a>
         </div>
         <div class="site-mobile-inner"></div>
      </nav>
      <!-- Nav mobile end -->

      <!-- Main content wrap -->
      <div class="site-wrap">
         <!-- Main content inner -->
         <div class="site-inner">

            <!-- Main Nav -->
            <nav class="site-nav site-nav-target">
               <div class="container">
                  <div class="row align-items-center justify-content-between text-left">
                     <div class="col-3">
                        <div class="site-logo">
                           <a href="index.html" class="site-logo main-logo"><img src="images/logo.png" class="logo-img light-logo img-fluid" alt=""><span></span></a>
                        </div>
                     </div>
                     <div class="col text-right">
                        <ul class="site-nav-ul js-clone-nav text-left d-none d-lg-inline-block">
                              <li><a href="index.html" class="nav-link cursor-item">Main</a></li>
                              <li class="has-children">
                                 <a href="research/index.html" class="nav-link cursor-item">Research</a>
                                 <ul class="dropdown">
                                    <li><a href="insights/index.html">0-Day Insights</a></li>
                                    <li><a href="research/index.html">Vulnerabilities & Exploits</a></li>
                                    <li><a href="research/index.html">Advanced Reverse Engineering</a></li>
                                    <li><a href="research/index.html">Abstract Modeling</a></li>
                                 </ul>
                              </li>

                              <li class="has-children">
                                 <a href="training/index.html" class="nav-link cursor-item">Training</a>
                                 <ul class="dropdown">
                                    <li><a href="training/index.html">Courses</a></li>
                                    <li><a href="training/index.html#nightly">Masterclasses</a></li>
                                 </ul>
                              </li>

                              <li class="has-children">
                                 <a href="about.html" class="nav-link cursor-item">Company</a>
                                 <ul class="dropdown">
                                    <li><a href="about.html">About us</a></li>
                                    <li><a href="work-with-us.html">Work with us</a></li>
                                    <li><a href="contact.html">Contact</a></li>
                                 </ul>
                              </li>                           </ul>
                           <ul class="site-nav-ul-none-onepage text-right d-inline-block d-lg-none">
                           <li><a href="#" class="js-menu-toggle">Menu</a></li>
                        </ul>
                     </div>
                  </div>
               </div>
            </nav>
            <!-- Main Nav end -->

            <div class="section">
               <div class="blog-single-inner">
                  <div class="container">
                     <div class="row justify-content-center">
                        <div class="col-md-8">
                           <div id="quote"></div>
                           <h3 class="mb-4">Microsoft Hyper-V Virtual Network Switch VmsMpCommonPvtSetRequestCommon Out of Bounds Read</h3>
                           <p class="date">February 15th, 2021 – Alisa Esage</p>

                           <p>Hyper-V relies on a component named Virtual Network Switch to provide various networking services to virtual machines. Virtual Network Switch (vmswitch.sys) is an RNDIS-compliant virtual device that lives in the kernel of the root partition. It is directly exposed to Generation 2 VMs as a paravirtualized virtual ethernet controller, and in Generation 1 VMs it is utilized indirectly by serving as a backend for the emulated DEC ethernet controller. In all cases, vmswitch is the bigbone behind everything networking in a Hyper-V cloud, from providing internet connectivity and virtual LAN to VMs, to bridging all that into physical ethernet adapters on the host. </p>

                           <p>Generation 2 VMs talk to the vmswitch directly by sending RNDIS protocol data and networking streams over the VMBUS. The vmswitch.sys module in the root partition listens to data availability on the VMBUS in a DPC thread on Windows, that would be woken up with a synthetic interrupt generated by the VM. The RNDIS protocol data provided by VM is then parsed and scheduled for processing in respective subsystems of the virtual device. </p>
                           
                           <p>When vmswitch receives an RNDIS message of type Set, and after a series of data sanitizations, VmsMpCommonPvtSetRequestCommon() procedure will be eventually called to process it. Inside VmsMpCommonPvtSetRequestCommon one particular path is responsible for handling RNDIS Set requests with OID RNDIS_OID_GEN_RNDIS_CONFIG_PARAMETER:</p>
                           
                           <script src="https://gist.github.com/alisaesage/6e0df779c03ffc2c4d0e7053cc8c58b5.js"></script>
                           
                           <p>At the start of the above code snippet, $r9 register points to InformationBuffer of type rndis_config_parameter_info:</p>
                           
                           <p>/* Linux Integration Services */<br>
                           /* Format of Information buffer passed in a SetRequest for the OID */<br>
                           /* OID_GEN_RNDIS_CONFIG_PARAMETER. */<br>
                           struct rndis_config_parameter_info {<br>
                           &nbsp;&nbsp;u32 parameter_name_offset;<br>
                           &nbsp;&nbsp;u32 parameter_name_length;<br>
                           &nbsp;&nbsp;u32 parameter_type;<br>
                           &nbsp;&nbsp;u32 parameter_value_offset;<br>
                           &nbsp;&nbsp;u32 parameter_value_length;<br>
                           };</p>
                           
                           <p>The contents and the length of this data are fully controlled by the VM.</p>
                           
                           <p>The four checks in the above snippet correctly validate that the data offsets provided by rndis_config_parameter_info members fall within the bounds of the request. However, there is a narrow edge case which is not validate. When memcmp() is finally called at 00000001C001FB6E with a static length value of 0x1c, $r15 points to a VM-controlled value of parameter_name, that can be smaller than 0x1c. In case that parameter_name is smaller than 0x1c and also falls at the end of the allocated memory page which is adjacent to unallocated space, the root partition OS will bugcheck due to a read access violation. </p>
                           
                           <p>Potential impact of this bug is a persistent DoS of the entire Hyper-V cloud. Exploitation is not straightforward, and the heap must be groomed specifically in order to crash a vulnerable Hyper-V host in the absence of specialized debugging instrumentation. </p>


                           <h5>Exploitation notes</h5>

                           <p>It is theoretically possible to exploit this issue without the Driver Verifier enabled, and cause a persistent DoS in the Hyper-V root partition OS from an arbitrary Guest OS and in default configuration.</p>

                           <p>First, note that a Guest VM has a significant degree of control over memory management in vmswitch. For example, consider the output from !verifier on the faulting memory:</p>

                           <script src="https://gist.github.com/alisaesage/652d205beca7b8a2cbe0659648c14197.js"></script>

                           <p>RndisDevHostDispatchControlMessage in the allocation backtrace is the top-level function that dispatches RNDIS requests from the guest. For each incoming request it allocates memory based on the size of the request, as it is provided by the Guest VM. Thus the Guest VM controls both the timing and the size of memory allocations in vmswitch, which is conductive to heap grooming.</p>

                           <p>It is not clear whether the Guest VM has the same degree of control over freeing of memory. The memory allocated for a request is freed once vmswitch has finished processing it. However, a free() primitive may be synthetically constructed (at least) by exploiting the fact that some RNDIS requests may take longer to process than the others.  </p>

                           <p>The general idea of exploitation is to create an alternating pattern of two types of memory pages: one, which is groomed such that our malicious request is the last byte sequence in the memory page; and another one, which is either free or may be predictably free'd by the VM.</p>

                           <p>Type 1 page may be crafted by first flushing the look-aside and freelists in the Windows kernel by sendins lots of small RNDIS requests of apropriate sizes, that will trigger the allocation of a new memory page; and then occupying the new page with small allocations in a controlled manner.</p>

                           <p>Type 2 page seems trickier to construct due to both limitations of the attacker's control over memory freeing, and KASLR mitigations. However I expect that an unallocated memory page may happen naturally following the Type 0 page in certain conditions, due to KASLR.</p>

                           <p>After the host BSODs and reboots, the Guest VM will start automatically, and run the exploit again. Thus a persistent DoS of the Hyper-V cloud may be achieved.</p>
                                                      
                           <p>This vulnerability and the relevant technical architectural context is further discussed in the <a href="training/hypervisor-vulnerability-research.html">"Hypervisor Exploitation I"</a> training.</p>

                           <p>CVE ID: CVE-2019-0717<br>
                           <a href="https://github.com/alisaesage/Disclosures/blob/master/CVE-2019-0717_Hyper-V/PoC_CVE-2019-0717.c">Proof-of-concept testcase</a><br>
                           Vulnerability discovery: Alisa Esage, Zero Day Engineering</p>
                                                         
                           <div class="pt-5 mb-5 categories_tags ">
                              <p class="tags">Categories: Vulnerability, Virtualization</p>
                              <div class="social float-right">
                                 <a href="https://www.facebook.com/sharer/sharer.php?u=https://zerodayengineering.com/research/hyper-v-vmswitch-oobr.html&t=Vulnerability%20Analysis:%20Microsoft%20Hyper-V%20Virtual%20Network Switch%20VmsMpCommonPvtSetRequestCommon%20Out%20of%20Bounds%20Read" class="mr-3"><i class="fa fa-facebook"></i></a>
                                 <a href="https://twitter.com/intent/tweet?url=https://zerodayengineering.com/research/hyper-v-vmswitch-oobr.html&text=Vulnerability%20Analysis:%20Microsoft%20Hyper-V%20Virtual%20Network Switch%20VmsMpCommonPvtSetRequestCommon%20Out%20of%20Bounds%20Read" class="mr-3"><i class="fa fa-twitter"></i></a>
                                 <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://zerodayengineering.com/research/hyper-v-vmswitch-oobr.html&title=Vulnerability%20Analysis:%20Microsoft%20Hyper-V%20Virtual%20Network Switch%20VmsMpCommonPvtSetRequestCommon%20Out%20of%20Bounds%20Read" class="mr-3"><i class="fa fa-linkedin"></i></a>
                              </div>
                           </div>
                           
                           <div class="post-single-navigation d-flex align-items-stretch">
                              <a href="research/index.html" class="mr-auto w-50 pr-4">
                                 <span class="d-block cursor-item"><i class="fa fa-chevron-left mr-2"></i> Research</span></a>
                              <a href="training/index.html" class="ml-auto w-50 text-right pl-4">
                                 <span class="d-block cursor-item">Training <i class="fa fa-chevron-right ml-2"></i></span></a>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>

            <!-- Footer -->
            <footer class="footer section">
               <div class="container">
                  <div class="row justify-content-center">
                     <div class="col-md-12">
                        <div class="go-top cursor-item" id="go-to-top"><i class="fa fa-chevron-up"></i></div>
                        <div class="hr-footer"></div>
                        <div class="footer-site-logo"><a href="index.html" class="main-logo"><img src="images/logo.png" class="logo-img light-logo img-fluid" alt=""></a></div>                       
                        <p class="site-copyright">
                           <small>&copy; 2024 Zero Day Engineering LLC. All Rights Reserved. <a href="rss" class="social-icon"><i class="fa fa-rss"></i></a></small>
                           
                        </p>
                     </div>
                  </div>
               </div>
            </footer>
            <!-- Footer end -->

         </div>
         <!-- Main content inner end -->
      </div>
      <!-- Main content wrap end -->

      <!-- Back to top button -->
      <a id="back-to-top" href="#" class="cursor-item desktop-only"><i class="fa fa-chevron-up"></i></a>

      <div class="cursor"></div>
      <div class="cursor-follower"></div>

      <!-- jquery -->
      <script src="js/query-3.4.1.min.js"></script>
      <!-- bootstrap -->
      <script src="js/bootstrap.min.js"></script>
      <!-- aos -->
      <script src="js/aos.js"></script>
      <!-- owl.carusel js -->
      <script src="js/owl.carousel.min.js"></script>
      <!-- isotope js -->
      <script src="js/isotope.pkgd.min.js"></script>
      <!-- isotope image loader js -->
      <script src="js/imagesloaded.pkgd.min.js"></script>
      <!-- three -->
      <script src="js/three.min.js"></script>
      <!-- anime -->
      <script src="js/anime.min.js"></script>
      <!-- tweenmax -->
      <script src="js/TweenMax.min.js"></script>
      <!-- jquery.waypoints.min.js -->
      <script src="js/jquery.waypoints.min.js"></script>
      <!-- circletype-->
      <script src="js/circletype.min.js"></script>
      <!-- hover-effect -->
      <script src="js/hover-effect.umd.js"></script>
      <!-- gsap -->
      <script src="js/gsap.min.js"></script>
      <!-- ScrollMagic gsap -->
      <script src="js/ScrollMagic.min.js"></script>
      <script src="js/scrollmagic.animation.gsap.min.js"></script>
      <!-- custom -->
      <script src="js/custom.js"></script>
   </body>
</html>