<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>KVM: arch/x86/kvm/svm/avic.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">KVM
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_ea9599923402ca8ab47fc3e495999dea.html">arch</a></li><li class="navelem"><a class="el" href="dir_c21774f8bc9f0de15163573e5f5fa2b5.html">x86</a></li><li class="navelem"><a class="el" href="dir_fde450fd4b58e2560c53a1e73bfa4d6d.html">kvm</a></li><li class="navelem"><a class="el" href="dir_59e270fee840b69a56de99d30906df9d.html">svm</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">avic.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="avic_8c.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">// SPDX-License-Identifier: GPL-2.0-only</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> * Kernel-based Virtual Machine driver for Linux</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> * AMD SVM support</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"> * Copyright (C) 2006 Qumranet, Inc.</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> * Copyright 2010 Red Hat, Inc. and/or its affiliates.</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"> * Authors:</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"> *   Yaniv Kamay  &lt;yaniv@qumranet.com&gt;</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment"> *   Avi Kivity   &lt;avi@qumranet.com&gt;</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160; </div>
<div class="line"><a name="l00015"></a><span class="lineno"><a class="line" href="avic_8c.html#a1f8c165bf4196327bc3abff648276d92">   15</a></span>&#160;<span class="preprocessor">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot;</span> fmt</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160; </div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#include &lt;linux/kvm_types.h&gt;</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">#include &lt;linux/hashtable.h&gt;</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#include &lt;linux/amd-iommu.h&gt;</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#include &lt;linux/kvm_host.h&gt;</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160; </div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor">#include &lt;asm/irq_remapping.h&gt;</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160; </div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="trace_8h.html">trace.h</a>&quot;</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="lapic_8h.html">lapic.h</a>&quot;</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="x86_8h.html">x86.h</a>&quot;</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="irq_8h.html">irq.h</a>&quot;</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="svm_8h.html">svm.h</a>&quot;</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160; </div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment"> * Encode the arbitrary VM ID and the vCPU&#39;s default APIC ID, i.e the vCPU ID,</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="comment"> * into the GATag so that KVM can retrieve the correct vCPU from a GALog entry</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="comment"> * if an interrupt can&#39;t be delivered, e.g. because the vCPU isn&#39;t running.</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="comment"> * For the vCPU ID, use however many bits are currently allowed for the max</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="comment"> * guest physical APIC ID (limited by the size of the physical ID table), and</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="comment"> * use whatever bits remain to assign arbitrary AVIC IDs to VMs.  Note, the</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="comment"> * size of the GATag is defined by hardware (32 bits), but is an opaque value</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="comment"> * as far as hardware is concerned.</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00041"></a><span class="lineno"><a class="line" href="avic_8c.html#a85aae38c76b154dc96183124f815e5e4">   41</a></span>&#160;<span class="preprocessor">#define AVIC_VCPU_ID_MASK       AVIC_PHYSICAL_MAX_INDEX_MASK</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160; </div>
<div class="line"><a name="l00043"></a><span class="lineno"><a class="line" href="avic_8c.html#a9c20b22e6bbe72fbdd760aaff3dc45ef">   43</a></span>&#160;<span class="preprocessor">#define AVIC_VM_ID_SHIFT        HWEIGHT32(AVIC_PHYSICAL_MAX_INDEX_MASK)</span></div>
<div class="line"><a name="l00044"></a><span class="lineno"><a class="line" href="avic_8c.html#aa582eb517550b4af588363963042a791">   44</a></span>&#160;<span class="preprocessor">#define AVIC_VM_ID_MASK         (GENMASK(31, AVIC_VM_ID_SHIFT) &gt;&gt; AVIC_VM_ID_SHIFT)</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160; </div>
<div class="line"><a name="l00046"></a><span class="lineno"><a class="line" href="avic_8c.html#a504afac7afffff075f42d33af8c21ef0">   46</a></span>&#160;<span class="preprocessor">#define AVIC_GATAG_TO_VMID(x)       ((x &gt;&gt; AVIC_VM_ID_SHIFT) &amp; AVIC_VM_ID_MASK)</span></div>
<div class="line"><a name="l00047"></a><span class="lineno"><a class="line" href="avic_8c.html#a379bb93a0924b7a44f0fa7cdd37517b1">   47</a></span>&#160;<span class="preprocessor">#define AVIC_GATAG_TO_VCPUID(x)     (x &amp; AVIC_VCPU_ID_MASK)</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160; </div>
<div class="line"><a name="l00049"></a><span class="lineno"><a class="line" href="avic_8c.html#a591769978fd794e332f217d97f35bfec">   49</a></span>&#160;<span class="preprocessor">#define __AVIC_GATAG(vm_id, vcpu_id)    ((((vm_id) &amp; AVIC_VM_ID_MASK) &lt;&lt; AVIC_VM_ID_SHIFT) | \</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="preprocessor">                     ((vcpu_id) &amp; AVIC_VCPU_ID_MASK))</span></div>
<div class="line"><a name="l00051"></a><span class="lineno"><a class="line" href="avic_8c.html#a76254d6522116c2c98b13d9342ba145a">   51</a></span>&#160;<span class="preprocessor">#define AVIC_GATAG(vm_id, vcpu_id)                  \</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="preprocessor">({                                  \</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="preprocessor">    u32 ga_tag = __AVIC_GATAG(vm_id, vcpu_id);          \</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="preprocessor">                                    \</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="preprocessor">    WARN_ON_ONCE(AVIC_GATAG_TO_VCPUID(ga_tag) != (vcpu_id));    \</span></div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="preprocessor">    WARN_ON_ONCE(AVIC_GATAG_TO_VMID(ga_tag) != (vm_id));        \</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="preprocessor">    ga_tag;                             \</span></div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="preprocessor">})</span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160; </div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;static_assert(<a class="code" href="avic_8c.html#a591769978fd794e332f217d97f35bfec">__AVIC_GATAG</a>(<a class="code" href="avic_8c.html#aa582eb517550b4af588363963042a791">AVIC_VM_ID_MASK</a>, <a class="code" href="avic_8c.html#a85aae38c76b154dc96183124f815e5e4">AVIC_VCPU_ID_MASK</a>) == -1u);</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160; </div>
<div class="line"><a name="l00062"></a><span class="lineno"><a class="line" href="avic_8c.html#a969a7c5f37696d459ce0a2065a8ca97f">   62</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="avic_8c.html#a969a7c5f37696d459ce0a2065a8ca97f">force_avic</a>;</div>
<div class="line"><a name="l00063"></a><span class="lineno"><a class="line" href="avic_8c.html#a6a50d2e2e091254aac3982a50360a8ba">   63</a></span>&#160;<a class="code" href="avic_8c.html#a6a50d2e2e091254aac3982a50360a8ba">module_param_unsafe</a>(<a class="code" href="avic_8c.html#a969a7c5f37696d459ce0a2065a8ca97f">force_avic</a>, <span class="keywordtype">bool</span>, 0444);</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160; </div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="comment">/* Note:</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="comment"> * This hash table is used to map VM_ID to a struct kvm_svm,</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="comment"> * when handling AMD IOMMU GALOG notification to schedule in</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="comment"> * a particular vCPU.</span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00070"></a><span class="lineno"><a class="line" href="avic_8c.html#a43bf45802761215fb7aeb3a0f716a429">   70</a></span>&#160;<span class="preprocessor">#define SVM_VM_DATA_HASH_BITS   8</span></div>
<div class="line"><a name="l00071"></a><span class="lineno"><a class="line" href="avic_8c.html#aa0b824f0eb25d52b2753a0446792f7d9">   71</a></span>&#160;<span class="keyword">static</span> <a class="code" href="avic_8c.html#aa0b824f0eb25d52b2753a0446792f7d9">DEFINE_HASHTABLE</a>(svm_vm_data_hash, <a class="code" href="avic_8c.html#a43bf45802761215fb7aeb3a0f716a429">SVM_VM_DATA_HASH_BITS</a>);</div>
<div class="line"><a name="l00072"></a><span class="lineno"><a class="line" href="avic_8c.html#aebb4737cca7862427a4b94f3f086dee3">   72</a></span>&#160;<span class="keyword">static</span> u32 <a class="code" href="avic_8c.html#aebb4737cca7862427a4b94f3f086dee3">next_vm_id</a> = 0;</div>
<div class="line"><a name="l00073"></a><span class="lineno"><a class="line" href="avic_8c.html#a1e123c3defad20a133e56f43373b9c44">   73</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="avic_8c.html#a1e123c3defad20a133e56f43373b9c44">next_vm_id_wrapped</a> = 0;</div>
<div class="line"><a name="l00074"></a><span class="lineno"><a class="line" href="avic_8c.html#a48d73aa47db0cd13044af80a191469b6">   74</a></span>&#160;<span class="keyword">static</span> <a class="code" href="avic_8c.html#a48d73aa47db0cd13044af80a191469b6">DEFINE_SPINLOCK</a>(svm_vm_data_hash_lock);</div>
<div class="line"><a name="l00075"></a><span class="lineno"><a class="line" href="avic_8c.html#ad4c0ba70ab315cedbb11f259b1d7ae08">   75</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="avic_8c.html#ad4c0ba70ab315cedbb11f259b1d7ae08">x2avic_enabled</a>;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160; </div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;<span class="comment"> * This is a wrapper of struct amd_iommu_ir_data.</span></div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00080"></a><span class="lineno"><a class="line" href="structamd__svm__iommu__ir.html">   80</a></span>&#160;<span class="keyword">struct </span><a class="code" href="structamd__svm__iommu__ir.html">amd_svm_iommu_ir</a> {</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    <span class="keyword">struct </span>list_head <a class="code" href="structamd__svm__iommu__ir.html#a54d6bf7341caaad5d37469694a4bd434">node</a>;  <span class="comment">/* Used by SVM for per-vcpu ir_list */</span></div>
<div class="line"><a name="l00082"></a><span class="lineno"><a class="line" href="structamd__svm__iommu__ir.html#ad1d0011f27de4fbde266e0ce65476e84">   82</a></span>&#160;    <span class="keywordtype">void</span> *<a class="code" href="structamd__svm__iommu__ir.html#ad1d0011f27de4fbde266e0ce65476e84">data</a>;     <span class="comment">/* Storing pointer to struct amd_ir_data */</span></div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;};</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160; </div>
<div class="line"><a name="l00085"></a><span class="lineno"><a class="line" href="avic_8c.html#a2af29a6a396bb757ac21f02f6aacfdfa">   85</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="avic_8c.html#a2af29a6a396bb757ac21f02f6aacfdfa">avic_activate_vmcb</a>(<span class="keyword">struct</span> <a class="code" href="structvcpu__svm.html">vcpu_svm</a> *svm)</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;{</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    <span class="keyword">struct </span>vmcb *vmcb = svm-&gt;<a class="code" href="structvcpu__svm.html#af0c24755d59a0cfca7ce9ba64f682722">vmcb01</a>.<a class="code" href="structkvm__vmcb__info.html#a8076921f239564576af7af19be7f6f04">ptr</a>;</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160; </div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    vmcb-&gt;control.int_ctl &amp;= ~(AVIC_ENABLE_MASK | X2APIC_MODE_MASK);</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;    vmcb-&gt;control.avic_physical_id &amp;= ~AVIC_PHYSICAL_MAX_INDEX_MASK;</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160; </div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    vmcb-&gt;control.int_ctl |= AVIC_ENABLE_MASK;</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160; </div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="comment">     * Note: KVM supports hybrid-AVIC mode, where KVM emulates x2APIC MSR</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="comment">     * accesses, while interrupt injection to a running vCPU can be</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="comment">     * achieved using AVIC doorbell.  KVM disables the APIC access page</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="comment">     * (deletes the memslot) if any vCPU has x2APIC enabled, thus enabling</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="comment">     * AVIC in hybrid mode activates only the doorbell mechanism.</span></div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="avic_8c.html#ad4c0ba70ab315cedbb11f259b1d7ae08">x2avic_enabled</a> &amp;&amp; <a class="code" href="lapic_8h.html#a07d3e1e4090a62753325dfa11d232cea">apic_x2apic_mode</a>(svm-&gt;<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>.arch.apic)) {</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;        vmcb-&gt;control.int_ctl |= X2APIC_MODE_MASK;</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;        vmcb-&gt;control.avic_physical_id |= X2AVIC_MAX_PHYSICAL_ID;</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;        <span class="comment">/* Disabling MSR intercept for x2APIC registers */</span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;        <a class="code" href="svm_8c.html#a195738d23c6f6b6bf7269334d3a38721">svm_set_x2apic_msr_interception</a>(svm, <span class="keyword">false</span>);</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="comment">         * Flush the TLB, the guest may have inserted a non-APIC</span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="comment">         * mapping into the TLB while AVIC was disabled.</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="comment">         */</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;        kvm_make_request(KVM_REQ_TLB_FLUSH_CURRENT, &amp;svm-&gt;<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>);</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160; </div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;        <span class="comment">/* For xAVIC and hybrid-xAVIC modes */</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;        vmcb-&gt;control.avic_physical_id |= AVIC_MAX_PHYSICAL_ID;</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;        <span class="comment">/* Enabling MSR intercept for x2APIC registers */</span></div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;        <a class="code" href="svm_8c.html#a195738d23c6f6b6bf7269334d3a38721">svm_set_x2apic_msr_interception</a>(svm, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    }</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;}</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160; </div>
<div class="line"><a name="l00120"></a><span class="lineno"><a class="line" href="avic_8c.html#ac41a57fe4f855076b5c5718def5bd6d3">  120</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="avic_8c.html#ac41a57fe4f855076b5c5718def5bd6d3">avic_deactivate_vmcb</a>(<span class="keyword">struct</span> <a class="code" href="structvcpu__svm.html">vcpu_svm</a> *svm)</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;{</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    <span class="keyword">struct </span>vmcb *vmcb = svm-&gt;<a class="code" href="structvcpu__svm.html#af0c24755d59a0cfca7ce9ba64f682722">vmcb01</a>.<a class="code" href="structkvm__vmcb__info.html#a8076921f239564576af7af19be7f6f04">ptr</a>;</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160; </div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    vmcb-&gt;control.int_ctl &amp;= ~(AVIC_ENABLE_MASK | X2APIC_MODE_MASK);</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    vmcb-&gt;control.avic_physical_id &amp;= ~AVIC_PHYSICAL_MAX_INDEX_MASK;</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160; </div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;<span class="comment">     * If running nested and the guest uses its own MSR bitmap, there</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="comment">     * is no need to update L0&#39;s msr bitmap</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="kvm__cache__regs_8h.html#afbcfc413ceedb460734eb5fd7c5c4fbc">is_guest_mode</a>(&amp;svm-&gt;<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>) &amp;&amp;</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;        <a class="code" href="svm_8h.html#a5deff43556f8c807c64def073cd548e4">vmcb12_is_intercept</a>(&amp;svm-&gt;<a class="code" href="structvcpu__svm.html#aa2e4d643ef957cd597e82a29f0f0a2c8">nested</a>.<a class="code" href="structsvm__nested__state.html#a3b275e369200f402f9d5765babb77629">ctl</a>, INTERCEPT_MSR_PROT))</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160; </div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    <span class="comment">/* Enabling MSR intercept for x2APIC registers */</span></div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;    <a class="code" href="svm_8c.html#a195738d23c6f6b6bf7269334d3a38721">svm_set_x2apic_msr_interception</a>(svm, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;}</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160; </div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;<span class="comment">/* Note:</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="comment"> * This function is called from IOMMU driver to notify</span></div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="comment"> * SVM to schedule in a particular vCPU of a particular VM.</span></div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00143"></a><span class="lineno"><a class="line" href="avic_8c.html#af75098185942f8eb5703b2b65bf9257d">  143</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="avic_8c.html#af75098185942f8eb5703b2b65bf9257d">avic_ga_log_notifier</a>(u32 ga_tag)</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;{</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="xen_8c.html#a773b39d480759f67926cb18ae2219281">flags</a>;</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    <span class="keyword">struct </span><a class="code" href="structkvm__svm.html">kvm_svm</a> *<a class="code" href="structkvm__svm.html">kvm_svm</a>;</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    <span class="keyword">struct </span>kvm_vcpu *vcpu = NULL;</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    u32 vm_id = <a class="code" href="avic_8c.html#a504afac7afffff075f42d33af8c21ef0">AVIC_GATAG_TO_VMID</a>(ga_tag);</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    u32 vcpu_id = <a class="code" href="avic_8c.html#a379bb93a0924b7a44f0fa7cdd37517b1">AVIC_GATAG_TO_VCPUID</a>(ga_tag);</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160; </div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    pr_debug(<span class="stringliteral">&quot;SVM: %s: vm_id=%#x, vcpu_id=%#x\n&quot;</span>, __func__, vm_id, vcpu_id);</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;    trace_kvm_avic_ga_log(vm_id, vcpu_id);</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160; </div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    spin_lock_irqsave(&amp;svm_vm_data_hash_lock, <a class="code" href="xen_8c.html#a773b39d480759f67926cb18ae2219281">flags</a>);</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    hash_for_each_possible(svm_vm_data_hash, <a class="code" href="structkvm__svm.html">kvm_svm</a>, hnode, vm_id) {</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="structkvm__svm.html">kvm_svm</a>-&gt;<a class="code" href="structkvm__svm.html#a06c4479d5aefb8c19b8ead15d599b324">avic_vm_id</a> != vm_id)</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;        vcpu = kvm_get_vcpu_by_id(&amp;<a class="code" href="structkvm__svm.html">kvm_svm</a>-&gt;<a class="code" href="structkvm__svm.html#ade6c6ec6e820a10719c5d61e161aa8b8">kvm</a>, vcpu_id);</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;    }</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    spin_unlock_irqrestore(&amp;svm_vm_data_hash_lock, <a class="code" href="xen_8c.html#a773b39d480759f67926cb18ae2219281">flags</a>);</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160; </div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    <span class="comment">/* Note:</span></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;<span class="comment">     * At this point, the IOMMU should have already set the pending</span></div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;<span class="comment">     * bit in the vAPIC backing page. So, we just need to schedule</span></div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;<span class="comment">     * in the vcpu.</span></div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    <span class="keywordflow">if</span> (vcpu)</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;        <a class="code" href="kvm__main_8c.html#ad9f0140eebcdef9a9ebae54431d2fba5">kvm_vcpu_wake_up</a>(vcpu);</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160; </div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;}</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160; </div>
<div class="line"><a name="l00174"></a><span class="lineno"><a class="line" href="avic_8c.html#a3bb736e8688ecfaa3696b347764fd37d">  174</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="avic_8c.html#a3bb736e8688ecfaa3696b347764fd37d">avic_vm_destroy</a>(<span class="keyword">struct</span> kvm *kvm)</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;{</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="xen_8c.html#a773b39d480759f67926cb18ae2219281">flags</a>;</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    <span class="keyword">struct </span><a class="code" href="structkvm__svm.html">kvm_svm</a> *<a class="code" href="structkvm__svm.html">kvm_svm</a> = <a class="code" href="svm_8h.html#ac27f6fe2ff4beeb5ad1b11681d0386fd">to_kvm_svm</a>(<a class="code" href="structkvm__svm.html#ade6c6ec6e820a10719c5d61e161aa8b8">kvm</a>);</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160; </div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="x86_8c.html#a04af9ab3eee510b54cba17a6fa94ee04">enable_apicv</a>)</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160; </div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="structkvm__svm.html">kvm_svm</a>-&gt;<a class="code" href="structkvm__svm.html#a837dca12e3d1d7b768feb04c6a3c2e96">avic_logical_id_table_page</a>)</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;        __free_page(<a class="code" href="structkvm__svm.html">kvm_svm</a>-&gt;<a class="code" href="structkvm__svm.html#a837dca12e3d1d7b768feb04c6a3c2e96">avic_logical_id_table_page</a>);</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="structkvm__svm.html">kvm_svm</a>-&gt;<a class="code" href="structkvm__svm.html#aa05522988cc0a3ce6ad59dcec1ed0c46">avic_physical_id_table_page</a>)</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;        __free_page(<a class="code" href="structkvm__svm.html">kvm_svm</a>-&gt;<a class="code" href="structkvm__svm.html#aa05522988cc0a3ce6ad59dcec1ed0c46">avic_physical_id_table_page</a>);</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160; </div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    spin_lock_irqsave(&amp;svm_vm_data_hash_lock, <a class="code" href="xen_8c.html#a773b39d480759f67926cb18ae2219281">flags</a>);</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    hash_del(&amp;<a class="code" href="structkvm__svm.html">kvm_svm</a>-&gt;<a class="code" href="structkvm__svm.html#a4f8eab5b98a43c0a7402d15663d4e032">hnode</a>);</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;    spin_unlock_irqrestore(&amp;svm_vm_data_hash_lock, <a class="code" href="xen_8c.html#a773b39d480759f67926cb18ae2219281">flags</a>);</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;}</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160; </div>
<div class="line"><a name="l00192"></a><span class="lineno"><a class="line" href="avic_8c.html#a0ddedac4b0b428928fae6bc9fe902e2a">  192</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="avic_8c.html#a0ddedac4b0b428928fae6bc9fe902e2a">avic_vm_init</a>(<span class="keyword">struct</span> <a class="code" href="structkvm__svm.html#ade6c6ec6e820a10719c5d61e161aa8b8">kvm</a> *<a class="code" href="structkvm__svm.html#ade6c6ec6e820a10719c5d61e161aa8b8">kvm</a>)</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;{</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="xen_8c.html#a773b39d480759f67926cb18ae2219281">flags</a>;</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    <span class="keywordtype">int</span> err = -ENOMEM;</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    <span class="keyword">struct </span><a class="code" href="structkvm__svm.html">kvm_svm</a> *<a class="code" href="structkvm__svm.html">kvm_svm</a> = <a class="code" href="svm_8h.html#ac27f6fe2ff4beeb5ad1b11681d0386fd">to_kvm_svm</a>(<a class="code" href="structkvm__svm.html#ade6c6ec6e820a10719c5d61e161aa8b8">kvm</a>);</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    <span class="keyword">struct </span><a class="code" href="structkvm__svm.html">kvm_svm</a> *k2;</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    <span class="keyword">struct </span>page *p_page;</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    <span class="keyword">struct </span>page *l_page;</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    u32 vm_id;</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160; </div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="x86_8c.html#a04af9ab3eee510b54cba17a6fa94ee04">enable_apicv</a>)</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160; </div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    <span class="comment">/* Allocating physical APIC ID table (4KB) */</span></div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    p_page = alloc_page(GFP_KERNEL_ACCOUNT | __GFP_ZERO);</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    <span class="keywordflow">if</span> (!p_page)</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;        <span class="keywordflow">goto</span> free_avic;</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160; </div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    <a class="code" href="structkvm__svm.html">kvm_svm</a>-&gt;<a class="code" href="structkvm__svm.html#aa05522988cc0a3ce6ad59dcec1ed0c46">avic_physical_id_table_page</a> = p_page;</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160; </div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    <span class="comment">/* Allocating logical APIC ID table (4KB) */</span></div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    l_page = alloc_page(GFP_KERNEL_ACCOUNT | __GFP_ZERO);</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    <span class="keywordflow">if</span> (!l_page)</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;        <span class="keywordflow">goto</span> free_avic;</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160; </div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    <a class="code" href="structkvm__svm.html">kvm_svm</a>-&gt;<a class="code" href="structkvm__svm.html#a837dca12e3d1d7b768feb04c6a3c2e96">avic_logical_id_table_page</a> = l_page;</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160; </div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    spin_lock_irqsave(&amp;svm_vm_data_hash_lock, <a class="code" href="xen_8c.html#a773b39d480759f67926cb18ae2219281">flags</a>);</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160; again:</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    vm_id = <a class="code" href="avic_8c.html#aebb4737cca7862427a4b94f3f086dee3">next_vm_id</a> = (<a class="code" href="avic_8c.html#aebb4737cca7862427a4b94f3f086dee3">next_vm_id</a> + 1) &amp; <a class="code" href="avic_8c.html#aa582eb517550b4af588363963042a791">AVIC_VM_ID_MASK</a>;</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    <span class="keywordflow">if</span> (vm_id == 0) { <span class="comment">/* id is 1-based, zero is not okay */</span></div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        <a class="code" href="avic_8c.html#a1e123c3defad20a133e56f43373b9c44">next_vm_id_wrapped</a> = 1;</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;        <span class="keywordflow">goto</span> again;</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    }</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    <span class="comment">/* Is it still in use? Only possible if wrapped at least once */</span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="avic_8c.html#a1e123c3defad20a133e56f43373b9c44">next_vm_id_wrapped</a>) {</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;        hash_for_each_possible(svm_vm_data_hash, k2, hnode, vm_id) {</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;            <span class="keywordflow">if</span> (k2-&gt;<a class="code" href="structkvm__svm.html#a06c4479d5aefb8c19b8ead15d599b324">avic_vm_id</a> == vm_id)</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;                <span class="keywordflow">goto</span> again;</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;        }</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    }</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    <a class="code" href="structkvm__svm.html">kvm_svm</a>-&gt;<a class="code" href="structkvm__svm.html#a06c4479d5aefb8c19b8ead15d599b324">avic_vm_id</a> = vm_id;</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;    hash_add(svm_vm_data_hash, &amp;<a class="code" href="structkvm__svm.html">kvm_svm</a>-&gt;<a class="code" href="structkvm__svm.html#a4f8eab5b98a43c0a7402d15663d4e032">hnode</a>, <a class="code" href="structkvm__svm.html">kvm_svm</a>-&gt;<a class="code" href="structkvm__svm.html#a06c4479d5aefb8c19b8ead15d599b324">avic_vm_id</a>);</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;    spin_unlock_irqrestore(&amp;svm_vm_data_hash_lock, <a class="code" href="xen_8c.html#a773b39d480759f67926cb18ae2219281">flags</a>);</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160; </div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160; </div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;free_avic:</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;    <a class="code" href="avic_8c.html#a3bb736e8688ecfaa3696b347764fd37d">avic_vm_destroy</a>(kvm);</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;    <span class="keywordflow">return</span> err;</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;}</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160; </div>
<div class="line"><a name="l00244"></a><span class="lineno"><a class="line" href="avic_8c.html#a40f16bbe281410ac02865ea25c26bf12">  244</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="avic_8c.html#a40f16bbe281410ac02865ea25c26bf12">avic_init_vmcb</a>(<span class="keyword">struct</span> <a class="code" href="structvcpu__svm.html">vcpu_svm</a> *svm, <span class="keyword">struct</span> vmcb *vmcb)</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;{</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    <span class="keyword">struct </span><a class="code" href="structkvm__svm.html">kvm_svm</a> *<a class="code" href="structkvm__svm.html">kvm_svm</a> = <a class="code" href="svm_8h.html#ac27f6fe2ff4beeb5ad1b11681d0386fd">to_kvm_svm</a>(svm-&gt;<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>.kvm);</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    phys_addr_t bpa = __sme_set(page_to_phys(svm-&gt;<a class="code" href="structvcpu__svm.html#a2c8b33d5ae9b731a886634cd6c00165f">avic_backing_page</a>));</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;    phys_addr_t lpa = __sme_set(page_to_phys(<a class="code" href="structkvm__svm.html">kvm_svm</a>-&gt;<a class="code" href="structkvm__svm.html#a837dca12e3d1d7b768feb04c6a3c2e96">avic_logical_id_table_page</a>));</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    phys_addr_t ppa = __sme_set(page_to_phys(<a class="code" href="structkvm__svm.html">kvm_svm</a>-&gt;<a class="code" href="structkvm__svm.html#aa05522988cc0a3ce6ad59dcec1ed0c46">avic_physical_id_table_page</a>));</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160; </div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    vmcb-&gt;control.avic_backing_page = bpa &amp; AVIC_HPA_MASK;</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;    vmcb-&gt;control.avic_logical_id = lpa &amp; AVIC_HPA_MASK;</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    vmcb-&gt;control.avic_physical_id = ppa &amp; AVIC_HPA_MASK;</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;    vmcb-&gt;control.avic_vapic_bar = APIC_DEFAULT_PHYS_BASE &amp; VMCB_AVIC_APIC_BAR_MASK;</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160; </div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="x86_8c.html#a21212b8e1a82cdc8ac696137981d8d7a">kvm_apicv_activated</a>(svm-&gt;<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>.kvm))</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;        <a class="code" href="avic_8c.html#a2af29a6a396bb757ac21f02f6aacfdfa">avic_activate_vmcb</a>(svm);</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;        <a class="code" href="avic_8c.html#ac41a57fe4f855076b5c5718def5bd6d3">avic_deactivate_vmcb</a>(svm);</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;}</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160; </div>
<div class="line"><a name="l00262"></a><span class="lineno"><a class="line" href="avic_8c.html#a8cfb06497cbd5960a4a909c44e701f06">  262</a></span>&#160;<span class="keyword">static</span> u64 *<a class="code" href="avic_8c.html#a8cfb06497cbd5960a4a909c44e701f06">avic_get_physical_id_entry</a>(<span class="keyword">struct</span> kvm_vcpu *vcpu,</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;                       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> index)</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;{</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    u64 *avic_physical_id_table;</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;    <span class="keyword">struct </span><a class="code" href="structkvm__svm.html">kvm_svm</a> *<a class="code" href="structkvm__svm.html">kvm_svm</a> = <a class="code" href="svm_8h.html#ac27f6fe2ff4beeb5ad1b11681d0386fd">to_kvm_svm</a>(vcpu-&gt;kvm);</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160; </div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;    <span class="keywordflow">if</span> ((!<a class="code" href="avic_8c.html#ad4c0ba70ab315cedbb11f259b1d7ae08">x2avic_enabled</a> &amp;&amp; index &gt; AVIC_MAX_PHYSICAL_ID) ||</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;        (index &gt; X2AVIC_MAX_PHYSICAL_ID))</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;        <span class="keywordflow">return</span> NULL;</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160; </div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    avic_physical_id_table = page_address(<a class="code" href="structkvm__svm.html">kvm_svm</a>-&gt;<a class="code" href="structkvm__svm.html#aa05522988cc0a3ce6ad59dcec1ed0c46">avic_physical_id_table_page</a>);</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160; </div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    <span class="keywordflow">return</span> &amp;avic_physical_id_table[index];</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;}</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160; </div>
<div class="line"><a name="l00277"></a><span class="lineno"><a class="line" href="avic_8c.html#aefc63eafb35c1efd94f6d53e7d0b20d5">  277</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="avic_8c.html#aefc63eafb35c1efd94f6d53e7d0b20d5">avic_init_backing_page</a>(<span class="keyword">struct</span> kvm_vcpu *vcpu)</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;{</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;    u64 *entry, new_entry;</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;    <span class="keywordtype">int</span> <span class="keywordtype">id</span> = vcpu-&gt;vcpu_id;</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;    <span class="keyword">struct </span><a class="code" href="structvcpu__svm.html">vcpu_svm</a> *svm = <a class="code" href="svm_8h.html#a83e420c88631faf9613ea3caa72c63b7">to_svm</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>);</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160; </div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    <span class="keywordflow">if</span> ((!<a class="code" href="avic_8c.html#ad4c0ba70ab315cedbb11f259b1d7ae08">x2avic_enabled</a> &amp;&amp; <span class="keywordtype">id</span> &gt; AVIC_MAX_PHYSICAL_ID) ||</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;        (<span class="keywordtype">id</span> &gt; X2AVIC_MAX_PHYSICAL_ID))</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160; </div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>-&gt;arch.apic-&gt;regs)</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160; </div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="x86_8c.html#a21212b8e1a82cdc8ac696137981d8d7a">kvm_apicv_activated</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>-&gt;kvm)) {</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;        <span class="keywordtype">int</span> ret;</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160; </div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;<span class="comment">         * Note, AVIC hardware walks the nested page table to check</span></div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;<span class="comment">         * permissions, but does not use the SPA address specified in</span></div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;<span class="comment">         * the leaf SPTE since it uses address in the AVIC_BACKING_PAGE</span></div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;<span class="comment">         * pointer field of the VMCB.</span></div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;<span class="comment">         */</span></div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;        ret = <a class="code" href="lapic_8c.html#a8c6616d2cbae35632aa5debb15b552ec">kvm_alloc_apic_access_page</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>-&gt;kvm);</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;        <span class="keywordflow">if</span> (ret)</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;            <span class="keywordflow">return</span> ret;</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    }</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160; </div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    svm-&gt;<a class="code" href="structvcpu__svm.html#a2c8b33d5ae9b731a886634cd6c00165f">avic_backing_page</a> = virt_to_page(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>-&gt;arch.apic-&gt;regs);</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160; </div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;    <span class="comment">/* Setting AVIC backing page address in the phy APIC ID table */</span></div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;    entry = <a class="code" href="avic_8c.html#a8cfb06497cbd5960a4a909c44e701f06">avic_get_physical_id_entry</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>, <span class="keywordtype">id</span>);</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;    <span class="keywordflow">if</span> (!entry)</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160; </div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;    new_entry = __sme_set((page_to_phys(svm-&gt;<a class="code" href="structvcpu__svm.html#a2c8b33d5ae9b731a886634cd6c00165f">avic_backing_page</a>) &amp;</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;                  AVIC_PHYSICAL_ID_ENTRY_BACKING_PAGE_MASK) |</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;                  AVIC_PHYSICAL_ID_ENTRY_VALID_MASK);</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;    WRITE_ONCE(*entry, new_entry);</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160; </div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;    svm-&gt;<a class="code" href="structvcpu__svm.html#abc377a3a5f1f42e18f8a9044321f3d5b">avic_physical_id_cache</a> = entry;</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160; </div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;}</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160; </div>
<div class="line"><a name="l00321"></a><span class="lineno"><a class="line" href="avic_8c.html#ac8c9ded2546dccf6e4b561e633d22e7e">  321</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="avic_8c.html#ac8c9ded2546dccf6e4b561e633d22e7e">avic_ring_doorbell</a>(<span class="keyword">struct</span> kvm_vcpu *<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>)</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;{</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;<span class="comment">     * Note, the vCPU could get migrated to a different pCPU at any point,</span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;<span class="comment">     * which could result in signalling the wrong/previous pCPU.  But if</span></div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;<span class="comment">     * that happens the vCPU is guaranteed to do a VMRUN (after being</span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;<span class="comment">     * migrated) and thus will process pending interrupts, i.e. a doorbell</span></div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;<span class="comment">     * is not needed (and the spurious one is harmless).</span></div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    <span class="keywordtype">int</span> cpu = READ_ONCE(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>-&gt;cpu);</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160; </div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;    <span class="keywordflow">if</span> (cpu != get_cpu()) {</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;        wrmsrl(MSR_AMD64_SVM_AVIC_DOORBELL, kvm_cpu_get_apicid(cpu));</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;        trace_kvm_avic_doorbell(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>-&gt;vcpu_id, kvm_cpu_get_apicid(cpu));</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    }</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    put_cpu();</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;}</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160; </div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160; </div>
<div class="line"><a name="l00340"></a><span class="lineno"><a class="line" href="avic_8c.html#a2b9e298755a0d51bb5b2dfc9dd254c64">  340</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="avic_8c.html#a2b9e298755a0d51bb5b2dfc9dd254c64">avic_kick_vcpu</a>(<span class="keyword">struct</span> kvm_vcpu *<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>, u32 icrl)</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;{</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;    <a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>-&gt;arch.apic-&gt;irr_pending = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    <a class="code" href="svm_8c.html#a1faf261e116f9d9481e1bd6796e32280">svm_complete_interrupt_delivery</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>,</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;                    icrl &amp; APIC_MODE_MASK,</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;                    icrl &amp; APIC_INT_LEVELTRIG,</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;                    icrl &amp; APIC_VECTOR_MASK);</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;}</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160; </div>
<div class="line"><a name="l00349"></a><span class="lineno"><a class="line" href="avic_8c.html#a4b900d047f49b6cd00266aba3f4912bf">  349</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="avic_8c.html#a4b900d047f49b6cd00266aba3f4912bf">avic_kick_vcpu_by_physical_id</a>(<span class="keyword">struct</span> kvm *kvm, u32 physical_id,</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;                      u32 icrl)</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;{</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;<span class="comment">     * KVM inhibits AVIC if any vCPU ID diverges from the vCPUs APIC ID,</span></div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;<span class="comment">     * i.e. APIC ID == vCPU ID.</span></div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;    <span class="keyword">struct </span>kvm_vcpu *target_vcpu = kvm_get_vcpu_by_id(kvm, physical_id);</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160; </div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;    <span class="comment">/* Once again, nothing to do if the target vCPU doesn&#39;t exist. */</span></div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;    <span class="keywordflow">if</span> (unlikely(!target_vcpu))</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160; </div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;    <a class="code" href="avic_8c.html#a2b9e298755a0d51bb5b2dfc9dd254c64">avic_kick_vcpu</a>(target_vcpu, icrl);</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;}</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160; </div>
<div class="line"><a name="l00365"></a><span class="lineno"><a class="line" href="avic_8c.html#a1404df5f813565dd104640a6e5bfea67">  365</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="avic_8c.html#a1404df5f813565dd104640a6e5bfea67">avic_kick_vcpu_by_logical_id</a>(<span class="keyword">struct</span> kvm *kvm, u32 *avic_logical_id_table,</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;                     u32 logid_index, u32 icrl)</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;{</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    u32 physical_id;</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160; </div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;    <span class="keywordflow">if</span> (avic_logical_id_table) {</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;        u32 logid_entry = avic_logical_id_table[logid_index];</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160; </div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;        <span class="comment">/* Nothing to do if the logical destination is invalid. */</span></div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;        <span class="keywordflow">if</span> (unlikely(!(logid_entry &amp; AVIC_LOGICAL_ID_ENTRY_VALID_MASK)))</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160; </div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;        physical_id = logid_entry &amp;</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;                  AVIC_LOGICAL_ID_ENTRY_GUEST_PHYSICAL_ID_MASK;</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;<span class="comment">         * For x2APIC, the logical APIC ID is a read-only value that is</span></div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;<span class="comment">         * derived from the x2APIC ID, thus the x2APIC ID can be found</span></div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;<span class="comment">         * by reversing the calculation (stored in logid_index).  Note,</span></div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;<span class="comment">         * bits 31:20 of the x2APIC ID aren&#39;t propagated to the logical</span></div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;<span class="comment">         * ID, but KVM limits the x2APIC ID limited to KVM_MAX_VCPU_IDS.</span></div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;<span class="comment">         */</span></div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;        physical_id = logid_index;</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;    }</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160; </div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;    <a class="code" href="avic_8c.html#a4b900d047f49b6cd00266aba3f4912bf">avic_kick_vcpu_by_physical_id</a>(kvm, physical_id, icrl);</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;}</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160; </div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;<span class="comment"> * A fast-path version of avic_kick_target_vcpus(), which attempts to match</span></div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;<span class="comment"> * destination APIC ID to vCPU without looping through all vCPUs.</span></div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00397"></a><span class="lineno"><a class="line" href="avic_8c.html#a7cf9fdcdf4f5f6559c099faaab0c2d29">  397</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="avic_8c.html#a7cf9fdcdf4f5f6559c099faaab0c2d29">avic_kick_target_vcpus_fast</a>(<span class="keyword">struct</span> kvm *kvm, <span class="keyword">struct</span> <a class="code" href="structkvm__lapic.html">kvm_lapic</a> *source,</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;                       u32 icrl, u32 icrh, u32 index)</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;{</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;    <span class="keywordtype">int</span> dest_mode = icrl &amp; <a class="code" href="lapic_8h.html#a5e58cf75a31cd26e03db7f201861a8e4">APIC_DEST_MASK</a>;</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;    <span class="keywordtype">int</span> shorthand = icrl &amp; <a class="code" href="lapic_8h.html#ad3b78bd2ddd9b9b15390755b6df98d3d">APIC_SHORT_MASK</a>;</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;    <span class="keyword">struct </span><a class="code" href="structkvm__svm.html">kvm_svm</a> *<a class="code" href="structkvm__svm.html">kvm_svm</a> = <a class="code" href="svm_8h.html#ac27f6fe2ff4beeb5ad1b11681d0386fd">to_kvm_svm</a>(<a class="code" href="structkvm__svm.html#ade6c6ec6e820a10719c5d61e161aa8b8">kvm</a>);</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;    u32 dest;</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160; </div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;    <span class="keywordflow">if</span> (shorthand != <a class="code" href="lapic_8h.html#acc73bace457403e7d23ff22afac7df0f">APIC_DEST_NOSHORT</a>)</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160; </div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="lapic_8h.html#a07d3e1e4090a62753325dfa11d232cea">apic_x2apic_mode</a>(source))</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;        dest = icrh;</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;        dest = GET_XAPIC_DEST_FIELD(icrh);</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160; </div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;    <span class="keywordflow">if</span> (dest_mode == APIC_DEST_PHYSICAL) {</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;        <span class="comment">/* broadcast destination, use slow path */</span></div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="lapic_8h.html#a07d3e1e4090a62753325dfa11d232cea">apic_x2apic_mode</a>(source) &amp;&amp; dest == <a class="code" href="lapic_8h.html#a481da2cdd19d996fb0378476375133c6">X2APIC_BROADCAST</a>)</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;            <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="lapic_8h.html#a07d3e1e4090a62753325dfa11d232cea">apic_x2apic_mode</a>(source) &amp;&amp; dest == <a class="code" href="lapic_8h.html#a8e368c4d317e2f3289d8287fc28c4d19">APIC_BROADCAST</a>)</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;            <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160; </div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;        <span class="keywordflow">if</span> (WARN_ON_ONCE(dest != index))</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;            <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160; </div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;        <a class="code" href="avic_8c.html#a4b900d047f49b6cd00266aba3f4912bf">avic_kick_vcpu_by_physical_id</a>(<a class="code" href="structkvm__svm.html#ade6c6ec6e820a10719c5d61e161aa8b8">kvm</a>, dest, icrl);</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;        u32 *avic_logical_id_table;</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;        <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> bitmap, i;</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;        u32 cluster;</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160; </div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="lapic_8h.html#a07d3e1e4090a62753325dfa11d232cea">apic_x2apic_mode</a>(source)) {</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;            <span class="comment">/* 16 bit dest mask, 16 bit cluster id */</span></div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;            bitmap = dest &amp; 0xFFFF;</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;            cluster = (dest &gt;&gt; 16) &lt;&lt; 4;</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="lapic_8h.html#a8cd1df8b4c079c23a522d09c964da0ee">kvm_lapic_get_reg</a>(source, APIC_DFR) == APIC_DFR_FLAT) {</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;            <span class="comment">/* 8 bit dest mask*/</span></div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;            bitmap = dest;</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;            cluster = 0;</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;            <span class="comment">/* 4 bit desk mask, 4 bit cluster id */</span></div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;            bitmap = dest &amp; 0xF;</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;            cluster = (dest &gt;&gt; 4) &lt;&lt; 2;</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;        }</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160; </div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;        <span class="comment">/* Nothing to do if there are no destinations in the cluster. */</span></div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;        <span class="keywordflow">if</span> (unlikely(!bitmap))</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;            <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160; </div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="lapic_8h.html#a07d3e1e4090a62753325dfa11d232cea">apic_x2apic_mode</a>(source))</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;            avic_logical_id_table = NULL;</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;            avic_logical_id_table = page_address(<a class="code" href="structkvm__svm.html">kvm_svm</a>-&gt;<a class="code" href="structkvm__svm.html#a837dca12e3d1d7b768feb04c6a3c2e96">avic_logical_id_table_page</a>);</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160; </div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;<span class="comment">         * AVIC is inhibited if vCPUs aren&#39;t mapped 1:1 with logical</span></div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;<span class="comment">         * IDs, thus each bit in the destination is guaranteed to map</span></div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;<span class="comment">         * to at most one vCPU.</span></div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;<span class="comment">         */</span></div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;        for_each_set_bit(i, &amp;bitmap, 16)</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;            <a class="code" href="avic_8c.html#a1404df5f813565dd104640a6e5bfea67">avic_kick_vcpu_by_logical_id</a>(<a class="code" href="structkvm__svm.html#ade6c6ec6e820a10719c5d61e161aa8b8">kvm</a>, avic_logical_id_table,</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;                             cluster + i, icrl);</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;    }</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160; </div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;}</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160; </div>
<div class="line"><a name="l00465"></a><span class="lineno"><a class="line" href="avic_8c.html#ad9345a779111a59de8fa4110106c3adf">  465</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="avic_8c.html#ad9345a779111a59de8fa4110106c3adf">avic_kick_target_vcpus</a>(<span class="keyword">struct</span> <a class="code" href="structkvm__svm.html#ade6c6ec6e820a10719c5d61e161aa8b8">kvm</a> *<a class="code" href="structkvm__svm.html#ade6c6ec6e820a10719c5d61e161aa8b8">kvm</a>, <span class="keyword">struct</span> <a class="code" href="structkvm__lapic.html">kvm_lapic</a> *source,</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;                   u32 icrl, u32 icrh, u32 index)</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;{</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    u32 dest = <a class="code" href="lapic_8h.html#a07d3e1e4090a62753325dfa11d232cea">apic_x2apic_mode</a>(source) ? icrh : GET_XAPIC_DEST_FIELD(icrh);</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> i;</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;    <span class="keyword">struct </span>kvm_vcpu *vcpu;</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160; </div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="avic_8c.html#a7cf9fdcdf4f5f6559c099faaab0c2d29">avic_kick_target_vcpus_fast</a>(kvm, source, icrl, icrh, index))</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160; </div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;    trace_kvm_avic_kick_vcpu_slowpath(icrh, icrl, index);</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160; </div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;<span class="comment">     * Wake any target vCPUs that are blocking, i.e. waiting for a wake</span></div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;<span class="comment">     * event.  There&#39;s no need to signal doorbells, as hardware has handled</span></div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;<span class="comment">     * vCPUs that were in guest at the time of the IPI, and vCPUs that have</span></div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;<span class="comment">     * since entered the guest will have processed pending IRQs at VMRUN.</span></div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;    kvm_for_each_vcpu(i, vcpu, kvm) {</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="lapic_8c.html#adb63e5a650d4571316b450d153a3105d">kvm_apic_match_dest</a>(vcpu, source, icrl &amp; <a class="code" href="lapic_8h.html#ad3b78bd2ddd9b9b15390755b6df98d3d">APIC_SHORT_MASK</a>,</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;                    dest, icrl &amp; <a class="code" href="lapic_8h.html#a5e58cf75a31cd26e03db7f201861a8e4">APIC_DEST_MASK</a>))</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;            <a class="code" href="avic_8c.html#a2b9e298755a0d51bb5b2dfc9dd254c64">avic_kick_vcpu</a>(vcpu, icrl);</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;    }</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;}</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160; </div>
<div class="line"><a name="l00490"></a><span class="lineno"><a class="line" href="avic_8c.html#a4a11c0014568405b90307ef68285e4ff">  490</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="avic_8c.html#a4a11c0014568405b90307ef68285e4ff">avic_incomplete_ipi_interception</a>(<span class="keyword">struct</span> kvm_vcpu *vcpu)</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;{</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;    <span class="keyword">struct </span><a class="code" href="structvcpu__svm.html">vcpu_svm</a> *svm = <a class="code" href="svm_8h.html#a83e420c88631faf9613ea3caa72c63b7">to_svm</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>);</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;    u32 icrh = svm-&gt;<a class="code" href="structvcpu__svm.html#af095ed7bcc31c036e28e533582723a60">vmcb</a>-&gt;control.exit_info_1 &gt;&gt; 32;</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;    u32 icrl = svm-&gt;<a class="code" href="structvcpu__svm.html#af095ed7bcc31c036e28e533582723a60">vmcb</a>-&gt;control.exit_info_1;</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;    u32 <span class="keywordtype">id</span> = svm-&gt;<a class="code" href="structvcpu__svm.html#af095ed7bcc31c036e28e533582723a60">vmcb</a>-&gt;control.exit_info_2 &gt;&gt; 32;</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;    u32 index = svm-&gt;<a class="code" href="structvcpu__svm.html#af095ed7bcc31c036e28e533582723a60">vmcb</a>-&gt;control.exit_info_2 &amp; 0x1FF;</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;    <span class="keyword">struct </span><a class="code" href="structkvm__lapic.html">kvm_lapic</a> *apic = <a class="code" href="structkvm__lapic.html#a54741597d07b2792d2da72ea301ad648">vcpu</a>-&gt;arch.apic;</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160; </div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    trace_kvm_avic_incomplete_ipi(<a class="code" href="structkvm__lapic.html#a54741597d07b2792d2da72ea301ad648">vcpu</a>-&gt;vcpu_id, icrh, icrl, <span class="keywordtype">id</span>, index);</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160; </div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;    <span class="keywordflow">switch</span> (<span class="keywordtype">id</span>) {</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;    <span class="keywordflow">case</span> AVIC_IPI_FAILURE_INVALID_TARGET:</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;    <span class="keywordflow">case</span> AVIC_IPI_FAILURE_INVALID_INT_TYPE:</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;<span class="comment">         * Emulate IPIs that are not handled by AVIC hardware, which</span></div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;<span class="comment">         * only virtualizes Fixed, Edge-Triggered INTRs, and falls over</span></div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;<span class="comment">         * if _any_ targets are invalid, e.g. if the logical mode mask</span></div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;<span class="comment">         * is a superset of running vCPUs.</span></div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;<span class="comment">         *</span></div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;<span class="comment">         * The exit is a trap, e.g. ICR holds the correct value and RIP</span></div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;<span class="comment">         * has been advanced, KVM is responsible only for emulating the</span></div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;<span class="comment">         * IPI.  Sadly, hardware may sometimes leave the BUSY flag set,</span></div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;<span class="comment">         * in which case KVM needs to emulate the ICR write as well in</span></div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;<span class="comment">         * order to clear the BUSY flag.</span></div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;<span class="comment">         */</span></div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;        <span class="keywordflow">if</span> (icrl &amp; APIC_ICR_BUSY)</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;            <a class="code" href="lapic_8c.html#a1b33bb5758d3dd75c7b87e537a5e729e">kvm_apic_write_nodecode</a>(<a class="code" href="structkvm__lapic.html#a54741597d07b2792d2da72ea301ad648">vcpu</a>, APIC_ICR);</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;            <a class="code" href="lapic_8c.html#a4b7f12cb3ba68245df79bc30d938b728">kvm_apic_send_ipi</a>(apic, icrl, icrh);</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;    <span class="keywordflow">case</span> AVIC_IPI_FAILURE_TARGET_NOT_RUNNING:</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;<span class="comment">         * At this point, we expect that the AVIC HW has already</span></div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;<span class="comment">         * set the appropriate IRR bits on the valid target</span></div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;<span class="comment">         * vcpus. So, we just need to kick the appropriate vcpu.</span></div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;<span class="comment">         */</span></div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;        <a class="code" href="avic_8c.html#ad9345a779111a59de8fa4110106c3adf">avic_kick_target_vcpus</a>(<a class="code" href="structkvm__lapic.html#a54741597d07b2792d2da72ea301ad648">vcpu</a>-&gt;kvm, apic, icrl, icrh, index);</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;    <span class="keywordflow">case</span> AVIC_IPI_FAILURE_INVALID_BACKING_PAGE:</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;        WARN_ONCE(1, <span class="stringliteral">&quot;Invalid backing page\n&quot;</span>);</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;    <span class="keywordflow">case</span> AVIC_IPI_FAILURE_INVALID_IPI_VECTOR:</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;        <span class="comment">/* Invalid IPI with vector &lt; 16 */</span></div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;    <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;        vcpu_unimpl(<a class="code" href="structkvm__lapic.html#a54741597d07b2792d2da72ea301ad648">vcpu</a>, <span class="stringliteral">&quot;Unknown avic incomplete IPI interception\n&quot;</span>);</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;    }</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160; </div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;    <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;}</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160; </div>
<div class="line"><a name="l00542"></a><span class="lineno"><a class="line" href="avic_8c.html#aed65a2dabdad6a421b487e1e7b106277">  542</a></span>&#160;<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="avic_8c.html#aed65a2dabdad6a421b487e1e7b106277">avic_vcpu_get_apicv_inhibit_reasons</a>(<span class="keyword">struct</span> kvm_vcpu *<a class="code" href="structkvm__lapic.html#a54741597d07b2792d2da72ea301ad648">vcpu</a>)</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;{</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="kvm__cache__regs_8h.html#afbcfc413ceedb460734eb5fd7c5c4fbc">is_guest_mode</a>(<a class="code" href="structkvm__lapic.html#a54741597d07b2792d2da72ea301ad648">vcpu</a>))</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;        <span class="keywordflow">return</span> APICV_INHIBIT_REASON_NESTED;</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;}</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160; </div>
<div class="line"><a name="l00549"></a><span class="lineno"><a class="line" href="avic_8c.html#a5eaaa2d4a926c006359343ff29a9cdf7">  549</a></span>&#160;<span class="keyword">static</span> u32 *<a class="code" href="avic_8c.html#a5eaaa2d4a926c006359343ff29a9cdf7">avic_get_logical_id_entry</a>(<span class="keyword">struct</span> kvm_vcpu *<a class="code" href="structkvm__lapic.html#a54741597d07b2792d2da72ea301ad648">vcpu</a>, u32 ldr, <span class="keywordtype">bool</span> flat)</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;{</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;    <span class="keyword">struct </span><a class="code" href="structkvm__svm.html">kvm_svm</a> *<a class="code" href="structkvm__svm.html">kvm_svm</a> = <a class="code" href="svm_8h.html#ac27f6fe2ff4beeb5ad1b11681d0386fd">to_kvm_svm</a>(vcpu-&gt;kvm);</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;    u32 *logical_apic_id_table;</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;    u32 cluster, index;</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160; </div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;    ldr = GET_APIC_LOGICAL_ID(ldr);</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160; </div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;    <span class="keywordflow">if</span> (flat) {</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;        cluster = 0;</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;        cluster = (ldr &gt;&gt; 4);</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;        <span class="keywordflow">if</span> (cluster &gt;= 0xf)</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;            <span class="keywordflow">return</span> NULL;</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;        ldr &amp;= 0xf;</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;    }</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;    <span class="keywordflow">if</span> (!ldr || !is_power_of_2(ldr))</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;        <span class="keywordflow">return</span> NULL;</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160; </div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;    index = __ffs(ldr);</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;    <span class="keywordflow">if</span> (WARN_ON_ONCE(index &gt; 7))</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;        <span class="keywordflow">return</span> NULL;</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;    index += (cluster &lt;&lt; 2);</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160; </div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;    logical_apic_id_table = (u32 *) page_address(<a class="code" href="structkvm__svm.html">kvm_svm</a>-&gt;<a class="code" href="structkvm__svm.html#a837dca12e3d1d7b768feb04c6a3c2e96">avic_logical_id_table_page</a>);</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160; </div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;    <span class="keywordflow">return</span> &amp;logical_apic_id_table[index];</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;}</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160; </div>
<div class="line"><a name="l00578"></a><span class="lineno"><a class="line" href="avic_8c.html#a2650b353757b538de17a1c843f7308d2">  578</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="avic_8c.html#a2650b353757b538de17a1c843f7308d2">avic_ldr_write</a>(<span class="keyword">struct</span> kvm_vcpu *vcpu, u8 g_physical_id, u32 ldr)</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;{</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;    <span class="keywordtype">bool</span> flat;</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;    u32 *entry, new_entry;</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160; </div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;    flat = <a class="code" href="lapic_8h.html#a8cd1df8b4c079c23a522d09c964da0ee">kvm_lapic_get_reg</a>(vcpu-&gt;arch.apic, APIC_DFR) == APIC_DFR_FLAT;</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;    entry = <a class="code" href="avic_8c.html#a5eaaa2d4a926c006359343ff29a9cdf7">avic_get_logical_id_entry</a>(vcpu, ldr, flat);</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;    <span class="keywordflow">if</span> (!entry)</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160; </div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;    new_entry = READ_ONCE(*entry);</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;    new_entry &amp;= ~AVIC_LOGICAL_ID_ENTRY_GUEST_PHYSICAL_ID_MASK;</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;    new_entry |= (g_physical_id &amp; AVIC_LOGICAL_ID_ENTRY_GUEST_PHYSICAL_ID_MASK);</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;    new_entry |= AVIC_LOGICAL_ID_ENTRY_VALID_MASK;</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;    WRITE_ONCE(*entry, new_entry);</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;}</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160; </div>
<div class="line"><a name="l00595"></a><span class="lineno"><a class="line" href="avic_8c.html#a2ed13621ec3f14afbf47f129e43b496d">  595</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="avic_8c.html#a2ed13621ec3f14afbf47f129e43b496d">avic_invalidate_logical_id_entry</a>(<span class="keyword">struct</span> kvm_vcpu *vcpu)</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;{</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;    <span class="keyword">struct </span><a class="code" href="structvcpu__svm.html">vcpu_svm</a> *svm = <a class="code" href="svm_8h.html#a83e420c88631faf9613ea3caa72c63b7">to_svm</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>);</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;    <span class="keywordtype">bool</span> flat = svm-&gt;<a class="code" href="structvcpu__svm.html#ae08ffe38b03c1c44686c57c274553f59">dfr_reg</a> == APIC_DFR_FLAT;</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;    u32 *entry;</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160; </div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;    <span class="comment">/* Note: x2AVIC does not use logical APIC ID table */</span></div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="lapic_8h.html#a07d3e1e4090a62753325dfa11d232cea">apic_x2apic_mode</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>-&gt;arch.apic))</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160; </div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;    entry = <a class="code" href="avic_8c.html#a5eaaa2d4a926c006359343ff29a9cdf7">avic_get_logical_id_entry</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>, svm-&gt;<a class="code" href="structvcpu__svm.html#a250d72e13c39c0c6d85a5e6c188554ce">ldr_reg</a>, flat);</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;    <span class="keywordflow">if</span> (entry)</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;        clear_bit(AVIC_LOGICAL_ID_ENTRY_VALID_BIT, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)entry);</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;}</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160; </div>
<div class="line"><a name="l00610"></a><span class="lineno"><a class="line" href="avic_8c.html#a6a9ffca6bae1adce86d4495b5caaae2e">  610</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="avic_8c.html#a6a9ffca6bae1adce86d4495b5caaae2e">avic_handle_ldr_update</a>(<span class="keyword">struct</span> kvm_vcpu *<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>)</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;{</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;    <span class="keyword">struct </span><a class="code" href="structvcpu__svm.html">vcpu_svm</a> *svm = <a class="code" href="svm_8h.html#a83e420c88631faf9613ea3caa72c63b7">to_svm</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>);</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;    u32 ldr = <a class="code" href="lapic_8h.html#a8cd1df8b4c079c23a522d09c964da0ee">kvm_lapic_get_reg</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>-&gt;arch.apic, APIC_LDR);</div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;    u32 <span class="keywordtype">id</span> = <a class="code" href="lapic_8h.html#a4f07303d20a06eeb408d4985c5e15096">kvm_xapic_id</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>-&gt;arch.apic);</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160; </div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;    <span class="comment">/* AVIC does not support LDR update for x2APIC */</span></div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="lapic_8h.html#a07d3e1e4090a62753325dfa11d232cea">apic_x2apic_mode</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>-&gt;arch.apic))</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160; </div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;    <span class="keywordflow">if</span> (ldr == svm-&gt;<a class="code" href="structvcpu__svm.html#a250d72e13c39c0c6d85a5e6c188554ce">ldr_reg</a>)</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160; </div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;    <a class="code" href="avic_8c.html#a2ed13621ec3f14afbf47f129e43b496d">avic_invalidate_logical_id_entry</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>);</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160; </div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;    svm-&gt;<a class="code" href="structvcpu__svm.html#a250d72e13c39c0c6d85a5e6c188554ce">ldr_reg</a> = ldr;</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;    <a class="code" href="avic_8c.html#a2650b353757b538de17a1c843f7308d2">avic_ldr_write</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>, <span class="keywordtype">id</span>, ldr);</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;}</div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160; </div>
<div class="line"><a name="l00629"></a><span class="lineno"><a class="line" href="avic_8c.html#aaff9720871b696bc298d89cbb27a6dc2">  629</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="avic_8c.html#aaff9720871b696bc298d89cbb27a6dc2">avic_handle_dfr_update</a>(<span class="keyword">struct</span> kvm_vcpu *<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>)</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;{</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;    <span class="keyword">struct </span><a class="code" href="structvcpu__svm.html">vcpu_svm</a> *svm = <a class="code" href="svm_8h.html#a83e420c88631faf9613ea3caa72c63b7">to_svm</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>);</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;    u32 dfr = <a class="code" href="lapic_8h.html#a8cd1df8b4c079c23a522d09c964da0ee">kvm_lapic_get_reg</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>-&gt;arch.apic, APIC_DFR);</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160; </div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;    <span class="keywordflow">if</span> (svm-&gt;<a class="code" href="structvcpu__svm.html#ae08ffe38b03c1c44686c57c274553f59">dfr_reg</a> == dfr)</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160; </div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;    <a class="code" href="avic_8c.html#a2ed13621ec3f14afbf47f129e43b496d">avic_invalidate_logical_id_entry</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>);</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;    svm-&gt;<a class="code" href="structvcpu__svm.html#ae08ffe38b03c1c44686c57c274553f59">dfr_reg</a> = dfr;</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;}</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160; </div>
<div class="line"><a name="l00641"></a><span class="lineno"><a class="line" href="avic_8c.html#abf44c96047cb51680ff358ad52747b93">  641</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="avic_8c.html#abf44c96047cb51680ff358ad52747b93">avic_unaccel_trap_write</a>(<span class="keyword">struct</span> kvm_vcpu *<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>)</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;{</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;    u32 offset = <a class="code" href="svm_8h.html#a83e420c88631faf9613ea3caa72c63b7">to_svm</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>)-&gt;<a class="code" href="structvcpu__svm.html#af095ed7bcc31c036e28e533582723a60">vmcb</a>-&gt;control.exit_info_1 &amp;</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;                AVIC_UNACCEL_ACCESS_OFFSET_MASK;</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160; </div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;    <span class="keywordflow">switch</span> (offset) {</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;    <span class="keywordflow">case</span> APIC_LDR:</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;        <a class="code" href="avic_8c.html#a6a9ffca6bae1adce86d4495b5caaae2e">avic_handle_ldr_update</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>);</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;    <span class="keywordflow">case</span> APIC_DFR:</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;        <a class="code" href="avic_8c.html#aaff9720871b696bc298d89cbb27a6dc2">avic_handle_dfr_update</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>);</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;    <span class="keywordflow">case</span> APIC_RRR:</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;        <span class="comment">/* Ignore writes to Read Remote Data, it&#39;s read-only. */</span></div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;        <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;    <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;    }</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160; </div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;    <a class="code" href="lapic_8c.html#a1b33bb5758d3dd75c7b87e537a5e729e">kvm_apic_write_nodecode</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>, offset);</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;    <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;}</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160; </div>
<div class="line"><a name="l00664"></a><span class="lineno"><a class="line" href="avic_8c.html#a9c7db7e1cb25acd53eb51e777934c9e8">  664</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="avic_8c.html#a9c7db7e1cb25acd53eb51e777934c9e8">is_avic_unaccelerated_access_trap</a>(u32 offset)</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;{</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;    <span class="keywordtype">bool</span> ret = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160; </div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;    <span class="keywordflow">switch</span> (offset) {</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;    <span class="keywordflow">case</span> APIC_ID:</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;    <span class="keywordflow">case</span> APIC_EOI:</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;    <span class="keywordflow">case</span> APIC_RRR:</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;    <span class="keywordflow">case</span> APIC_LDR:</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;    <span class="keywordflow">case</span> APIC_DFR:</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;    <span class="keywordflow">case</span> APIC_SPIV:</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;    <span class="keywordflow">case</span> APIC_ESR:</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;    <span class="keywordflow">case</span> APIC_ICR:</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;    <span class="keywordflow">case</span> APIC_LVTT:</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;    <span class="keywordflow">case</span> APIC_LVTTHMR:</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;    <span class="keywordflow">case</span> APIC_LVTPC:</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;    <span class="keywordflow">case</span> APIC_LVT0:</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;    <span class="keywordflow">case</span> APIC_LVT1:</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;    <span class="keywordflow">case</span> APIC_LVTERR:</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;    <span class="keywordflow">case</span> APIC_TMICT:</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;    <span class="keywordflow">case</span> APIC_TDCR:</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;        ret = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;    <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;    }</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;    <span class="keywordflow">return</span> ret;</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;}</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160; </div>
<div class="line"><a name="l00693"></a><span class="lineno"><a class="line" href="avic_8c.html#a299de3990a5ce5ce873df7afe2b3338f">  693</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="avic_8c.html#a299de3990a5ce5ce873df7afe2b3338f">avic_unaccelerated_access_interception</a>(<span class="keyword">struct</span> kvm_vcpu *<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>)</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;{</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;    <span class="keyword">struct </span><a class="code" href="structvcpu__svm.html">vcpu_svm</a> *svm = <a class="code" href="svm_8h.html#a83e420c88631faf9613ea3caa72c63b7">to_svm</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>);</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;    <span class="keywordtype">int</span> ret = 0;</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;    u32 offset = svm-&gt;<a class="code" href="structvcpu__svm.html#af095ed7bcc31c036e28e533582723a60">vmcb</a>-&gt;control.exit_info_1 &amp;</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;             AVIC_UNACCEL_ACCESS_OFFSET_MASK;</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;    u32 vector = svm-&gt;<a class="code" href="structvcpu__svm.html#af095ed7bcc31c036e28e533582723a60">vmcb</a>-&gt;control.exit_info_2 &amp;</div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;             AVIC_UNACCEL_ACCESS_VECTOR_MASK;</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;    <span class="keywordtype">bool</span> write = (svm-&gt;<a class="code" href="structvcpu__svm.html#af095ed7bcc31c036e28e533582723a60">vmcb</a>-&gt;control.exit_info_1 &gt;&gt; 32) &amp;</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;             AVIC_UNACCEL_ACCESS_WRITE_MASK;</div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;    <span class="keywordtype">bool</span> trap = <a class="code" href="avic_8c.html#a9c7db7e1cb25acd53eb51e777934c9e8">is_avic_unaccelerated_access_trap</a>(offset);</div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160; </div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;    trace_kvm_avic_unaccelerated_access(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>-&gt;vcpu_id, offset,</div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;                        trap, write, vector);</div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;    <span class="keywordflow">if</span> (trap) {</div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;        <span class="comment">/* Handling Trap */</span></div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;        WARN_ONCE(!write, <span class="stringliteral">&quot;svm: Handling trap read.\n&quot;</span>);</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;        ret = <a class="code" href="avic_8c.html#abf44c96047cb51680ff358ad52747b93">avic_unaccel_trap_write</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>);</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;        <span class="comment">/* Handling Fault */</span></div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;        ret = <a class="code" href="x86_8c.html#a117738c7e069e71d58ab48a581bfc646">kvm_emulate_instruction</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>, 0);</div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;    }</div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160; </div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;    <span class="keywordflow">return</span> ret;</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;}</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160; </div>
<div class="line"><a name="l00719"></a><span class="lineno"><a class="line" href="avic_8c.html#a8e0a22138080054f4ac064064402f74a">  719</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="avic_8c.html#a8e0a22138080054f4ac064064402f74a">avic_init_vcpu</a>(<span class="keyword">struct</span> <a class="code" href="structvcpu__svm.html">vcpu_svm</a> *svm)</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;{</div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;    <span class="keywordtype">int</span> ret;</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;    <span class="keyword">struct </span>kvm_vcpu *vcpu = &amp;svm-&gt;<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>;</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160; </div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="x86_8c.html#a04af9ab3eee510b54cba17a6fa94ee04">enable_apicv</a> || !<a class="code" href="irq_8h.html#a96951e3a1bfa402d8bee67713e267b39">irqchip_in_kernel</a>(vcpu-&gt;kvm))</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160; </div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;    ret = <a class="code" href="avic_8c.html#aefc63eafb35c1efd94f6d53e7d0b20d5">avic_init_backing_page</a>(vcpu);</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;    <span class="keywordflow">if</span> (ret)</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;        <span class="keywordflow">return</span> ret;</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160; </div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;    INIT_LIST_HEAD(&amp;svm-&gt;<a class="code" href="structvcpu__svm.html#af217181f505db1b71c48743233032539">ir_list</a>);</div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;    spin_lock_init(&amp;svm-&gt;<a class="code" href="structvcpu__svm.html#af38f3c63a81a10aae69b308aa175d618">ir_list_lock</a>);</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;    svm-&gt;<a class="code" href="structvcpu__svm.html#ae08ffe38b03c1c44686c57c274553f59">dfr_reg</a> = APIC_DFR_FLAT;</div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160; </div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;    <span class="keywordflow">return</span> ret;</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;}</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160; </div>
<div class="line"><a name="l00738"></a><span class="lineno"><a class="line" href="avic_8c.html#ae9f162404fdb37bba372d0c9cdc043ee">  738</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="avic_8c.html#ae9f162404fdb37bba372d0c9cdc043ee">avic_apicv_post_state_restore</a>(<span class="keyword">struct</span> kvm_vcpu *vcpu)</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;{</div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;    <a class="code" href="avic_8c.html#aaff9720871b696bc298d89cbb27a6dc2">avic_handle_dfr_update</a>(vcpu);</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;    <a class="code" href="avic_8c.html#a6a9ffca6bae1adce86d4495b5caaae2e">avic_handle_ldr_update</a>(vcpu);</div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;}</div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160; </div>
<div class="line"><a name="l00744"></a><span class="lineno"><a class="line" href="avic_8c.html#a520da70652fa3f7af0d58c1ecb7d0db7">  744</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="avic_8c.html#a520da70652fa3f7af0d58c1ecb7d0db7">avic_set_pi_irte_mode</a>(<span class="keyword">struct</span> kvm_vcpu *vcpu, <span class="keywordtype">bool</span> activate)</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;{</div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;    <span class="keywordtype">int</span> ret = 0;</div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="xen_8c.html#a773b39d480759f67926cb18ae2219281">flags</a>;</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;    <span class="keyword">struct </span><a class="code" href="structamd__svm__iommu__ir.html">amd_svm_iommu_ir</a> *ir;</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;    <span class="keyword">struct </span><a class="code" href="structvcpu__svm.html">vcpu_svm</a> *svm = <a class="code" href="svm_8h.html#a83e420c88631faf9613ea3caa72c63b7">to_svm</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>);</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160; </div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="x86_8c.html#ae63567e9b665b34f8c84fc4dc594f3c8">kvm_arch_has_assigned_device</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>-&gt;kvm))</div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160; </div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;<span class="comment">     * Here, we go through the per-vcpu ir_list to update all existing</span></div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;<span class="comment">     * interrupt remapping table entry targeting this vcpu.</span></div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;    spin_lock_irqsave(&amp;svm-&gt;<a class="code" href="structvcpu__svm.html#af38f3c63a81a10aae69b308aa175d618">ir_list_lock</a>, <a class="code" href="xen_8c.html#a773b39d480759f67926cb18ae2219281">flags</a>);</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160; </div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;    <span class="keywordflow">if</span> (list_empty(&amp;svm-&gt;<a class="code" href="structvcpu__svm.html#af217181f505db1b71c48743233032539">ir_list</a>))</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;        <span class="keywordflow">goto</span> out;</div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160; </div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;    list_for_each_entry(ir, &amp;svm-&gt;<a class="code" href="structvcpu__svm.html#af217181f505db1b71c48743233032539">ir_list</a>, node) {</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;        <span class="keywordflow">if</span> (activate)</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;            ret = amd_iommu_activate_guest_mode(ir-&gt;<a class="code" href="structamd__svm__iommu__ir.html#ad1d0011f27de4fbde266e0ce65476e84">data</a>);</div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;            ret = amd_iommu_deactivate_guest_mode(ir-&gt;<a class="code" href="structamd__svm__iommu__ir.html#ad1d0011f27de4fbde266e0ce65476e84">data</a>);</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;        <span class="keywordflow">if</span> (ret)</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;    }</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;out:</div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;    spin_unlock_irqrestore(&amp;svm-&gt;<a class="code" href="structvcpu__svm.html#af38f3c63a81a10aae69b308aa175d618">ir_list_lock</a>, <a class="code" href="xen_8c.html#a773b39d480759f67926cb18ae2219281">flags</a>);</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;    <span class="keywordflow">return</span> ret;</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;}</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160; </div>
<div class="line"><a name="l00776"></a><span class="lineno"><a class="line" href="avic_8c.html#a0573329bfb8b7a1a2ba0a4e2ce438dfa">  776</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="avic_8c.html#a0573329bfb8b7a1a2ba0a4e2ce438dfa">svm_ir_list_del</a>(<span class="keyword">struct</span> <a class="code" href="structvcpu__svm.html">vcpu_svm</a> *svm, <span class="keyword">struct</span> amd_iommu_pi_data *pi)</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;{</div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="xen_8c.html#a773b39d480759f67926cb18ae2219281">flags</a>;</div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;    <span class="keyword">struct </span><a class="code" href="structamd__svm__iommu__ir.html">amd_svm_iommu_ir</a> *cur;</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160; </div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;    spin_lock_irqsave(&amp;svm-&gt;<a class="code" href="structvcpu__svm.html#af38f3c63a81a10aae69b308aa175d618">ir_list_lock</a>, <a class="code" href="xen_8c.html#a773b39d480759f67926cb18ae2219281">flags</a>);</div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;    list_for_each_entry(cur, &amp;svm-&gt;<a class="code" href="structvcpu__svm.html#af217181f505db1b71c48743233032539">ir_list</a>, <a class="code" href="structamd__svm__iommu__ir.html#a54d6bf7341caaad5d37469694a4bd434">node</a>) {</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;        <span class="keywordflow">if</span> (cur-&gt;<a class="code" href="structamd__svm__iommu__ir.html#ad1d0011f27de4fbde266e0ce65476e84">data</a> != pi-&gt;ir_data)</div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;        list_del(&amp;cur-&gt;<a class="code" href="structamd__svm__iommu__ir.html#a54d6bf7341caaad5d37469694a4bd434">node</a>);</div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;        kfree(cur);</div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;    }</div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;    spin_unlock_irqrestore(&amp;svm-&gt;<a class="code" href="structvcpu__svm.html#af38f3c63a81a10aae69b308aa175d618">ir_list_lock</a>, <a class="code" href="xen_8c.html#a773b39d480759f67926cb18ae2219281">flags</a>);</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;}</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160; </div>
<div class="line"><a name="l00792"></a><span class="lineno"><a class="line" href="avic_8c.html#a0262c9f1d0d537dafa962ca68a873378">  792</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="avic_8c.html#a0262c9f1d0d537dafa962ca68a873378">svm_ir_list_add</a>(<span class="keyword">struct</span> <a class="code" href="structvcpu__svm.html">vcpu_svm</a> *svm, <span class="keyword">struct</span> amd_iommu_pi_data *pi)</div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;{</div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;    <span class="keywordtype">int</span> ret = 0;</div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="xen_8c.html#a773b39d480759f67926cb18ae2219281">flags</a>;</div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;    <span class="keyword">struct </span><a class="code" href="structamd__svm__iommu__ir.html">amd_svm_iommu_ir</a> *ir;</div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;    u64 entry;</div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;<span class="comment">    /**</span></div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;<span class="comment">     * In some cases, the existing irte is updated and re-set,</span></div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;<span class="comment">     * so we need to check here if it&#39;s already been * added</span></div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;<span class="comment">     * to the ir_list.</span></div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;    <span class="keywordflow">if</span> (pi-&gt;ir_data &amp;&amp; (pi-&gt;prev_ga_tag != 0)) {</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;        <span class="keyword">struct </span>kvm *kvm = svm-&gt;<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>.kvm;</div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;        u32 vcpu_id = <a class="code" href="avic_8c.html#a379bb93a0924b7a44f0fa7cdd37517b1">AVIC_GATAG_TO_VCPUID</a>(pi-&gt;prev_ga_tag);</div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;        <span class="keyword">struct </span>kvm_vcpu *prev_vcpu = kvm_get_vcpu_by_id(kvm, vcpu_id);</div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;        <span class="keyword">struct </span><a class="code" href="structvcpu__svm.html">vcpu_svm</a> *prev_svm;</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160; </div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;        <span class="keywordflow">if</span> (!prev_vcpu) {</div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;            ret = -EINVAL;</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;            <span class="keywordflow">goto</span> out;</div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;        }</div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160; </div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;        prev_svm = <a class="code" href="svm_8h.html#a83e420c88631faf9613ea3caa72c63b7">to_svm</a>(prev_vcpu);</div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;        <a class="code" href="avic_8c.html#a0573329bfb8b7a1a2ba0a4e2ce438dfa">svm_ir_list_del</a>(prev_svm, pi);</div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;    }</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;<span class="comment">    /**</span></div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;<span class="comment">     * Allocating new amd_iommu_pi_data, which will get</span></div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;<span class="comment">     * add to the per-vcpu ir_list.</span></div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;    ir = kzalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structamd__svm__iommu__ir.html">amd_svm_iommu_ir</a>), GFP_KERNEL_ACCOUNT);</div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;    <span class="keywordflow">if</span> (!ir) {</div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;        ret = -ENOMEM;</div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;        <span class="keywordflow">goto</span> out;</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;    }</div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;    ir-&gt;<a class="code" href="structamd__svm__iommu__ir.html#ad1d0011f27de4fbde266e0ce65476e84">data</a> = pi-&gt;ir_data;</div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160; </div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;    spin_lock_irqsave(&amp;svm-&gt;<a class="code" href="structvcpu__svm.html#af38f3c63a81a10aae69b308aa175d618">ir_list_lock</a>, <a class="code" href="xen_8c.html#a773b39d480759f67926cb18ae2219281">flags</a>);</div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160; </div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;<span class="comment">     * Update the target pCPU for IOMMU doorbells if the vCPU is running.</span></div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;<span class="comment">     * If the vCPU is NOT running, i.e. is blocking or scheduled out, KVM</span></div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;<span class="comment">     * will update the pCPU info when the vCPU awkened and/or scheduled in.</span></div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;<span class="comment">     * See also avic_vcpu_load().</span></div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;    entry = READ_ONCE(*(svm-&gt;<a class="code" href="structvcpu__svm.html#abc377a3a5f1f42e18f8a9044321f3d5b">avic_physical_id_cache</a>));</div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;    <span class="keywordflow">if</span> (entry &amp; AVIC_PHYSICAL_ID_ENTRY_IS_RUNNING_MASK)</div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;        amd_iommu_update_ga(entry &amp; AVIC_PHYSICAL_ID_ENTRY_HOST_PHYSICAL_ID_MASK,</div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;                    <span class="keyword">true</span>, pi-&gt;ir_data);</div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160; </div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;    list_add(&amp;ir-&gt;<a class="code" href="structamd__svm__iommu__ir.html#a54d6bf7341caaad5d37469694a4bd434">node</a>, &amp;svm-&gt;<a class="code" href="structvcpu__svm.html#af217181f505db1b71c48743233032539">ir_list</a>);</div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;    spin_unlock_irqrestore(&amp;svm-&gt;<a class="code" href="structvcpu__svm.html#af38f3c63a81a10aae69b308aa175d618">ir_list_lock</a>, <a class="code" href="xen_8c.html#a773b39d480759f67926cb18ae2219281">flags</a>);</div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;out:</div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;    <span class="keywordflow">return</span> ret;</div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;}</div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160; </div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;<span class="comment"> * Note:</span></div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;<span class="comment"> * The HW cannot support posting multicast/broadcast</span></div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;<span class="comment"> * interrupts to a vCPU. So, we still use legacy interrupt</span></div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;<span class="comment"> * remapping for these kind of interrupts.</span></div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;<span class="comment"> * For lowest-priority interrupts, we only support</span></div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;<span class="comment"> * those with single CPU as the destination, e.g. user</span></div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;<span class="comment"> * configures the interrupts via /proc/irq or uses</span></div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;<span class="comment"> * irqbalance to make the interrupts single-CPU.</span></div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line"><a name="l00861"></a><span class="lineno"><a class="line" href="avic_8c.html#a24f70312b475fe0e0858ee3cc7e3af71">  861</a></span>&#160;<a class="code" href="avic_8c.html#a24f70312b475fe0e0858ee3cc7e3af71">get_pi_vcpu_info</a>(<span class="keyword">struct</span> kvm *kvm, <span class="keyword">struct</span> kvm_kernel_irq_routing_entry *e,</div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;         <span class="keyword">struct</span> vcpu_data *vcpu_info, <span class="keyword">struct</span> <a class="code" href="structvcpu__svm.html">vcpu_svm</a> **svm)</div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;{</div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;    <span class="keyword">struct </span>kvm_lapic_irq irq;</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;    <span class="keyword">struct </span>kvm_vcpu *vcpu = NULL;</div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160; </div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;    <a class="code" href="irq__comm_8c.html#a6270cddb139f2ca4f42d21f8caaa1224">kvm_set_msi_irq</a>(kvm, e, &amp;irq);</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160; </div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="irq__comm_8c.html#a6de5d9a13302fceb034b8d75b4c787e2">kvm_intr_is_single_vcpu</a>(kvm, &amp;irq, &amp;vcpu) ||</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;        !kvm_irq_is_postable(&amp;irq)) {</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;        pr_debug(<span class="stringliteral">&quot;SVM: %s: use legacy intr remap mode for irq %u\n&quot;</span>,</div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;             __func__, irq.vector);</div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;        <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;    }</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160; </div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;    pr_debug(<span class="stringliteral">&quot;SVM: %s: use GA mode for irq %u\n&quot;</span>, __func__,</div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;         irq.vector);</div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;    *svm = <a class="code" href="svm_8h.html#a83e420c88631faf9613ea3caa72c63b7">to_svm</a>(vcpu);</div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;    vcpu_info-&gt;pi_desc_addr = __sme_set(page_to_phys((*svm)-&gt;avic_backing_page));</div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;    vcpu_info-&gt;vector = irq.vector;</div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160; </div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;}</div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160; </div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;<span class="comment"> * avic_pi_update_irte - set IRTE for Posted-Interrupts</span></div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;<span class="comment"> * @kvm: kvm</span></div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;<span class="comment"> * @host_irq: host irq of the interrupt</span></div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;<span class="comment"> * @guest_irq: gsi of the interrupt</span></div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;<span class="comment"> * @set: set or unset PI</span></div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;<span class="comment"> * returns 0 on success, &lt; 0 on failure</span></div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00894"></a><span class="lineno"><a class="line" href="avic_8c.html#a3a8b145ddec7a3dc1367a4e4e0df397e">  894</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="avic_8c.html#a3a8b145ddec7a3dc1367a4e4e0df397e">avic_pi_update_irte</a>(<span class="keyword">struct</span> kvm *kvm, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> host_irq,</div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;            uint32_t guest_irq, <span class="keywordtype">bool</span> set)</div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;{</div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;    <span class="keyword">struct </span>kvm_kernel_irq_routing_entry *e;</div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;    <span class="keyword">struct </span>kvm_irq_routing_table *irq_rt;</div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;    <span class="keywordtype">int</span> idx, ret = 0;</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160; </div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="x86_8c.html#ae63567e9b665b34f8c84fc4dc594f3c8">kvm_arch_has_assigned_device</a>(kvm) ||</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;        !irq_remapping_cap(IRQ_POSTING_CAP))</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160; </div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;    pr_debug(<span class="stringliteral">&quot;SVM: %s: host_irq=%#x, guest_irq=%#x, set=%#x\n&quot;</span>,</div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;         __func__, host_irq, guest_irq, set);</div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160; </div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;    idx = srcu_read_lock(&amp;kvm-&gt;irq_srcu);</div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;    irq_rt = srcu_dereference(kvm-&gt;irq_routing, &amp;kvm-&gt;irq_srcu);</div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160; </div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;    <span class="keywordflow">if</span> (guest_irq &gt;= irq_rt-&gt;nr_rt_entries ||</div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;        hlist_empty(&amp;irq_rt-&gt;map[guest_irq])) {</div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;        pr_warn_once(<span class="stringliteral">&quot;no route for guest_irq %u/%u (broken user space?)\n&quot;</span>,</div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;                 guest_irq, irq_rt-&gt;nr_rt_entries);</div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;        <span class="keywordflow">goto</span> out;</div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;    }</div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160; </div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;    hlist_for_each_entry(e, &amp;irq_rt-&gt;map[guest_irq], link) {</div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;        <span class="keyword">struct </span>vcpu_data vcpu_info;</div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;        <span class="keyword">struct </span><a class="code" href="structvcpu__svm.html">vcpu_svm</a> *svm = NULL;</div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160; </div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;        <span class="keywordflow">if</span> (e-&gt;type != KVM_IRQ_ROUTING_MSI)</div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;<span class="comment">        /**</span></div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;<span class="comment">         * Here, we setup with legacy mode in the following cases:</span></div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;<span class="comment">         * 1. When cannot target interrupt to a specific vcpu.</span></div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;<span class="comment">         * 2. Unsetting posted interrupt.</span></div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;<span class="comment">         * 3. APIC virtualization is disabled for the vcpu.</span></div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;<span class="comment">         * 4. IRQ has incompatible delivery mode (SMI, INIT, etc)</span></div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;<span class="comment">         */</span></div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="avic_8c.html#a24f70312b475fe0e0858ee3cc7e3af71">get_pi_vcpu_info</a>(kvm, e, &amp;vcpu_info, &amp;svm) &amp;&amp; set &amp;&amp;</div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;            <a class="code" href="lapic_8h.html#a3af346d02eebff16886d49d3810b5358">kvm_vcpu_apicv_active</a>(&amp;svm-&gt;<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>)) {</div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;            <span class="keyword">struct </span>amd_iommu_pi_data pi;</div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160; </div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;            <span class="comment">/* Try to enable guest_mode in IRTE */</span></div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;            pi.base = __sme_set(page_to_phys(svm-&gt;<a class="code" href="structvcpu__svm.html#a2c8b33d5ae9b731a886634cd6c00165f">avic_backing_page</a>) &amp;</div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;                        AVIC_HPA_MASK);</div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;            pi.ga_tag = <a class="code" href="avic_8c.html#a76254d6522116c2c98b13d9342ba145a">AVIC_GATAG</a>(<a class="code" href="svm_8h.html#ac27f6fe2ff4beeb5ad1b11681d0386fd">to_kvm_svm</a>(kvm)-&gt;avic_vm_id,</div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;                             svm-&gt;<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>.vcpu_id);</div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;            pi.is_guest_mode = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;            pi.vcpu_data = &amp;vcpu_info;</div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;            ret = irq_set_vcpu_affinity(host_irq, &amp;pi);</div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;<span class="comment">            /**</span></div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;<span class="comment">             * Here, we successfully setting up vcpu affinity in</span></div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;<span class="comment">             * IOMMU guest mode. Now, we need to store the posted</span></div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;<span class="comment">             * interrupt information in a per-vcpu ir_list so that</span></div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;<span class="comment">             * we can reference to them directly when we update vcpu</span></div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;<span class="comment">             * scheduling information in IOMMU irte.</span></div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;<span class="comment">             */</span></div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;            <span class="keywordflow">if</span> (!ret &amp;&amp; pi.is_guest_mode)</div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;                <a class="code" href="avic_8c.html#a0262c9f1d0d537dafa962ca68a873378">svm_ir_list_add</a>(svm, &amp;pi);</div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;            <span class="comment">/* Use legacy mode in IRTE */</span></div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;            <span class="keyword">struct </span>amd_iommu_pi_data pi;</div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;<span class="comment">            /**</span></div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;<span class="comment">             * Here, pi is used to:</span></div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;<span class="comment">             * - Tell IOMMU to use legacy mode for this interrupt.</span></div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;<span class="comment">             * - Retrieve ga_tag of prior interrupt remapping data.</span></div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;<span class="comment">             */</span></div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;            pi.prev_ga_tag = 0;</div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;            pi.is_guest_mode = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;            ret = irq_set_vcpu_affinity(host_irq, &amp;pi);</div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;<span class="comment">            /**</span></div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;<span class="comment">             * Check if the posted interrupt was previously</span></div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;<span class="comment">             * setup with the guest_mode by checking if the ga_tag</span></div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;<span class="comment">             * was cached. If so, we need to clean up the per-vcpu</span></div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;<span class="comment">             * ir_list.</span></div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;<span class="comment">             */</span></div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;            <span class="keywordflow">if</span> (!ret &amp;&amp; pi.prev_ga_tag) {</div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;                <span class="keywordtype">int</span> <span class="keywordtype">id</span> = <a class="code" href="avic_8c.html#a379bb93a0924b7a44f0fa7cdd37517b1">AVIC_GATAG_TO_VCPUID</a>(pi.prev_ga_tag);</div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;                <span class="keyword">struct </span>kvm_vcpu *vcpu;</div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160; </div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;                vcpu = kvm_get_vcpu_by_id(kvm, <span class="keywordtype">id</span>);</div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;                <span class="keywordflow">if</span> (vcpu)</div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;                    <a class="code" href="avic_8c.html#a0573329bfb8b7a1a2ba0a4e2ce438dfa">svm_ir_list_del</a>(<a class="code" href="svm_8h.html#a83e420c88631faf9613ea3caa72c63b7">to_svm</a>(vcpu), &amp;pi);</div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;            }</div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;        }</div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160; </div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;        <span class="keywordflow">if</span> (!ret &amp;&amp; svm) {</div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;            trace_kvm_pi_irte_update(host_irq, svm-&gt;<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>.vcpu_id,</div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;                         e-&gt;gsi, vcpu_info.vector,</div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;                         vcpu_info.pi_desc_addr, set);</div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;        }</div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160; </div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;        <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;            pr_err(<span class="stringliteral">&quot;%s: failed to update PI IRTE\n&quot;</span>, __func__);</div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;            <span class="keywordflow">goto</span> out;</div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;        }</div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;    }</div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160; </div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;    ret = 0;</div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;out:</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;    srcu_read_unlock(&amp;kvm-&gt;irq_srcu, idx);</div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;    <span class="keywordflow">return</span> ret;</div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;}</div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160; </div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;<span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span></div>
<div class="line"><a name="l01002"></a><span class="lineno"><a class="line" href="avic_8c.html#a7b088623e16cec4875e37d8ce15231b2"> 1002</a></span>&#160;<a class="code" href="avic_8c.html#a7b088623e16cec4875e37d8ce15231b2">avic_update_iommu_vcpu_affinity</a>(<span class="keyword">struct</span> kvm_vcpu *vcpu, <span class="keywordtype">int</span> cpu, <span class="keywordtype">bool</span> r)</div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;{</div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;    <span class="keywordtype">int</span> ret = 0;</div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;    <span class="keyword">struct </span><a class="code" href="structamd__svm__iommu__ir.html">amd_svm_iommu_ir</a> *ir;</div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;    <span class="keyword">struct </span><a class="code" href="structvcpu__svm.html">vcpu_svm</a> *svm = <a class="code" href="svm_8h.html#a83e420c88631faf9613ea3caa72c63b7">to_svm</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>);</div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160; </div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;    lockdep_assert_held(&amp;svm-&gt;<a class="code" href="structvcpu__svm.html#af38f3c63a81a10aae69b308aa175d618">ir_list_lock</a>);</div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160; </div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="x86_8c.html#ae63567e9b665b34f8c84fc4dc594f3c8">kvm_arch_has_assigned_device</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>-&gt;kvm))</div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160; </div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;<span class="comment">     * Here, we go through the per-vcpu ir_list to update all existing</span></div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;<span class="comment">     * interrupt remapping table entry targeting this vcpu.</span></div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;    <span class="keywordflow">if</span> (list_empty(&amp;svm-&gt;<a class="code" href="structvcpu__svm.html#af217181f505db1b71c48743233032539">ir_list</a>))</div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160; </div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;    list_for_each_entry(ir, &amp;svm-&gt;<a class="code" href="structvcpu__svm.html#af217181f505db1b71c48743233032539">ir_list</a>, node) {</div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;        ret = amd_iommu_update_ga(cpu, r, ir-&gt;<a class="code" href="structamd__svm__iommu__ir.html#ad1d0011f27de4fbde266e0ce65476e84">data</a>);</div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;        <span class="keywordflow">if</span> (ret)</div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;            <span class="keywordflow">return</span> ret;</div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;    }</div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;}</div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160; </div>
<div class="line"><a name="l01028"></a><span class="lineno"><a class="line" href="avic_8c.html#a7decdbafc7d47b2241e68ce3c90a9779"> 1028</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="avic_8c.html#a7decdbafc7d47b2241e68ce3c90a9779">avic_vcpu_load</a>(<span class="keyword">struct</span> kvm_vcpu *<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>, <span class="keywordtype">int</span> cpu)</div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;{</div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;    u64 entry;</div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;    <span class="keywordtype">int</span> h_physical_id = kvm_cpu_get_apicid(cpu);</div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;    <span class="keyword">struct </span><a class="code" href="structvcpu__svm.html">vcpu_svm</a> *svm = <a class="code" href="svm_8h.html#a83e420c88631faf9613ea3caa72c63b7">to_svm</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>);</div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="xen_8c.html#a773b39d480759f67926cb18ae2219281">flags</a>;</div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160; </div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;    lockdep_assert_preemption_disabled();</div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160; </div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;    <span class="keywordflow">if</span> (WARN_ON(h_physical_id &amp; ~AVIC_PHYSICAL_ID_ENTRY_HOST_PHYSICAL_ID_MASK))</div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160; </div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;<span class="comment">     * No need to update anything if the vCPU is blocking, i.e. if the vCPU</span></div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;<span class="comment">     * is being scheduled in after being preempted.  The CPU entries in the</span></div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;<span class="comment">     * Physical APIC table and IRTE are consumed iff IsRun{ning} is &#39;1&#39;.</span></div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;<span class="comment">     * If the vCPU was migrated, its new CPU value will be stuffed when the</span></div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;<span class="comment">     * vCPU unblocks.</span></div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;    <span class="keywordflow">if</span> (kvm_vcpu_is_blocking(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>))</div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160; </div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;<span class="comment">     * Grab the per-vCPU interrupt remapping lock even if the VM doesn&#39;t</span></div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;<span class="comment">     * _currently_ have assigned devices, as that can change.  Holding</span></div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;<span class="comment">     * ir_list_lock ensures that either svm_ir_list_add() will consume</span></div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;<span class="comment">     * up-to-date entry information, or that this task will wait until</span></div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;<span class="comment">     * svm_ir_list_add() completes to set the new target pCPU.</span></div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;    spin_lock_irqsave(&amp;svm-&gt;<a class="code" href="structvcpu__svm.html#af38f3c63a81a10aae69b308aa175d618">ir_list_lock</a>, <a class="code" href="xen_8c.html#a773b39d480759f67926cb18ae2219281">flags</a>);</div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160; </div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;    entry = READ_ONCE(*(svm-&gt;<a class="code" href="structvcpu__svm.html#abc377a3a5f1f42e18f8a9044321f3d5b">avic_physical_id_cache</a>));</div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;    WARN_ON_ONCE(entry &amp; AVIC_PHYSICAL_ID_ENTRY_IS_RUNNING_MASK);</div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160; </div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;    entry &amp;= ~AVIC_PHYSICAL_ID_ENTRY_HOST_PHYSICAL_ID_MASK;</div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;    entry |= (h_physical_id &amp; AVIC_PHYSICAL_ID_ENTRY_HOST_PHYSICAL_ID_MASK);</div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;    entry |= AVIC_PHYSICAL_ID_ENTRY_IS_RUNNING_MASK;</div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160; </div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;    WRITE_ONCE(*(svm-&gt;<a class="code" href="structvcpu__svm.html#abc377a3a5f1f42e18f8a9044321f3d5b">avic_physical_id_cache</a>), entry);</div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;    <a class="code" href="avic_8c.html#a7b088623e16cec4875e37d8ce15231b2">avic_update_iommu_vcpu_affinity</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>, h_physical_id, <span class="keyword">true</span>);</div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160; </div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;    spin_unlock_irqrestore(&amp;svm-&gt;<a class="code" href="structvcpu__svm.html#af38f3c63a81a10aae69b308aa175d618">ir_list_lock</a>, <a class="code" href="xen_8c.html#a773b39d480759f67926cb18ae2219281">flags</a>);</div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;}</div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160; </div>
<div class="line"><a name="l01072"></a><span class="lineno"><a class="line" href="avic_8c.html#a461f968598a11484e76a07fb87221bf2"> 1072</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="avic_8c.html#a461f968598a11484e76a07fb87221bf2">avic_vcpu_put</a>(<span class="keyword">struct</span> kvm_vcpu *<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>)</div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;{</div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;    u64 entry;</div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;    <span class="keyword">struct </span><a class="code" href="structvcpu__svm.html">vcpu_svm</a> *svm = <a class="code" href="svm_8h.html#a83e420c88631faf9613ea3caa72c63b7">to_svm</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>);</div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="xen_8c.html#a773b39d480759f67926cb18ae2219281">flags</a>;</div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160; </div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;    lockdep_assert_preemption_disabled();</div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160; </div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;<span class="comment">     * Note, reading the Physical ID entry outside of ir_list_lock is safe</span></div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;<span class="comment">     * as only the pCPU that has loaded (or is loading) the vCPU is allowed</span></div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;<span class="comment">     * to modify the entry, and preemption is disabled.  I.e. the vCPU</span></div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;<span class="comment">     * can&#39;t be scheduled out and thus avic_vcpu_{put,load}() can&#39;t run</span></div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;<span class="comment">     * recursively.</span></div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;    entry = READ_ONCE(*(svm-&gt;<a class="code" href="structvcpu__svm.html#abc377a3a5f1f42e18f8a9044321f3d5b">avic_physical_id_cache</a>));</div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160; </div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;    <span class="comment">/* Nothing to do if IsRunning == &#39;0&#39; due to vCPU blocking. */</span></div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;    <span class="keywordflow">if</span> (!(entry &amp; AVIC_PHYSICAL_ID_ENTRY_IS_RUNNING_MASK))</div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160; </div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;<span class="comment">     * Take and hold the per-vCPU interrupt remapping lock while updating</span></div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;<span class="comment">     * the Physical ID entry even though the lock doesn&#39;t protect against</span></div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;<span class="comment">     * multiple writers (see above).  Holding ir_list_lock ensures that</span></div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;<span class="comment">     * either svm_ir_list_add() will consume up-to-date entry information,</span></div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;<span class="comment">     * or that this task will wait until svm_ir_list_add() completes to</span></div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;<span class="comment">     * mark the vCPU as not running.</span></div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;    spin_lock_irqsave(&amp;svm-&gt;<a class="code" href="structvcpu__svm.html#af38f3c63a81a10aae69b308aa175d618">ir_list_lock</a>, <a class="code" href="xen_8c.html#a773b39d480759f67926cb18ae2219281">flags</a>);</div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160; </div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;    <a class="code" href="avic_8c.html#a7b088623e16cec4875e37d8ce15231b2">avic_update_iommu_vcpu_affinity</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>, -1, 0);</div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160; </div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;    entry &amp;= ~AVIC_PHYSICAL_ID_ENTRY_IS_RUNNING_MASK;</div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;    WRITE_ONCE(*(svm-&gt;<a class="code" href="structvcpu__svm.html#abc377a3a5f1f42e18f8a9044321f3d5b">avic_physical_id_cache</a>), entry);</div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160; </div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;    spin_unlock_irqrestore(&amp;svm-&gt;<a class="code" href="structvcpu__svm.html#af38f3c63a81a10aae69b308aa175d618">ir_list_lock</a>, <a class="code" href="xen_8c.html#a773b39d480759f67926cb18ae2219281">flags</a>);</div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160; </div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;}</div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160; </div>
<div class="line"><a name="l01112"></a><span class="lineno"><a class="line" href="avic_8c.html#a51356c24441683c197e1d4c2555da06d"> 1112</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="avic_8c.html#a51356c24441683c197e1d4c2555da06d">avic_refresh_virtual_apic_mode</a>(<span class="keyword">struct</span> kvm_vcpu *<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>)</div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;{</div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;    <span class="keyword">struct </span><a class="code" href="structvcpu__svm.html">vcpu_svm</a> *svm = <a class="code" href="svm_8h.html#a83e420c88631faf9613ea3caa72c63b7">to_svm</a>(<a class="code" href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu</a>);</div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;    <span class="keyword">struct </span>vmcb *vmcb = svm-&gt;<a class="code" href="structvcpu__svm.html#af0c24755d59a0cfca7ce9ba64f682722">vmcb01</a>.<a class="code" href="structkvm__vmcb__info.html#a8076921f239564576af7af19be7f6f04">ptr</a>;</div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160; </div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="lapic_8h.html#a1d8c9378fcbf62390a89dc3b7f0bdbd4">lapic_in_kernel</a>(vcpu) || !<a class="code" href="x86_8c.html#a04af9ab3eee510b54cba17a6fa94ee04">enable_apicv</a>)</div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160; </div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="lapic_8h.html#a3af346d02eebff16886d49d3810b5358">kvm_vcpu_apicv_active</a>(vcpu)) {<span class="comment"></span></div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;<span class="comment">        /**</span></div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;<span class="comment">         * During AVIC temporary deactivation, guest could update</span></div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;<span class="comment">         * APIC ID, DFR and LDR registers, which would not be trapped</span></div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;<span class="comment">         * by avic_unaccelerated_access_interception(). In this case,</span></div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;<span class="comment">         * we need to check and update the AVIC logical APIC ID table</span></div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;<span class="comment">         * accordingly before re-activating.</span></div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;<span class="comment">         */</span></div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;        <a class="code" href="avic_8c.html#ae9f162404fdb37bba372d0c9cdc043ee">avic_apicv_post_state_restore</a>(vcpu);</div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;        <a class="code" href="avic_8c.html#a2af29a6a396bb757ac21f02f6aacfdfa">avic_activate_vmcb</a>(svm);</div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;        <a class="code" href="avic_8c.html#ac41a57fe4f855076b5c5718def5bd6d3">avic_deactivate_vmcb</a>(svm);</div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;    }</div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;    <a class="code" href="svm_8h.html#ab83edec724698a20d66a086a1900aa27">vmcb_mark_dirty</a>(vmcb, <a class="code" href="svm_8h.html#a39fca1837c5ce7715cbf571669660c13a3d33483aba8bab1af6c7a3a56141cd8f">VMCB_AVIC</a>);</div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;}</div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160; </div>
<div class="line"><a name="l01136"></a><span class="lineno"><a class="line" href="avic_8c.html#affcdeac6765016e970e33d6ecff3eebb"> 1136</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="avic_8c.html#affcdeac6765016e970e33d6ecff3eebb">avic_refresh_apicv_exec_ctrl</a>(<span class="keyword">struct</span> kvm_vcpu *vcpu)</div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;{</div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;    <span class="keywordtype">bool</span> activated = <a class="code" href="lapic_8h.html#a3af346d02eebff16886d49d3810b5358">kvm_vcpu_apicv_active</a>(vcpu);</div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160; </div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="x86_8c.html#a04af9ab3eee510b54cba17a6fa94ee04">enable_apicv</a>)</div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160; </div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;    <a class="code" href="avic_8c.html#a51356c24441683c197e1d4c2555da06d">avic_refresh_virtual_apic_mode</a>(vcpu);</div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160; </div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;    <span class="keywordflow">if</span> (activated)</div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;        <a class="code" href="avic_8c.html#a7decdbafc7d47b2241e68ce3c90a9779">avic_vcpu_load</a>(vcpu, vcpu-&gt;cpu);</div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;        <a class="code" href="avic_8c.html#a461f968598a11484e76a07fb87221bf2">avic_vcpu_put</a>(vcpu);</div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160; </div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;    <a class="code" href="avic_8c.html#a520da70652fa3f7af0d58c1ecb7d0db7">avic_set_pi_irte_mode</a>(vcpu, activated);</div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;}</div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160; </div>
<div class="line"><a name="l01153"></a><span class="lineno"><a class="line" href="avic_8c.html#a056e12caaf24f044fce8545a863dbbce"> 1153</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="avic_8c.html#a056e12caaf24f044fce8545a863dbbce">avic_vcpu_blocking</a>(<span class="keyword">struct</span> kvm_vcpu *vcpu)</div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;{</div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="lapic_8h.html#a3af346d02eebff16886d49d3810b5358">kvm_vcpu_apicv_active</a>(vcpu))</div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160; </div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;       <span class="comment">/*</span></div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;<span class="comment">        * Unload the AVIC when the vCPU is about to block, _before_</span></div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;<span class="comment">        * the vCPU actually blocks.</span></div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;<span class="comment">        *</span></div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;<span class="comment">        * Any IRQs that arrive before IsRunning=0 will not cause an</span></div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;<span class="comment">        * incomplete IPI vmexit on the source, therefore vIRR will also</span></div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;<span class="comment">        * be checked by kvm_vcpu_check_block() before blocking.  The</span></div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;<span class="comment">        * memory barrier implicit in set_current_state orders writing</span></div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;<span class="comment">        * IsRunning=0 before reading the vIRR.  The processor needs a</span></div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;<span class="comment">        * matching memory barrier on interrupt delivery between writing</span></div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;<span class="comment">        * IRR and reading IsRunning; the lack of this barrier might be</span></div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;<span class="comment">        * the cause of errata #1235).</span></div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;<span class="comment">        */</span></div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;    <a class="code" href="avic_8c.html#a461f968598a11484e76a07fb87221bf2">avic_vcpu_put</a>(vcpu);</div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;}</div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160; </div>
<div class="line"><a name="l01174"></a><span class="lineno"><a class="line" href="avic_8c.html#a7e341d7f17b2f611aca180217cfc6ad3"> 1174</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="avic_8c.html#a7e341d7f17b2f611aca180217cfc6ad3">avic_vcpu_unblocking</a>(<span class="keyword">struct</span> kvm_vcpu *vcpu)</div>
<div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;{</div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="lapic_8h.html#a3af346d02eebff16886d49d3810b5358">kvm_vcpu_apicv_active</a>(vcpu))</div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160; </div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;    <a class="code" href="avic_8c.html#a7decdbafc7d47b2241e68ce3c90a9779">avic_vcpu_load</a>(vcpu, vcpu-&gt;cpu);</div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;}</div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160; </div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;<span class="comment"> * Note:</span></div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;<span class="comment"> * - The module param avic enable both xAPIC and x2APIC mode.</span></div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;<span class="comment"> * - Hypervisor can support both xAVIC and x2AVIC in the same guest.</span></div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;<span class="comment"> * - The mode can be switched at run-time.</span></div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l01188"></a><span class="lineno"><a class="line" href="structamd__svm__iommu__ir.html#a54d6bf7341caaad5d37469694a4bd434"> 1188</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="avic_8c.html#ada833d2b35b3e565a6900b25d1cce7c7">avic_hardware_setup</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;{</div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="svm_8c.html#a17a219d0651f1db709a3af0fc5527aa0">npt_enabled</a>)</div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160; </div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;    <span class="comment">/* AVIC is a prerequisite for x2AVIC. */</span></div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;    <span class="keywordflow">if</span> (!boot_cpu_has(X86_FEATURE_AVIC) &amp;&amp; !<a class="code" href="avic_8c.html#a969a7c5f37696d459ce0a2065a8ca97f">force_avic</a>) {</div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;        <span class="keywordflow">if</span> (boot_cpu_has(X86_FEATURE_X2AVIC)) {</div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;            pr_warn(FW_BUG <span class="stringliteral">&quot;Cannot support x2AVIC due to AVIC is disabled&quot;</span>);</div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;            pr_warn(FW_BUG <span class="stringliteral">&quot;Try enable AVIC using force_avic option&quot;</span>);</div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;        }</div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;    }</div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160; </div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;    <span class="keywordflow">if</span> (boot_cpu_has(X86_FEATURE_AVIC)) {</div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;        pr_info(<span class="stringliteral">&quot;AVIC enabled\n&quot;</span>);</div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="avic_8c.html#a969a7c5f37696d459ce0a2065a8ca97f">force_avic</a>) {</div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;<span class="comment">         * Some older systems does not advertise AVIC support.</span></div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;<span class="comment">         * See Revision Guide for specific AMD processor for more detail.</span></div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;<span class="comment">         */</span></div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;        pr_warn(<span class="stringliteral">&quot;AVIC is not supported in CPUID but force enabled&quot;</span>);</div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;        pr_warn(<span class="stringliteral">&quot;Your system might crash and burn&quot;</span>);</div>
<div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;    }</div>
<div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160; </div>
<div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;    <span class="comment">/* AVIC is a prerequisite for x2AVIC. */</span></div>
<div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;    <a class="code" href="avic_8c.html#ad4c0ba70ab315cedbb11f259b1d7ae08">x2avic_enabled</a> = boot_cpu_has(X86_FEATURE_X2AVIC);</div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="avic_8c.html#ad4c0ba70ab315cedbb11f259b1d7ae08">x2avic_enabled</a>)</div>
<div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;        pr_info(<span class="stringliteral">&quot;x2AVIC enabled\n&quot;</span>);</div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160; </div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;    amd_iommu_register_ga_log_notifier(&amp;<a class="code" href="avic_8c.html#af75098185942f8eb5703b2b65bf9257d">avic_ga_log_notifier</a>);</div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160; </div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;}</div>
<div class="ttc" id="aavic_8c_html_a0262c9f1d0d537dafa962ca68a873378"><div class="ttname"><a href="avic_8c.html#a0262c9f1d0d537dafa962ca68a873378">svm_ir_list_add</a></div><div class="ttdeci">static int svm_ir_list_add(struct vcpu_svm *svm, struct amd_iommu_pi_data *pi)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00792">avic.c:792</a></div></div>
<div class="ttc" id="aavic_8c_html_a056e12caaf24f044fce8545a863dbbce"><div class="ttname"><a href="avic_8c.html#a056e12caaf24f044fce8545a863dbbce">avic_vcpu_blocking</a></div><div class="ttdeci">void avic_vcpu_blocking(struct kvm_vcpu *vcpu)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l01153">avic.c:1153</a></div></div>
<div class="ttc" id="aavic_8c_html_a0573329bfb8b7a1a2ba0a4e2ce438dfa"><div class="ttname"><a href="avic_8c.html#a0573329bfb8b7a1a2ba0a4e2ce438dfa">svm_ir_list_del</a></div><div class="ttdeci">static void svm_ir_list_del(struct vcpu_svm *svm, struct amd_iommu_pi_data *pi)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00776">avic.c:776</a></div></div>
<div class="ttc" id="aavic_8c_html_a0ddedac4b0b428928fae6bc9fe902e2a"><div class="ttname"><a href="avic_8c.html#a0ddedac4b0b428928fae6bc9fe902e2a">avic_vm_init</a></div><div class="ttdeci">int avic_vm_init(struct kvm *kvm)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00192">avic.c:192</a></div></div>
<div class="ttc" id="aavic_8c_html_a1404df5f813565dd104640a6e5bfea67"><div class="ttname"><a href="avic_8c.html#a1404df5f813565dd104640a6e5bfea67">avic_kick_vcpu_by_logical_id</a></div><div class="ttdeci">static void avic_kick_vcpu_by_logical_id(struct kvm *kvm, u32 *avic_logical_id_table, u32 logid_index, u32 icrl)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00365">avic.c:365</a></div></div>
<div class="ttc" id="aavic_8c_html_a1e123c3defad20a133e56f43373b9c44"><div class="ttname"><a href="avic_8c.html#a1e123c3defad20a133e56f43373b9c44">next_vm_id_wrapped</a></div><div class="ttdeci">static bool next_vm_id_wrapped</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00073">avic.c:73</a></div></div>
<div class="ttc" id="aavic_8c_html_a24f70312b475fe0e0858ee3cc7e3af71"><div class="ttname"><a href="avic_8c.html#a24f70312b475fe0e0858ee3cc7e3af71">get_pi_vcpu_info</a></div><div class="ttdeci">static int get_pi_vcpu_info(struct kvm *kvm, struct kvm_kernel_irq_routing_entry *e, struct vcpu_data *vcpu_info, struct vcpu_svm **svm)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00861">avic.c:861</a></div></div>
<div class="ttc" id="aavic_8c_html_a2650b353757b538de17a1c843f7308d2"><div class="ttname"><a href="avic_8c.html#a2650b353757b538de17a1c843f7308d2">avic_ldr_write</a></div><div class="ttdeci">static void avic_ldr_write(struct kvm_vcpu *vcpu, u8 g_physical_id, u32 ldr)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00578">avic.c:578</a></div></div>
<div class="ttc" id="aavic_8c_html_a299de3990a5ce5ce873df7afe2b3338f"><div class="ttname"><a href="avic_8c.html#a299de3990a5ce5ce873df7afe2b3338f">avic_unaccelerated_access_interception</a></div><div class="ttdeci">int avic_unaccelerated_access_interception(struct kvm_vcpu *vcpu)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00693">avic.c:693</a></div></div>
<div class="ttc" id="aavic_8c_html_a2af29a6a396bb757ac21f02f6aacfdfa"><div class="ttname"><a href="avic_8c.html#a2af29a6a396bb757ac21f02f6aacfdfa">avic_activate_vmcb</a></div><div class="ttdeci">static void avic_activate_vmcb(struct vcpu_svm *svm)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00085">avic.c:85</a></div></div>
<div class="ttc" id="aavic_8c_html_a2b9e298755a0d51bb5b2dfc9dd254c64"><div class="ttname"><a href="avic_8c.html#a2b9e298755a0d51bb5b2dfc9dd254c64">avic_kick_vcpu</a></div><div class="ttdeci">static void avic_kick_vcpu(struct kvm_vcpu *vcpu, u32 icrl)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00340">avic.c:340</a></div></div>
<div class="ttc" id="aavic_8c_html_a2ed13621ec3f14afbf47f129e43b496d"><div class="ttname"><a href="avic_8c.html#a2ed13621ec3f14afbf47f129e43b496d">avic_invalidate_logical_id_entry</a></div><div class="ttdeci">static void avic_invalidate_logical_id_entry(struct kvm_vcpu *vcpu)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00595">avic.c:595</a></div></div>
<div class="ttc" id="aavic_8c_html_a379bb93a0924b7a44f0fa7cdd37517b1"><div class="ttname"><a href="avic_8c.html#a379bb93a0924b7a44f0fa7cdd37517b1">AVIC_GATAG_TO_VCPUID</a></div><div class="ttdeci">#define AVIC_GATAG_TO_VCPUID(x)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00047">avic.c:47</a></div></div>
<div class="ttc" id="aavic_8c_html_a3a8b145ddec7a3dc1367a4e4e0df397e"><div class="ttname"><a href="avic_8c.html#a3a8b145ddec7a3dc1367a4e4e0df397e">avic_pi_update_irte</a></div><div class="ttdeci">int avic_pi_update_irte(struct kvm *kvm, unsigned int host_irq, uint32_t guest_irq, bool set)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00894">avic.c:894</a></div></div>
<div class="ttc" id="aavic_8c_html_a3bb736e8688ecfaa3696b347764fd37d"><div class="ttname"><a href="avic_8c.html#a3bb736e8688ecfaa3696b347764fd37d">avic_vm_destroy</a></div><div class="ttdeci">void avic_vm_destroy(struct kvm *kvm)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00174">avic.c:174</a></div></div>
<div class="ttc" id="aavic_8c_html_a40f16bbe281410ac02865ea25c26bf12"><div class="ttname"><a href="avic_8c.html#a40f16bbe281410ac02865ea25c26bf12">avic_init_vmcb</a></div><div class="ttdeci">void avic_init_vmcb(struct vcpu_svm *svm, struct vmcb *vmcb)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00244">avic.c:244</a></div></div>
<div class="ttc" id="aavic_8c_html_a43bf45802761215fb7aeb3a0f716a429"><div class="ttname"><a href="avic_8c.html#a43bf45802761215fb7aeb3a0f716a429">SVM_VM_DATA_HASH_BITS</a></div><div class="ttdeci">#define SVM_VM_DATA_HASH_BITS</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00070">avic.c:70</a></div></div>
<div class="ttc" id="aavic_8c_html_a461f968598a11484e76a07fb87221bf2"><div class="ttname"><a href="avic_8c.html#a461f968598a11484e76a07fb87221bf2">avic_vcpu_put</a></div><div class="ttdeci">void avic_vcpu_put(struct kvm_vcpu *vcpu)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l01072">avic.c:1072</a></div></div>
<div class="ttc" id="aavic_8c_html_a48d73aa47db0cd13044af80a191469b6"><div class="ttname"><a href="avic_8c.html#a48d73aa47db0cd13044af80a191469b6">DEFINE_SPINLOCK</a></div><div class="ttdeci">static DEFINE_SPINLOCK(svm_vm_data_hash_lock)</div></div>
<div class="ttc" id="aavic_8c_html_a4a11c0014568405b90307ef68285e4ff"><div class="ttname"><a href="avic_8c.html#a4a11c0014568405b90307ef68285e4ff">avic_incomplete_ipi_interception</a></div><div class="ttdeci">int avic_incomplete_ipi_interception(struct kvm_vcpu *vcpu)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00490">avic.c:490</a></div></div>
<div class="ttc" id="aavic_8c_html_a4b900d047f49b6cd00266aba3f4912bf"><div class="ttname"><a href="avic_8c.html#a4b900d047f49b6cd00266aba3f4912bf">avic_kick_vcpu_by_physical_id</a></div><div class="ttdeci">static void avic_kick_vcpu_by_physical_id(struct kvm *kvm, u32 physical_id, u32 icrl)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00349">avic.c:349</a></div></div>
<div class="ttc" id="aavic_8c_html_a504afac7afffff075f42d33af8c21ef0"><div class="ttname"><a href="avic_8c.html#a504afac7afffff075f42d33af8c21ef0">AVIC_GATAG_TO_VMID</a></div><div class="ttdeci">#define AVIC_GATAG_TO_VMID(x)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00046">avic.c:46</a></div></div>
<div class="ttc" id="aavic_8c_html_a51356c24441683c197e1d4c2555da06d"><div class="ttname"><a href="avic_8c.html#a51356c24441683c197e1d4c2555da06d">avic_refresh_virtual_apic_mode</a></div><div class="ttdeci">void avic_refresh_virtual_apic_mode(struct kvm_vcpu *vcpu)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l01112">avic.c:1112</a></div></div>
<div class="ttc" id="aavic_8c_html_a520da70652fa3f7af0d58c1ecb7d0db7"><div class="ttname"><a href="avic_8c.html#a520da70652fa3f7af0d58c1ecb7d0db7">avic_set_pi_irte_mode</a></div><div class="ttdeci">static int avic_set_pi_irte_mode(struct kvm_vcpu *vcpu, bool activate)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00744">avic.c:744</a></div></div>
<div class="ttc" id="aavic_8c_html_a591769978fd794e332f217d97f35bfec"><div class="ttname"><a href="avic_8c.html#a591769978fd794e332f217d97f35bfec">__AVIC_GATAG</a></div><div class="ttdeci">#define __AVIC_GATAG(vm_id, vcpu_id)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00049">avic.c:49</a></div></div>
<div class="ttc" id="aavic_8c_html_a5eaaa2d4a926c006359343ff29a9cdf7"><div class="ttname"><a href="avic_8c.html#a5eaaa2d4a926c006359343ff29a9cdf7">avic_get_logical_id_entry</a></div><div class="ttdeci">static u32 * avic_get_logical_id_entry(struct kvm_vcpu *vcpu, u32 ldr, bool flat)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00549">avic.c:549</a></div></div>
<div class="ttc" id="aavic_8c_html_a6a50d2e2e091254aac3982a50360a8ba"><div class="ttname"><a href="avic_8c.html#a6a50d2e2e091254aac3982a50360a8ba">module_param_unsafe</a></div><div class="ttdeci">module_param_unsafe(force_avic, bool, 0444)</div></div>
<div class="ttc" id="aavic_8c_html_a6a9ffca6bae1adce86d4495b5caaae2e"><div class="ttname"><a href="avic_8c.html#a6a9ffca6bae1adce86d4495b5caaae2e">avic_handle_ldr_update</a></div><div class="ttdeci">static void avic_handle_ldr_update(struct kvm_vcpu *vcpu)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00610">avic.c:610</a></div></div>
<div class="ttc" id="aavic_8c_html_a76254d6522116c2c98b13d9342ba145a"><div class="ttname"><a href="avic_8c.html#a76254d6522116c2c98b13d9342ba145a">AVIC_GATAG</a></div><div class="ttdeci">#define AVIC_GATAG(vm_id, vcpu_id)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00051">avic.c:51</a></div></div>
<div class="ttc" id="aavic_8c_html_a7b088623e16cec4875e37d8ce15231b2"><div class="ttname"><a href="avic_8c.html#a7b088623e16cec4875e37d8ce15231b2">avic_update_iommu_vcpu_affinity</a></div><div class="ttdeci">static int avic_update_iommu_vcpu_affinity(struct kvm_vcpu *vcpu, int cpu, bool r)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l01002">avic.c:1002</a></div></div>
<div class="ttc" id="aavic_8c_html_a7cf9fdcdf4f5f6559c099faaab0c2d29"><div class="ttname"><a href="avic_8c.html#a7cf9fdcdf4f5f6559c099faaab0c2d29">avic_kick_target_vcpus_fast</a></div><div class="ttdeci">static int avic_kick_target_vcpus_fast(struct kvm *kvm, struct kvm_lapic *source, u32 icrl, u32 icrh, u32 index)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00397">avic.c:397</a></div></div>
<div class="ttc" id="aavic_8c_html_a7decdbafc7d47b2241e68ce3c90a9779"><div class="ttname"><a href="avic_8c.html#a7decdbafc7d47b2241e68ce3c90a9779">avic_vcpu_load</a></div><div class="ttdeci">void avic_vcpu_load(struct kvm_vcpu *vcpu, int cpu)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l01028">avic.c:1028</a></div></div>
<div class="ttc" id="aavic_8c_html_a7e341d7f17b2f611aca180217cfc6ad3"><div class="ttname"><a href="avic_8c.html#a7e341d7f17b2f611aca180217cfc6ad3">avic_vcpu_unblocking</a></div><div class="ttdeci">void avic_vcpu_unblocking(struct kvm_vcpu *vcpu)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l01174">avic.c:1174</a></div></div>
<div class="ttc" id="aavic_8c_html_a85aae38c76b154dc96183124f815e5e4"><div class="ttname"><a href="avic_8c.html#a85aae38c76b154dc96183124f815e5e4">AVIC_VCPU_ID_MASK</a></div><div class="ttdeci">#define AVIC_VCPU_ID_MASK</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00041">avic.c:41</a></div></div>
<div class="ttc" id="aavic_8c_html_a8cfb06497cbd5960a4a909c44e701f06"><div class="ttname"><a href="avic_8c.html#a8cfb06497cbd5960a4a909c44e701f06">avic_get_physical_id_entry</a></div><div class="ttdeci">static u64 * avic_get_physical_id_entry(struct kvm_vcpu *vcpu, unsigned int index)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00262">avic.c:262</a></div></div>
<div class="ttc" id="aavic_8c_html_a8e0a22138080054f4ac064064402f74a"><div class="ttname"><a href="avic_8c.html#a8e0a22138080054f4ac064064402f74a">avic_init_vcpu</a></div><div class="ttdeci">int avic_init_vcpu(struct vcpu_svm *svm)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00719">avic.c:719</a></div></div>
<div class="ttc" id="aavic_8c_html_a969a7c5f37696d459ce0a2065a8ca97f"><div class="ttname"><a href="avic_8c.html#a969a7c5f37696d459ce0a2065a8ca97f">force_avic</a></div><div class="ttdeci">static bool force_avic</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00062">avic.c:60</a></div></div>
<div class="ttc" id="aavic_8c_html_a9c7db7e1cb25acd53eb51e777934c9e8"><div class="ttname"><a href="avic_8c.html#a9c7db7e1cb25acd53eb51e777934c9e8">is_avic_unaccelerated_access_trap</a></div><div class="ttdeci">static bool is_avic_unaccelerated_access_trap(u32 offset)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00664">avic.c:664</a></div></div>
<div class="ttc" id="aavic_8c_html_aa0b824f0eb25d52b2753a0446792f7d9"><div class="ttname"><a href="avic_8c.html#aa0b824f0eb25d52b2753a0446792f7d9">DEFINE_HASHTABLE</a></div><div class="ttdeci">static DEFINE_HASHTABLE(svm_vm_data_hash, SVM_VM_DATA_HASH_BITS)</div></div>
<div class="ttc" id="aavic_8c_html_aa582eb517550b4af588363963042a791"><div class="ttname"><a href="avic_8c.html#aa582eb517550b4af588363963042a791">AVIC_VM_ID_MASK</a></div><div class="ttdeci">#define AVIC_VM_ID_MASK</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00044">avic.c:44</a></div></div>
<div class="ttc" id="aavic_8c_html_aaff9720871b696bc298d89cbb27a6dc2"><div class="ttname"><a href="avic_8c.html#aaff9720871b696bc298d89cbb27a6dc2">avic_handle_dfr_update</a></div><div class="ttdeci">static void avic_handle_dfr_update(struct kvm_vcpu *vcpu)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00629">avic.c:629</a></div></div>
<div class="ttc" id="aavic_8c_html_abf44c96047cb51680ff358ad52747b93"><div class="ttname"><a href="avic_8c.html#abf44c96047cb51680ff358ad52747b93">avic_unaccel_trap_write</a></div><div class="ttdeci">static int avic_unaccel_trap_write(struct kvm_vcpu *vcpu)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00641">avic.c:641</a></div></div>
<div class="ttc" id="aavic_8c_html_ac41a57fe4f855076b5c5718def5bd6d3"><div class="ttname"><a href="avic_8c.html#ac41a57fe4f855076b5c5718def5bd6d3">avic_deactivate_vmcb</a></div><div class="ttdeci">static void avic_deactivate_vmcb(struct vcpu_svm *svm)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00120">avic.c:120</a></div></div>
<div class="ttc" id="aavic_8c_html_ac8c9ded2546dccf6e4b561e633d22e7e"><div class="ttname"><a href="avic_8c.html#ac8c9ded2546dccf6e4b561e633d22e7e">avic_ring_doorbell</a></div><div class="ttdeci">void avic_ring_doorbell(struct kvm_vcpu *vcpu)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00321">avic.c:321</a></div></div>
<div class="ttc" id="aavic_8c_html_ad4c0ba70ab315cedbb11f259b1d7ae08"><div class="ttname"><a href="avic_8c.html#ad4c0ba70ab315cedbb11f259b1d7ae08">x2avic_enabled</a></div><div class="ttdeci">bool x2avic_enabled</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00075">avic.c:75</a></div></div>
<div class="ttc" id="aavic_8c_html_ad9345a779111a59de8fa4110106c3adf"><div class="ttname"><a href="avic_8c.html#ad9345a779111a59de8fa4110106c3adf">avic_kick_target_vcpus</a></div><div class="ttdeci">static void avic_kick_target_vcpus(struct kvm *kvm, struct kvm_lapic *source, u32 icrl, u32 icrh, u32 index)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00465">avic.c:465</a></div></div>
<div class="ttc" id="aavic_8c_html_ada833d2b35b3e565a6900b25d1cce7c7"><div class="ttname"><a href="avic_8c.html#ada833d2b35b3e565a6900b25d1cce7c7">avic_hardware_setup</a></div><div class="ttdeci">bool avic_hardware_setup(void)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l01188">avic.c:1188</a></div></div>
<div class="ttc" id="aavic_8c_html_ae9f162404fdb37bba372d0c9cdc043ee"><div class="ttname"><a href="avic_8c.html#ae9f162404fdb37bba372d0c9cdc043ee">avic_apicv_post_state_restore</a></div><div class="ttdeci">void avic_apicv_post_state_restore(struct kvm_vcpu *vcpu)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00738">avic.c:738</a></div></div>
<div class="ttc" id="aavic_8c_html_aebb4737cca7862427a4b94f3f086dee3"><div class="ttname"><a href="avic_8c.html#aebb4737cca7862427a4b94f3f086dee3">next_vm_id</a></div><div class="ttdeci">static u32 next_vm_id</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00072">avic.c:72</a></div></div>
<div class="ttc" id="aavic_8c_html_aed65a2dabdad6a421b487e1e7b106277"><div class="ttname"><a href="avic_8c.html#aed65a2dabdad6a421b487e1e7b106277">avic_vcpu_get_apicv_inhibit_reasons</a></div><div class="ttdeci">unsigned long avic_vcpu_get_apicv_inhibit_reasons(struct kvm_vcpu *vcpu)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00542">avic.c:542</a></div></div>
<div class="ttc" id="aavic_8c_html_aefc63eafb35c1efd94f6d53e7d0b20d5"><div class="ttname"><a href="avic_8c.html#aefc63eafb35c1efd94f6d53e7d0b20d5">avic_init_backing_page</a></div><div class="ttdeci">static int avic_init_backing_page(struct kvm_vcpu *vcpu)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00277">avic.c:277</a></div></div>
<div class="ttc" id="aavic_8c_html_af75098185942f8eb5703b2b65bf9257d"><div class="ttname"><a href="avic_8c.html#af75098185942f8eb5703b2b65bf9257d">avic_ga_log_notifier</a></div><div class="ttdeci">int avic_ga_log_notifier(u32 ga_tag)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00143">avic.c:143</a></div></div>
<div class="ttc" id="aavic_8c_html_affcdeac6765016e970e33d6ecff3eebb"><div class="ttname"><a href="avic_8c.html#affcdeac6765016e970e33d6ecff3eebb">avic_refresh_apicv_exec_ctrl</a></div><div class="ttdeci">void avic_refresh_apicv_exec_ctrl(struct kvm_vcpu *vcpu)</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l01136">avic.c:1136</a></div></div>
<div class="ttc" id="airq_8h_html"><div class="ttname"><a href="irq_8h.html">irq.h</a></div></div>
<div class="ttc" id="airq_8h_html_a96951e3a1bfa402d8bee67713e267b39"><div class="ttname"><a href="irq_8h.html#a96951e3a1bfa402d8bee67713e267b39">irqchip_in_kernel</a></div><div class="ttdeci">static int irqchip_in_kernel(struct kvm *kvm)</div><div class="ttdef"><b>Definition:</b> <a href="irq_8h_source.html#l00090">irq.h:90</a></div></div>
<div class="ttc" id="airq__comm_8c_html_a6270cddb139f2ca4f42d21f8caaa1224"><div class="ttname"><a href="irq__comm_8c.html#a6270cddb139f2ca4f42d21f8caaa1224">kvm_set_msi_irq</a></div><div class="ttdeci">void kvm_set_msi_irq(struct kvm *kvm, struct kvm_kernel_irq_routing_entry *e, struct kvm_lapic_irq *irq)</div><div class="ttdef"><b>Definition:</b> <a href="irq__comm_8c_source.html#l00104">irq_comm.c:104</a></div></div>
<div class="ttc" id="airq__comm_8c_html_a6de5d9a13302fceb034b8d75b4c787e2"><div class="ttname"><a href="irq__comm_8c.html#a6de5d9a13302fceb034b8d75b4c787e2">kvm_intr_is_single_vcpu</a></div><div class="ttdeci">bool kvm_intr_is_single_vcpu(struct kvm *kvm, struct kvm_lapic_irq *irq, struct kvm_vcpu **dest_vcpu)</div><div class="ttdef"><b>Definition:</b> <a href="irq__comm_8c_source.html#l00338">irq_comm.c:338</a></div></div>
<div class="ttc" id="akvm__cache__regs_8h_html_afbcfc413ceedb460734eb5fd7c5c4fbc"><div class="ttname"><a href="kvm__cache__regs_8h.html#afbcfc413ceedb460734eb5fd7c5c4fbc">is_guest_mode</a></div><div class="ttdeci">static bool is_guest_mode(struct kvm_vcpu *vcpu)</div><div class="ttdef"><b>Definition:</b> <a href="kvm__cache__regs_8h_source.html#l00226">kvm_cache_regs.h:226</a></div></div>
<div class="ttc" id="akvm__main_8c_html_ad9f0140eebcdef9a9ebae54431d2fba5"><div class="ttname"><a href="kvm__main_8c.html#ad9f0140eebcdef9a9ebae54431d2fba5">kvm_vcpu_wake_up</a></div><div class="ttdeci">bool kvm_vcpu_wake_up(struct kvm_vcpu *vcpu)</div><div class="ttdef"><b>Definition:</b> <a href="kvm__main_8c_source.html#l03915">kvm_main.c:3915</a></div></div>
<div class="ttc" id="alapic_8c_html_a1b33bb5758d3dd75c7b87e537a5e729e"><div class="ttname"><a href="lapic_8c.html#a1b33bb5758d3dd75c7b87e537a5e729e">kvm_apic_write_nodecode</a></div><div class="ttdeci">void kvm_apic_write_nodecode(struct kvm_vcpu *vcpu, u32 offset)</div><div class="ttdef"><b>Definition:</b> <a href="lapic_8c_source.html#l02446">lapic.c:2446</a></div></div>
<div class="ttc" id="alapic_8c_html_a4b7f12cb3ba68245df79bc30d938b728"><div class="ttname"><a href="lapic_8c.html#a4b7f12cb3ba68245df79bc30d938b728">kvm_apic_send_ipi</a></div><div class="ttdeci">void kvm_apic_send_ipi(struct kvm_lapic *apic, u32 icr_low, u32 icr_high)</div><div class="ttdef"><b>Definition:</b> <a href="lapic_8c_source.html#l01504">lapic.c:1504</a></div></div>
<div class="ttc" id="alapic_8c_html_a8c6616d2cbae35632aa5debb15b552ec"><div class="ttname"><a href="lapic_8c.html#a8c6616d2cbae35632aa5debb15b552ec">kvm_alloc_apic_access_page</a></div><div class="ttdeci">int kvm_alloc_apic_access_page(struct kvm *kvm)</div><div class="ttdef"><b>Definition:</b> <a href="lapic_8c_source.html#l02598">lapic.c:2598</a></div></div>
<div class="ttc" id="alapic_8c_html_adb63e5a650d4571316b450d153a3105d"><div class="ttname"><a href="lapic_8c.html#adb63e5a650d4571316b450d153a3105d">kvm_apic_match_dest</a></div><div class="ttdeci">bool kvm_apic_match_dest(struct kvm_vcpu *vcpu, struct kvm_lapic *source, int shorthand, unsigned int dest, int dest_mode)</div><div class="ttdef"><b>Definition:</b> <a href="lapic_8c_source.html#l01067">lapic.c:1067</a></div></div>
<div class="ttc" id="alapic_8h_html"><div class="ttname"><a href="lapic_8h.html">lapic.h</a></div></div>
<div class="ttc" id="alapic_8h_html_a07d3e1e4090a62753325dfa11d232cea"><div class="ttname"><a href="lapic_8h.html#a07d3e1e4090a62753325dfa11d232cea">apic_x2apic_mode</a></div><div class="ttdeci">static int apic_x2apic_mode(struct kvm_lapic *apic)</div><div class="ttdef"><b>Definition:</b> <a href="lapic_8h_source.html#l00221">lapic.h:221</a></div></div>
<div class="ttc" id="alapic_8h_html_a1d8c9378fcbf62390a89dc3b7f0bdbd4"><div class="ttname"><a href="lapic_8h.html#a1d8c9378fcbf62390a89dc3b7f0bdbd4">lapic_in_kernel</a></div><div class="ttdeci">static bool lapic_in_kernel(struct kvm_vcpu *vcpu)</div><div class="ttdef"><b>Definition:</b> <a href="lapic_8h_source.html#l00186">lapic.h:186</a></div></div>
<div class="ttc" id="alapic_8h_html_a3af346d02eebff16886d49d3810b5358"><div class="ttname"><a href="lapic_8h.html#a3af346d02eebff16886d49d3810b5358">kvm_vcpu_apicv_active</a></div><div class="ttdeci">static bool kvm_vcpu_apicv_active(struct kvm_vcpu *vcpu)</div><div class="ttdef"><b>Definition:</b> <a href="lapic_8h_source.html#l00226">lapic.h:226</a></div></div>
<div class="ttc" id="alapic_8h_html_a481da2cdd19d996fb0378476375133c6"><div class="ttname"><a href="lapic_8h.html#a481da2cdd19d996fb0378476375133c6">X2APIC_BROADCAST</a></div><div class="ttdeci">#define X2APIC_BROADCAST</div><div class="ttdef"><b>Definition:</b> <a href="lapic_8h_source.html#l00023">lapic.h:23</a></div></div>
<div class="ttc" id="alapic_8h_html_a4f07303d20a06eeb408d4985c5e15096"><div class="ttname"><a href="lapic_8h.html#a4f07303d20a06eeb408d4985c5e15096">kvm_xapic_id</a></div><div class="ttdeci">static u8 kvm_xapic_id(struct kvm_lapic *apic)</div><div class="ttdef"><b>Definition:</b> <a href="lapic_8h_source.html#l00276">lapic.h:276</a></div></div>
<div class="ttc" id="alapic_8h_html_a5e58cf75a31cd26e03db7f201861a8e4"><div class="ttname"><a href="lapic_8h.html#a5e58cf75a31cd26e03db7f201861a8e4">APIC_DEST_MASK</a></div><div class="ttdeci">#define APIC_DEST_MASK</div><div class="ttdef"><b>Definition:</b> <a href="lapic_8h_source.html#l00017">lapic.h:17</a></div></div>
<div class="ttc" id="alapic_8h_html_a8cd1df8b4c079c23a522d09c964da0ee"><div class="ttname"><a href="lapic_8h.html#a8cd1df8b4c079c23a522d09c964da0ee">kvm_lapic_get_reg</a></div><div class="ttdeci">static u32 kvm_lapic_get_reg(struct kvm_lapic *apic, int reg_off)</div><div class="ttdef"><b>Definition:</b> <a href="lapic_8h_source.html#l00179">lapic.h:179</a></div></div>
<div class="ttc" id="alapic_8h_html_a8e368c4d317e2f3289d8287fc28c4d19"><div class="ttname"><a href="lapic_8h.html#a8e368c4d317e2f3289d8287fc28c4d19">APIC_BROADCAST</a></div><div class="ttdeci">#define APIC_BROADCAST</div><div class="ttdef"><b>Definition:</b> <a href="lapic_8h_source.html#l00022">lapic.h:22</a></div></div>
<div class="ttc" id="alapic_8h_html_acc73bace457403e7d23ff22afac7df0f"><div class="ttname"><a href="lapic_8h.html#acc73bace457403e7d23ff22afac7df0f">APIC_DEST_NOSHORT</a></div><div class="ttdeci">#define APIC_DEST_NOSHORT</div><div class="ttdef"><b>Definition:</b> <a href="lapic_8h_source.html#l00016">lapic.h:16</a></div></div>
<div class="ttc" id="alapic_8h_html_ad3b78bd2ddd9b9b15390755b6df98d3d"><div class="ttname"><a href="lapic_8h.html#ad3b78bd2ddd9b9b15390755b6df98d3d">APIC_SHORT_MASK</a></div><div class="ttdeci">#define APIC_SHORT_MASK</div><div class="ttdef"><b>Definition:</b> <a href="lapic_8h_source.html#l00015">lapic.h:15</a></div></div>
<div class="ttc" id="astructamd__svm__iommu__ir_html"><div class="ttname"><a href="structamd__svm__iommu__ir.html">amd_svm_iommu_ir</a></div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00080">avic.c:80</a></div></div>
<div class="ttc" id="astructamd__svm__iommu__ir_html_a54d6bf7341caaad5d37469694a4bd434"><div class="ttname"><a href="structamd__svm__iommu__ir.html#a54d6bf7341caaad5d37469694a4bd434">amd_svm_iommu_ir::node</a></div><div class="ttdeci">struct list_head node</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l01188">avic.c:81</a></div></div>
<div class="ttc" id="astructamd__svm__iommu__ir_html_ad1d0011f27de4fbde266e0ce65476e84"><div class="ttname"><a href="structamd__svm__iommu__ir.html#ad1d0011f27de4fbde266e0ce65476e84">amd_svm_iommu_ir::data</a></div><div class="ttdeci">void * data</div><div class="ttdef"><b>Definition:</b> <a href="avic_8c_source.html#l00082">avic.c:82</a></div></div>
<div class="ttc" id="astructkvm__lapic_html"><div class="ttname"><a href="structkvm__lapic.html">kvm_lapic</a></div><div class="ttdef"><b>Definition:</b> <a href="lapic_8h_source.html#l00059">lapic.h:59</a></div></div>
<div class="ttc" id="astructkvm__lapic_html_a54741597d07b2792d2da72ea301ad648"><div class="ttname"><a href="structkvm__lapic.html#a54741597d07b2792d2da72ea301ad648">kvm_lapic::vcpu</a></div><div class="ttdeci">struct kvm_vcpu * vcpu</div><div class="ttdef"><b>Definition:</b> <a href="lapic_8h_source.html#l00064">lapic.h:64</a></div></div>
<div class="ttc" id="astructkvm__svm_html"><div class="ttname"><a href="structkvm__svm.html">kvm_svm</a></div><div class="ttdef"><b>Definition:</b> <a href="svm_8h_source.html#l00095">svm.h:95</a></div></div>
<div class="ttc" id="astructkvm__svm_html_a06c4479d5aefb8c19b8ead15d599b324"><div class="ttname"><a href="structkvm__svm.html#a06c4479d5aefb8c19b8ead15d599b324">kvm_svm::avic_vm_id</a></div><div class="ttdeci">u32 avic_vm_id</div><div class="ttdef"><b>Definition:</b> <a href="svm_8h_source.html#l00099">svm.h:99</a></div></div>
<div class="ttc" id="astructkvm__svm_html_a4f8eab5b98a43c0a7402d15663d4e032"><div class="ttname"><a href="structkvm__svm.html#a4f8eab5b98a43c0a7402d15663d4e032">kvm_svm::hnode</a></div><div class="ttdeci">struct hlist_node hnode</div><div class="ttdef"><b>Definition:</b> <a href="svm_8h_source.html#l00101">svm.h:102</a></div></div>
<div class="ttc" id="astructkvm__svm_html_a837dca12e3d1d7b768feb04c6a3c2e96"><div class="ttname"><a href="structkvm__svm.html#a837dca12e3d1d7b768feb04c6a3c2e96">kvm_svm::avic_logical_id_table_page</a></div><div class="ttdeci">struct page * avic_logical_id_table_page</div><div class="ttdef"><b>Definition:</b> <a href="svm_8h_source.html#l00100">svm.h:100</a></div></div>
<div class="ttc" id="astructkvm__svm_html_aa05522988cc0a3ce6ad59dcec1ed0c46"><div class="ttname"><a href="structkvm__svm.html#aa05522988cc0a3ce6ad59dcec1ed0c46">kvm_svm::avic_physical_id_table_page</a></div><div class="ttdeci">struct page * avic_physical_id_table_page</div><div class="ttdef"><b>Definition:</b> <a href="svm_8h_source.html#l00101">svm.h:101</a></div></div>
<div class="ttc" id="astructkvm__svm_html_ade6c6ec6e820a10719c5d61e161aa8b8"><div class="ttname"><a href="structkvm__svm.html#ade6c6ec6e820a10719c5d61e161aa8b8">kvm_svm::kvm</a></div><div class="ttdeci">struct kvm kvm</div><div class="ttdef"><b>Definition:</b> <a href="svm_8h_source.html#l00092">svm.h:96</a></div></div>
<div class="ttc" id="astructkvm__vmcb__info_html_a8076921f239564576af7af19be7f6f04"><div class="ttname"><a href="structkvm__vmcb__info.html#a8076921f239564576af7af19be7f6f04">kvm_vmcb_info::ptr</a></div><div class="ttdeci">struct vmcb * ptr</div><div class="ttdef"><b>Definition:</b> <a href="svm_8h_source.html#l00110">svm.h:110</a></div></div>
<div class="ttc" id="astructsvm__nested__state_html_a3b275e369200f402f9d5765babb77629"><div class="ttname"><a href="structsvm__nested__state.html#a3b275e369200f402f9d5765babb77629">svm_nested_state::ctl</a></div><div class="ttdeci">struct vmcb_ctrl_area_cached ctl</div><div class="ttdef"><b>Definition:</b> <a href="svm_8h_source.html#l00170">svm.h:173</a></div></div>
<div class="ttc" id="astructvcpu__svm_html"><div class="ttname"><a href="structvcpu__svm.html">vcpu_svm</a></div><div class="ttdef"><b>Definition:</b> <a href="svm_8h_source.html#l00209">svm.h:209</a></div></div>
<div class="ttc" id="astructvcpu__svm_html_a250d72e13c39c0c6d85a5e6c188554ce"><div class="ttname"><a href="structvcpu__svm.html#a250d72e13c39c0c6d85a5e6c188554ce">vcpu_svm::ldr_reg</a></div><div class="ttdeci">u32 ldr_reg</div><div class="ttdef"><b>Definition:</b> <a href="svm_8h_source.html#l00267">svm.h:267</a></div></div>
<div class="ttc" id="astructvcpu__svm_html_a2c8b33d5ae9b731a886634cd6c00165f"><div class="ttname"><a href="structvcpu__svm.html#a2c8b33d5ae9b731a886634cd6c00165f">vcpu_svm::avic_backing_page</a></div><div class="ttdeci">struct page * avic_backing_page</div><div class="ttdef"><b>Definition:</b> <a href="svm_8h_source.html#l00269">svm.h:269</a></div></div>
<div class="ttc" id="astructvcpu__svm_html_aa2e4d643ef957cd597e82a29f0f0a2c8"><div class="ttname"><a href="structvcpu__svm.html#aa2e4d643ef957cd597e82a29f0f0a2c8">vcpu_svm::nested</a></div><div class="ttdeci">struct svm_nested_state nested</div><div class="ttdef"><b>Definition:</b> <a href="svm_8h_source.html#l00236">svm.h:238</a></div></div>
<div class="ttc" id="astructvcpu__svm_html_abc377a3a5f1f42e18f8a9044321f3d5b"><div class="ttname"><a href="structvcpu__svm.html#abc377a3a5f1f42e18f8a9044321f3d5b">vcpu_svm::avic_physical_id_cache</a></div><div class="ttdeci">u64 * avic_physical_id_cache</div><div class="ttdef"><b>Definition:</b> <a href="svm_8h_source.html#l00270">svm.h:270</a></div></div>
<div class="ttc" id="astructvcpu__svm_html_ae08ffe38b03c1c44686c57c274553f59"><div class="ttname"><a href="structvcpu__svm.html#ae08ffe38b03c1c44686c57c274553f59">vcpu_svm::dfr_reg</a></div><div class="ttdeci">u32 dfr_reg</div><div class="ttdef"><b>Definition:</b> <a href="svm_8h_source.html#l00268">svm.h:268</a></div></div>
<div class="ttc" id="astructvcpu__svm_html_af095ed7bcc31c036e28e533582723a60"><div class="ttname"><a href="structvcpu__svm.html#af095ed7bcc31c036e28e533582723a60">vcpu_svm::vmcb</a></div><div class="ttdeci">struct vmcb * vmcb</div><div class="ttdef"><b>Definition:</b> <a href="svm_8h_source.html#l00212">svm.h:212</a></div></div>
<div class="ttc" id="astructvcpu__svm_html_af0c24755d59a0cfca7ce9ba64f682722"><div class="ttname"><a href="structvcpu__svm.html#af0c24755d59a0cfca7ce9ba64f682722">vcpu_svm::vmcb01</a></div><div class="ttdeci">struct kvm_vmcb_info vmcb01</div><div class="ttdef"><b>Definition:</b> <a href="svm_8h_source.html#l00212">svm.h:213</a></div></div>
<div class="ttc" id="astructvcpu__svm_html_af164d8d741d9ea90dae6a46974d29f9e"><div class="ttname"><a href="structvcpu__svm.html#af164d8d741d9ea90dae6a46974d29f9e">vcpu_svm::vcpu</a></div><div class="ttdeci">struct kvm_vcpu vcpu</div><div class="ttdef"><b>Definition:</b> <a href="svm_8h_source.html#l00206">svm.h:210</a></div></div>
<div class="ttc" id="astructvcpu__svm_html_af217181f505db1b71c48743233032539"><div class="ttname"><a href="structvcpu__svm.html#af217181f505db1b71c48743233032539">vcpu_svm::ir_list</a></div><div class="ttdeci">struct list_head ir_list</div><div class="ttdef"><b>Definition:</b> <a href="svm_8h_source.html#l00270">svm.h:278</a></div></div>
<div class="ttc" id="astructvcpu__svm_html_af38f3c63a81a10aae69b308aa175d618"><div class="ttname"><a href="structvcpu__svm.html#af38f3c63a81a10aae69b308aa175d618">vcpu_svm::ir_list_lock</a></div><div class="ttdeci">spinlock_t ir_list_lock</div><div class="ttdef"><b>Definition:</b> <a href="svm_8h_source.html#l00279">svm.h:279</a></div></div>
<div class="ttc" id="asvm_8c_html_a17a219d0651f1db709a3af0fc5527aa0"><div class="ttname"><a href="svm_8c.html#a17a219d0651f1db709a3af0fc5527aa0">npt_enabled</a></div><div class="ttdeci">bool npt_enabled</div><div class="ttdef"><b>Definition:</b> <a href="svm_8c_source.html#l00198">svm.c:198</a></div></div>
<div class="ttc" id="asvm_8c_html_a195738d23c6f6b6bf7269334d3a38721"><div class="ttname"><a href="svm_8c.html#a195738d23c6f6b6bf7269334d3a38721">svm_set_x2apic_msr_interception</a></div><div class="ttdeci">void svm_set_x2apic_msr_interception(struct vcpu_svm *svm, bool intercept)</div><div class="ttdef"><b>Definition:</b> <a href="svm_8c_source.html#l00892">svm.c:892</a></div></div>
<div class="ttc" id="asvm_8c_html_a1faf261e116f9d9481e1bd6796e32280"><div class="ttname"><a href="svm_8c.html#a1faf261e116f9d9481e1bd6796e32280">svm_complete_interrupt_delivery</a></div><div class="ttdeci">void svm_complete_interrupt_delivery(struct kvm_vcpu *vcpu, int delivery_mode, int trig_mode, int vector)</div><div class="ttdef"><b>Definition:</b> <a href="svm_8c_source.html#l03633">svm.c:3633</a></div></div>
<div class="ttc" id="asvm_8h_html"><div class="ttname"><a href="svm_8h.html">svm.h</a></div></div>
<div class="ttc" id="asvm_8h_html_a39fca1837c5ce7715cbf571669660c13a3d33483aba8bab1af6c7a3a56141cd8f"><div class="ttname"><a href="svm_8h.html#a39fca1837c5ce7715cbf571669660c13a3d33483aba8bab1af6c7a3a56141cd8f">VMCB_AVIC</a></div><div class="ttdeci">@ VMCB_AVIC</div><div class="ttdef"><b>Definition:</b> <a href="svm_8h_source.html#l00061">svm.h:61</a></div></div>
<div class="ttc" id="asvm_8h_html_a5deff43556f8c807c64def073cd548e4"><div class="ttname"><a href="svm_8h.html#a5deff43556f8c807c64def073cd548e4">vmcb12_is_intercept</a></div><div class="ttdeci">static bool vmcb12_is_intercept(struct vmcb_ctrl_area_cached *control, u32 bit)</div><div class="ttdef"><b>Definition:</b> <a href="svm_8h_source.html#l00397">svm.h:397</a></div></div>
<div class="ttc" id="asvm_8h_html_a83e420c88631faf9613ea3caa72c63b7"><div class="ttname"><a href="svm_8h.html#a83e420c88631faf9613ea3caa72c63b7">to_svm</a></div><div class="ttdeci">static __always_inline struct vcpu_svm * to_svm(struct kvm_vcpu *vcpu)</div><div class="ttdef"><b>Definition:</b> <a href="svm_8h_source.html#l00364">svm.h:364</a></div></div>
<div class="ttc" id="asvm_8h_html_ab83edec724698a20d66a086a1900aa27"><div class="ttname"><a href="svm_8h.html#ab83edec724698a20d66a086a1900aa27">vmcb_mark_dirty</a></div><div class="ttdeci">static void vmcb_mark_dirty(struct vmcb *vmcb, int bit)</div><div class="ttdef"><b>Definition:</b> <a href="svm_8h_source.html#l00354">svm.h:354</a></div></div>
<div class="ttc" id="asvm_8h_html_ac27f6fe2ff4beeb5ad1b11681d0386fd"><div class="ttname"><a href="svm_8h.html#ac27f6fe2ff4beeb5ad1b11681d0386fd">to_kvm_svm</a></div><div class="ttdeci">static __always_inline struct kvm_svm * to_kvm_svm(struct kvm *kvm)</div><div class="ttdef"><b>Definition:</b> <a href="svm_8h_source.html#l00316">svm.h:316</a></div></div>
<div class="ttc" id="atrace_8h_html"><div class="ttname"><a href="trace_8h.html">trace.h</a></div></div>
<div class="ttc" id="ax86_8c_html_a04af9ab3eee510b54cba17a6fa94ee04"><div class="ttname"><a href="x86_8c.html#a04af9ab3eee510b54cba17a6fa94ee04">enable_apicv</a></div><div class="ttdeci">bool __read_mostly enable_apicv</div><div class="ttdef"><b>Definition:</b> <a href="x86_8c_source.html#l00235">x86.c:235</a></div></div>
<div class="ttc" id="ax86_8c_html_a117738c7e069e71d58ab48a581bfc646"><div class="ttname"><a href="x86_8c.html#a117738c7e069e71d58ab48a581bfc646">kvm_emulate_instruction</a></div><div class="ttdeci">int kvm_emulate_instruction(struct kvm_vcpu *vcpu, int emulation_type)</div><div class="ttdef"><b>Definition:</b> <a href="x86_8c_source.html#l09262">x86.c:9262</a></div></div>
<div class="ttc" id="ax86_8c_html_a21212b8e1a82cdc8ac696137981d8d7a"><div class="ttname"><a href="x86_8c.html#a21212b8e1a82cdc8ac696137981d8d7a">kvm_apicv_activated</a></div><div class="ttdeci">bool kvm_apicv_activated(struct kvm *kvm)</div><div class="ttdef"><b>Definition:</b> <a href="x86_8c_source.html#l09935">x86.c:9935</a></div></div>
<div class="ttc" id="ax86_8c_html_ae63567e9b665b34f8c84fc4dc594f3c8"><div class="ttname"><a href="x86_8c.html#ae63567e9b665b34f8c84fc4dc594f3c8">kvm_arch_has_assigned_device</a></div><div class="ttdeci">bool noinstr kvm_arch_has_assigned_device(struct kvm *kvm)</div><div class="ttdef"><b>Definition:</b> <a href="x86_8c_source.html#l13419">x86.c:13419</a></div></div>
<div class="ttc" id="ax86_8h_html"><div class="ttname"><a href="x86_8h.html">x86.h</a></div></div>
<div class="ttc" id="axen_8c_html_a773b39d480759f67926cb18ae2219281"><div class="ttname"><a href="xen_8c.html#a773b39d480759f67926cb18ae2219281">flags</a></div><div class="ttdeci">uint32_t flags</div><div class="ttdef"><b>Definition:</b> <a href="xen_8c_source.html#l00001">xen.c:1</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
