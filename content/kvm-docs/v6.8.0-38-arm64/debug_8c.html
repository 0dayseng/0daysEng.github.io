<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>KVM: arch/arm64/kvm/debug.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">KVM
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_ea9599923402ca8ab47fc3e495999dea.html">arch</a></li><li class="navelem"><a class="el" href="dir_67a9e021ce8db5d46236c6154ee454bc.html">arm64</a></li><li class="navelem"><a class="el" href="dir_42f87ef63ac4150166bf7887f68288e2.html">kvm</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">debug.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;linux/kvm_host.h&gt;</code><br />
<code>#include &lt;linux/hw_breakpoint.h&gt;</code><br />
<code>#include &lt;asm/debug-monitors.h&gt;</code><br />
<code>#include &lt;asm/kvm_asm.h&gt;</code><br />
<code>#include &lt;asm/kvm_arm.h&gt;</code><br />
<code>#include &lt;asm/kvm_emulate.h&gt;</code><br />
<code>#include &quot;<a class="el" href="trace_8h_source.html">trace.h</a>&quot;</code><br />
</div><div class="textblock"><div class="dynheader">
Include dependency graph for debug.c:</div>
<div class="dyncontent">
<div class="center"><img src="debug_8c__incl.png" border="0" usemap="#aarch_2arm64_2kvm_2debug_8c" alt=""/></div>
<map name="aarch_2arm64_2kvm_2debug_8c" id="aarch_2arm64_2kvm_2debug_8c">
<area shape="rect" title=" " alt="" coords="522,5,706,32"/>
<area shape="rect" title=" " alt="" coords="5,80,140,107"/>
<area shape="rect" title=" " alt="" coords="164,80,331,107"/>
<area shape="rect" title=" " alt="" coords="355,80,524,107"/>
<area shape="rect" title=" " alt="" coords="549,80,679,107"/>
<area shape="rect" title=" " alt="" coords="703,80,831,107"/>
<area shape="rect" title=" " alt="" coords="728,229,884,256"/>
<area shape="rect" href="trace_8h.html" title=" " alt="" coords="973,80,1039,107"/>
<area shape="rect" href="trace__arm_8h.html" title=" " alt="" coords="956,155,1056,181"/>
<area shape="rect" href="trace__handle__exit_8h.html" title=" " alt="" coords="1179,155,1329,181"/>
<area shape="rect" title=" " alt="" coords="908,229,1077,256"/>
<area shape="rect" title=" " alt="" coords="1102,229,1238,256"/>
<area shape="rect" title=" " alt="" coords="1263,229,1413,256"/>
<area shape="rect" href="sys__regs_8h.html" title=" " alt="" coords="1438,229,1529,256"/>
<area shape="rect" title=" " alt="" coords="1423,304,1544,331"/>
</map>
</div>
</div>
<p><a href="debug_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:a234cbb62ecfb110dafb6ec7753a212a5"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="debug_8c.html#a234cbb62ecfb110dafb6ec7753a212a5">MDSCR_EL1_DEBUG_MASK</a></td></tr>
<tr class="separator:a234cbb62ecfb110dafb6ec7753a212a5"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a4cb185e4a758f23464b2d77cf9af8cc6"><td class="memItemLeft" align="right" valign="top">static&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="debug_8c.html#a4cb185e4a758f23464b2d77cf9af8cc6">DEFINE_PER_CPU</a> (u64, mdcr_el2)</td></tr>
<tr class="separator:a4cb185e4a758f23464b2d77cf9af8cc6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8341c1ad3b486b6fbcec3681518f3d14"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="debug_8c.html#a8341c1ad3b486b6fbcec3681518f3d14">save_guest_debug_regs</a> (struct kvm_vcpu *vcpu)</td></tr>
<tr class="separator:a8341c1ad3b486b6fbcec3681518f3d14"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a33e80ad65049d17deebb0d5fbe7cc7da"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="debug_8c.html#a33e80ad65049d17deebb0d5fbe7cc7da">restore_guest_debug_regs</a> (struct kvm_vcpu *vcpu)</td></tr>
<tr class="separator:a33e80ad65049d17deebb0d5fbe7cc7da"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abd80e27913cd78849bff5e8f4f84c4f3"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="debug_8c.html#abd80e27913cd78849bff5e8f4f84c4f3">kvm_arm_init_debug</a> (void)</td></tr>
<tr class="separator:abd80e27913cd78849bff5e8f4f84c4f3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2623ab6af1e4a2daefd1808433477b84"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="debug_8c.html#a2623ab6af1e4a2daefd1808433477b84">kvm_arm_setup_mdcr_el2</a> (struct kvm_vcpu *vcpu)</td></tr>
<tr class="separator:a2623ab6af1e4a2daefd1808433477b84"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0cdd5b533e40bfb30ba62a5c9d8f52a2"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="debug_8c.html#a0cdd5b533e40bfb30ba62a5c9d8f52a2">kvm_arm_vcpu_init_debug</a> (struct kvm_vcpu *vcpu)</td></tr>
<tr class="separator:a0cdd5b533e40bfb30ba62a5c9d8f52a2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a160fda6c876743727468b5dfee21f0e3"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="debug_8c.html#a160fda6c876743727468b5dfee21f0e3">kvm_arm_reset_debug_ptr</a> (struct kvm_vcpu *vcpu)</td></tr>
<tr class="separator:a160fda6c876743727468b5dfee21f0e3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac5de7d8da7d4a0e7d01583f9bab9590b"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="debug_8c.html#ac5de7d8da7d4a0e7d01583f9bab9590b">kvm_arm_setup_debug</a> (struct kvm_vcpu *vcpu)</td></tr>
<tr class="separator:ac5de7d8da7d4a0e7d01583f9bab9590b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a55c5a83ff9f95fb9e6ae8fa50fa07d9a"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="debug_8c.html#a55c5a83ff9f95fb9e6ae8fa50fa07d9a">kvm_arm_clear_debug</a> (struct kvm_vcpu *vcpu)</td></tr>
<tr class="separator:a55c5a83ff9f95fb9e6ae8fa50fa07d9a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aae61f6ee77424b3eb0cb727586a694eb"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="debug_8c.html#aae61f6ee77424b3eb0cb727586a694eb">kvm_arch_vcpu_load_debug_state_flags</a> (struct kvm_vcpu *vcpu)</td></tr>
<tr class="separator:aae61f6ee77424b3eb0cb727586a694eb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a40ab178c06775c17444821f2b88d89c9"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="debug_8c.html#a40ab178c06775c17444821f2b88d89c9">kvm_arch_vcpu_put_debug_state_flags</a> (struct kvm_vcpu *vcpu)</td></tr>
<tr class="separator:a40ab178c06775c17444821f2b88d89c9"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Macro Definition Documentation</h2>
<a id="a234cbb62ecfb110dafb6ec7753a212a5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a234cbb62ecfb110dafb6ec7753a212a5">&#9670;&nbsp;</a></span>MDSCR_EL1_DEBUG_MASK</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define MDSCR_EL1_DEBUG_MASK</td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line">                (DBG_MDSCR_SS | \</div>
<div class="line">                DBG_MDSCR_KDE | \</div>
<div class="line">                DBG_MDSCR_MDE)</div>
</div><!-- fragment -->
<p class="definition">Definition at line <a class="el" href="debug_8c_source.html#l00020">20</a> of file <a class="el" href="debug_8c_source.html">debug.c</a>.</p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="a4cb185e4a758f23464b2d77cf9af8cc6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4cb185e4a758f23464b2d77cf9af8cc6">&#9670;&nbsp;</a></span>DEFINE_PER_CPU()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static DEFINE_PER_CPU </td>
          <td>(</td>
          <td class="paramtype">u64&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">mdcr_el2&#160;</td>
          <td class="paramname">&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

</div>
</div>
<a id="aae61f6ee77424b3eb0cb727586a694eb"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aae61f6ee77424b3eb0cb727586a694eb">&#9670;&nbsp;</a></span>kvm_arch_vcpu_load_debug_state_flags()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void kvm_arch_vcpu_load_debug_state_flags </td>
          <td>(</td>
          <td class="paramtype">struct kvm_vcpu *&#160;</td>
          <td class="paramname"><em>vcpu</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="debug_8c_source.html#l00317">317</a> of file <a class="el" href="debug_8c_source.html">debug.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;{</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;    u64 dfr0;</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160; </div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;    <span class="comment">/* For VHE, there is nothing to do */</span></div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;    <span class="keywordflow">if</span> (has_vhe())</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160; </div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;    dfr0 = read_sysreg(id_aa64dfr0_el1);</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;<span class="comment">     * If SPE is present on this CPU and is available at current EL,</span></div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;<span class="comment">     * we may need to check if the host state needs to be saved.</span></div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    <span class="keywordflow">if</span> (cpuid_feature_extract_unsigned_field(dfr0, ID_AA64DFR0_EL1_PMSVer_SHIFT) &amp;&amp;</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;        !(read_sysreg_s(SYS_PMBIDR_EL1) &amp; BIT(PMBIDR_EL1_P_SHIFT)))</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;        vcpu_set_flag(vcpu, DEBUG_STATE_SAVE_SPE);</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160; </div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;    <span class="comment">/* Check if we have TRBE implemented and available at the host */</span></div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    <span class="keywordflow">if</span> (cpuid_feature_extract_unsigned_field(dfr0, ID_AA64DFR0_EL1_TraceBuffer_SHIFT) &amp;&amp;</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;        !(read_sysreg_s(SYS_TRBIDR_EL1) &amp; TRBIDR_EL1_P))</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;        vcpu_set_flag(vcpu, DEBUG_STATE_SAVE_TRBE);</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="debug_8c_aae61f6ee77424b3eb0cb727586a694eb_icgraph.png" border="0" usemap="#adebug_8c_aae61f6ee77424b3eb0cb727586a694eb_icgraph" alt=""/></div>
<map name="adebug_8c_aae61f6ee77424b3eb0cb727586a694eb_icgraph" id="adebug_8c_aae61f6ee77424b3eb0cb727586a694eb_icgraph">
<area shape="rect" title=" " alt="" coords="1469,230,1628,271"/>
<area shape="rect" href="arm_8c.html#aaa51abf3d06fdaa95794b27f273278fb" title=" " alt="" coords="1263,237,1421,264"/>
<area shape="rect" href="emulate-nested_8c.html#a1920c02a997dd9975bec0ee02f6ae2c4" title=" " alt="" coords="825,31,1021,57"/>
<area shape="rect" href="emulate-nested_8c.html#a1c3e31bd85e9c0590a018ada20a5e4bf" title=" " alt="" coords="1069,136,1215,163"/>
<area shape="rect" href="reset_8c.html#a124698ccde953ff74d270ddd091fc3a9" title=" " alt="" coords="1077,237,1207,264"/>
<area shape="rect" href="kvm__main_8c.html#a31b6c41ce8eacbbdc56a276018989253" title=" " alt="" coords="1085,376,1199,403"/>
<area shape="rect" href="kvm__main_8c.html#a5dde35c5b74ce68a7dbb2f2006ce3e9e" title=" " alt="" coords="1098,300,1186,327"/>
<area shape="rect" href="handle__exit_8c.html#ae96aab7918301d55b908034db5855e3d" title=" " alt="" coords="617,5,751,32"/>
<area shape="rect" href="emulate-nested_8c.html#af5e2eb745d8ac6415fe941ebe754171d" title=" " alt="" coords="832,107,1015,133"/>
<area shape="rect" href="emulate-nested_8c.html#a5759b383dbf067b5e90235d5fd032ab5" title=" " alt="" coords="597,157,771,184"/>
<area shape="rect" href="handle__exit_8c.html#a5c24d46393da9651d3133e2377fd7a69" title=" " alt="" coords="636,56,732,83"/>
<area shape="rect" href="handle__exit_8c.html#aeaf983f5c40202edc8b07a76603330cd" title=" " alt="" coords="637,107,731,133"/>
<area shape="rect" href="sys__regs_8c.html#a315e661b6f1cb224596267000909a1ac" title=" " alt="" coords="384,145,543,172"/>
<area shape="rect" href="arm_8c.html#ae1c5fe27678796057c4ea914a9a6897b" title=" " alt="" coords="835,161,1011,188"/>
<area shape="rect" href="arm_8c.html#a91790a6a024c83b103717f37a8f0f504" title=" " alt="" coords="603,208,765,235"/>
<area shape="rect" href="arm_8c.html#ab4ac4d44dfa1ed8985130249d6a8385e" title=" " alt="" coords="177,263,336,289"/>
<area shape="rect" href="arm_8c.html#a05fa4e97677ca3190089071bfce82825" title=" " alt="" coords="843,313,1004,340"/>
<area shape="rect" href="arm_8c.html#ad66c8d00e8adc8315c45170fa270304b" title=" " alt="" coords="384,197,543,238"/>
<area shape="rect" href="kvm__main_8c.html#a2f2d3734c4cf61a1f4f94e9d47c37d55" title=" " alt="" coords="5,288,129,315"/>
<area shape="rect" href="arm_8c.html#adbabb8b4e50c9c51eec6373fcbc833aa" title=" " alt="" coords="591,313,777,340"/>
<area shape="rect" href="kvm__main_8c.html#a2372c616bc55bc4cd3446660cb7322fc" title=" " alt="" coords="884,415,963,441"/>
<area shape="rect" href="arm_8c.html#a625df4221f73b13d9f23aa818f60e547" title=" " alt="" coords="628,415,740,441"/>
</map>
</div>

</div>
</div>
<a id="a40ab178c06775c17444821f2b88d89c9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a40ab178c06775c17444821f2b88d89c9">&#9670;&nbsp;</a></span>kvm_arch_vcpu_put_debug_state_flags()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void kvm_arch_vcpu_put_debug_state_flags </td>
          <td>(</td>
          <td class="paramtype">struct kvm_vcpu *&#160;</td>
          <td class="paramname"><em>vcpu</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="debug_8c_source.html#l00340">340</a> of file <a class="el" href="debug_8c_source.html">debug.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;{</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;    vcpu_clear_flag(vcpu, DEBUG_STATE_SAVE_SPE);</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    vcpu_clear_flag(vcpu, DEBUG_STATE_SAVE_TRBE);</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="debug_8c_a40ab178c06775c17444821f2b88d89c9_icgraph.png" border="0" usemap="#adebug_8c_a40ab178c06775c17444821f2b88d89c9_icgraph" alt=""/></div>
<map name="adebug_8c_a40ab178c06775c17444821f2b88d89c9_icgraph" id="adebug_8c_a40ab178c06775c17444821f2b88d89c9_icgraph">
<area shape="rect" title=" " alt="" coords="1463,230,1661,271"/>
<area shape="rect" href="arm_8c.html#a9235365ce64f215b1e024f26d96537cc" title=" " alt="" coords="1263,237,1415,264"/>
<area shape="rect" href="emulate-nested_8c.html#a1920c02a997dd9975bec0ee02f6ae2c4" title=" " alt="" coords="825,31,1021,57"/>
<area shape="rect" href="emulate-nested_8c.html#a1c3e31bd85e9c0590a018ada20a5e4bf" title=" " alt="" coords="1069,136,1215,163"/>
<area shape="rect" href="reset_8c.html#a124698ccde953ff74d270ddd091fc3a9" title=" " alt="" coords="1077,237,1207,264"/>
<area shape="rect" href="kvm__main_8c.html#a5f5097640155787fc088aa47b94da0a7" title=" " alt="" coords="1080,376,1204,403"/>
<area shape="rect" href="kvm__main_8c.html#a16e0f63dd5f0d556ed1c9c9999256f85" title=" " alt="" coords="1101,300,1183,327"/>
<area shape="rect" href="handle__exit_8c.html#ae96aab7918301d55b908034db5855e3d" title=" " alt="" coords="617,5,751,32"/>
<area shape="rect" href="emulate-nested_8c.html#af5e2eb745d8ac6415fe941ebe754171d" title=" " alt="" coords="832,107,1015,133"/>
<area shape="rect" href="emulate-nested_8c.html#a5759b383dbf067b5e90235d5fd032ab5" title=" " alt="" coords="597,157,771,184"/>
<area shape="rect" href="handle__exit_8c.html#a5c24d46393da9651d3133e2377fd7a69" title=" " alt="" coords="636,56,732,83"/>
<area shape="rect" href="handle__exit_8c.html#aeaf983f5c40202edc8b07a76603330cd" title=" " alt="" coords="637,107,731,133"/>
<area shape="rect" href="sys__regs_8c.html#a315e661b6f1cb224596267000909a1ac" title=" " alt="" coords="384,145,543,172"/>
<area shape="rect" href="arm_8c.html#ae1c5fe27678796057c4ea914a9a6897b" title=" " alt="" coords="835,161,1011,188"/>
<area shape="rect" href="arm_8c.html#a91790a6a024c83b103717f37a8f0f504" title=" " alt="" coords="603,208,765,235"/>
<area shape="rect" href="arm_8c.html#ab4ac4d44dfa1ed8985130249d6a8385e" title=" " alt="" coords="177,263,336,289"/>
<area shape="rect" href="arm_8c.html#a05fa4e97677ca3190089071bfce82825" title=" " alt="" coords="843,313,1004,340"/>
<area shape="rect" href="arm_8c.html#ad66c8d00e8adc8315c45170fa270304b" title=" " alt="" coords="384,197,543,238"/>
<area shape="rect" href="kvm__main_8c.html#a2f2d3734c4cf61a1f4f94e9d47c37d55" title=" " alt="" coords="5,288,129,315"/>
<area shape="rect" href="arm_8c.html#adbabb8b4e50c9c51eec6373fcbc833aa" title=" " alt="" coords="591,313,777,340"/>
<area shape="rect" href="kvm__main_8c.html#a2372c616bc55bc4cd3446660cb7322fc" title=" " alt="" coords="884,415,963,441"/>
<area shape="rect" href="arm_8c.html#a625df4221f73b13d9f23aa818f60e547" title=" " alt="" coords="628,415,740,441"/>
</map>
</div>

</div>
</div>
<a id="a55c5a83ff9f95fb9e6ae8fa50fa07d9a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a55c5a83ff9f95fb9e6ae8fa50fa07d9a">&#9670;&nbsp;</a></span>kvm_arm_clear_debug()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void kvm_arm_clear_debug </td>
          <td>(</td>
          <td class="paramtype">struct kvm_vcpu *&#160;</td>
          <td class="paramname"><em>vcpu</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="debug_8c_source.html#l00280">280</a> of file <a class="el" href="debug_8c_source.html">debug.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;{</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;    trace_kvm_arm_clear_debug(vcpu-&gt;guest_debug);</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160; </div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;<span class="comment">     * Restore the guest&#39;s debug registers if we were using them.</span></div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    <span class="keywordflow">if</span> (vcpu-&gt;guest_debug || kvm_vcpu_os_lock_enabled(vcpu)) {</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;        <span class="keywordflow">if</span> (vcpu-&gt;guest_debug &amp; KVM_GUESTDBG_SINGLESTEP) {</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;            <span class="keywordflow">if</span> (!(*vcpu_cpsr(vcpu) &amp; DBG_SPSR_SS))</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;                <span class="comment">/*</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;<span class="comment">                 * Mark the vcpu as ACTIVE_PENDING</span></div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;<span class="comment">                 * until Software Step exception is taken.</span></div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;<span class="comment">                 */</span></div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;                vcpu_set_flag(vcpu, DBG_SS_ACTIVE_PENDING);</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;        }</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160; </div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;        <a class="code" href="debug_8c.html#a33e80ad65049d17deebb0d5fbe7cc7da">restore_guest_debug_regs</a>(vcpu);</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160; </div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;<span class="comment">         * If we were using HW debug we need to restore the</span></div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;<span class="comment">         * debug_ptr to the guest debug state.</span></div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;<span class="comment">         */</span></div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;        <span class="keywordflow">if</span> (vcpu-&gt;guest_debug &amp; KVM_GUESTDBG_USE_HW) {</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;            <a class="code" href="debug_8c.html#a160fda6c876743727468b5dfee21f0e3">kvm_arm_reset_debug_ptr</a>(vcpu);</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160; </div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;            trace_kvm_arm_set_regset(<span class="stringliteral">&quot;BKPTS&quot;</span>, get_num_brps(),</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;                        &amp;vcpu-&gt;arch.debug_ptr-&gt;dbg_bcr[0],</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;                        &amp;vcpu-&gt;arch.debug_ptr-&gt;dbg_bvr[0]);</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160; </div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;            trace_kvm_arm_set_regset(<span class="stringliteral">&quot;WAPTS&quot;</span>, get_num_wrps(),</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;                        &amp;vcpu-&gt;arch.debug_ptr-&gt;dbg_wcr[0],</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;                        &amp;vcpu-&gt;arch.debug_ptr-&gt;dbg_wvr[0]);</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;        }</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;    }</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;}</div>
<div class="ttc" id="adebug_8c_html_a160fda6c876743727468b5dfee21f0e3"><div class="ttname"><a href="debug_8c.html#a160fda6c876743727468b5dfee21f0e3">kvm_arm_reset_debug_ptr</a></div><div class="ttdeci">void kvm_arm_reset_debug_ptr(struct kvm_vcpu *vcpu)</div><div class="ttdef"><b>Definition:</b> <a href="debug_8c_source.html#l00148">debug.c:148</a></div></div>
<div class="ttc" id="adebug_8c_html_a33e80ad65049d17deebb0d5fbe7cc7da"><div class="ttname"><a href="debug_8c.html#a33e80ad65049d17deebb0d5fbe7cc7da">restore_guest_debug_regs</a></div><div class="ttdeci">static void restore_guest_debug_regs(struct kvm_vcpu *vcpu)</div><div class="ttdef"><b>Definition:</b> <a href="debug_8c_source.html#l00053">debug.c:53</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="debug_8c_a55c5a83ff9f95fb9e6ae8fa50fa07d9a_cgraph.png" border="0" usemap="#adebug_8c_a55c5a83ff9f95fb9e6ae8fa50fa07d9a_cgraph" alt=""/></div>
<map name="adebug_8c_a55c5a83ff9f95fb9e6ae8fa50fa07d9a_cgraph" id="adebug_8c_a55c5a83ff9f95fb9e6ae8fa50fa07d9a_cgraph">
<area shape="rect" title=" " alt="" coords="5,31,176,57"/>
<area shape="rect" href="debug_8c.html#a160fda6c876743727468b5dfee21f0e3" title=" " alt="" coords="224,5,420,32"/>
<area shape="rect" href="debug_8c.html#a33e80ad65049d17deebb0d5fbe7cc7da" title=" " alt="" coords="225,56,419,83"/>
<area shape="rect" href="sys__regs_8c.html#a79848758fc91bd6081326514833ffafa" title=" " alt="" coords="470,31,617,57"/>
<area shape="rect" href="sys__regs_8c.html#adf66277e472bdae2cc839d450085bc4b" title=" " alt="" coords="468,81,619,108"/>
<area shape="rect" href="sys__regs_8c.html#a8f5bcf4d21c4d9b1881dd3fec5bd6178" title=" " alt="" coords="667,56,848,83"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="debug_8c_a55c5a83ff9f95fb9e6ae8fa50fa07d9a_icgraph.png" border="0" usemap="#adebug_8c_a55c5a83ff9f95fb9e6ae8fa50fa07d9a_icgraph" alt=""/></div>
<map name="adebug_8c_a55c5a83ff9f95fb9e6ae8fa50fa07d9a_icgraph" id="adebug_8c_a55c5a83ff9f95fb9e6ae8fa50fa07d9a_icgraph">
<area shape="rect" title=" " alt="" coords="412,5,583,32"/>
<area shape="rect" href="arm_8c.html#adbabb8b4e50c9c51eec6373fcbc833aa" title=" " alt="" coords="177,5,364,32"/>
<area shape="rect" href="kvm__main_8c.html#a2f2d3734c4cf61a1f4f94e9d47c37d55" title=" " alt="" coords="5,5,129,32"/>
</map>
</div>

</div>
</div>
<a id="abd80e27913cd78849bff5e8f4f84c4f3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abd80e27913cd78849bff5e8f4f84c4f3">&#9670;&nbsp;</a></span>kvm_arm_init_debug()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void kvm_arm_init_debug </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>kvm_arm_init_debug - grab what we need for debug</p>
<p>Currently the sole task of this function is to retrieve the initial value of mdcr_el2 so we can preserve MDCR_EL2.HPMN which has presumably been set-up by some knowledgeable bootcode.</p>
<p>It is called once per-cpu during CPU hyp initialisation. </p>

<p class="definition">Definition at line <a class="el" href="debug_8c_source.html#l00078">78</a> of file <a class="el" href="debug_8c_source.html">debug.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;{</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    __this_cpu_write(mdcr_el2, kvm_call_hyp_ret(<a class="code" href="nvhe_2debug-sr_8c.html#acb2d26524ab8b705c96fc1f04eb6245e">__kvm_get_mdcr_el2</a>));</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;}</div>
<div class="ttc" id="anvhe_2debug-sr_8c_html_acb2d26524ab8b705c96fc1f04eb6245e"><div class="ttname"><a href="nvhe_2debug-sr_8c.html#acb2d26524ab8b705c96fc1f04eb6245e">__kvm_get_mdcr_el2</a></div><div class="ttdeci">u64 __kvm_get_mdcr_el2(void)</div><div class="ttdef"><b>Definition:</b> <a href="nvhe_2debug-sr_8c_source.html#l00110">debug-sr.c:110</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="debug_8c_abd80e27913cd78849bff5e8f4f84c4f3_cgraph.png" border="0" usemap="#adebug_8c_abd80e27913cd78849bff5e8f4f84c4f3_cgraph" alt=""/></div>
<map name="adebug_8c_abd80e27913cd78849bff5e8f4f84c4f3_cgraph" id="adebug_8c_abd80e27913cd78849bff5e8f4f84c4f3_cgraph">
<area shape="rect" title=" " alt="" coords="5,5,164,32"/>
<area shape="rect" href="nvhe_2debug-sr_8c.html#acb2d26524ab8b705c96fc1f04eb6245e" title=" " alt="" coords="212,5,372,32"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="debug_8c_abd80e27913cd78849bff5e8f4f84c4f3_icgraph.png" border="0" usemap="#adebug_8c_abd80e27913cd78849bff5e8f4f84c4f3_icgraph" alt=""/></div>
<map name="adebug_8c_abd80e27913cd78849bff5e8f4f84c4f3_icgraph" id="adebug_8c_abd80e27913cd78849bff5e8f4f84c4f3_icgraph">
<area shape="rect" title=" " alt="" coords="1028,81,1187,108"/>
<area shape="rect" href="arm_8c.html#a451b50b80474a3cf090fcce753c8c642" title=" " alt="" coords="815,81,980,108"/>
<area shape="rect" href="arm_8c.html#a2dfd4facec6b758ea01c34f9789486d8" title=" " alt="" coords="649,56,767,83"/>
<area shape="rect" href="arm_8c.html#a45a99f5a1905e2b85f69a767313abfd7" title=" " alt="" coords="653,107,763,133"/>
<area shape="rect" href="arm_8c.html#a0769d67e6376c5081aac75ea3783df2f" title=" " alt="" coords="458,56,562,83"/>
<area shape="rect" href="arm_8c.html#a040f9b021372ae855b2cc25a0c07da7a" title=" " alt="" coords="204,5,332,32"/>
<area shape="rect" href="arm_8c.html#ac1582780a8801f86aa06da8b95cbcfe9" title=" " alt="" coords="165,56,371,83"/>
<area shape="rect" href="arm_8c.html#a625df4221f73b13d9f23aa818f60e547" title=" " alt="" coords="5,56,117,83"/>
<area shape="rect" href="arm_8c.html#a3c73ef13f7491129779b02da5a9a7442" title=" " alt="" coords="419,107,601,133"/>
<area shape="rect" href="arm_8c.html#a289457d5cabd2e7e2cda634bc6277311" title=" " alt="" coords="209,107,327,133"/>
</map>
</div>

</div>
</div>
<a id="a160fda6c876743727468b5dfee21f0e3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a160fda6c876743727468b5dfee21f0e3">&#9670;&nbsp;</a></span>kvm_arm_reset_debug_ptr()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void kvm_arm_reset_debug_ptr </td>
          <td>(</td>
          <td class="paramtype">struct kvm_vcpu *&#160;</td>
          <td class="paramname"><em>vcpu</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>kvm_arm_reset_debug_ptr - reset the debug ptr to point to the vcpu state </p>

<p class="definition">Definition at line <a class="el" href="debug_8c_source.html#l00148">148</a> of file <a class="el" href="debug_8c_source.html">debug.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;{</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    vcpu-&gt;arch.debug_ptr = &amp;vcpu-&gt;arch.vcpu_debug_state;</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="debug_8c_a160fda6c876743727468b5dfee21f0e3_icgraph.png" border="0" usemap="#adebug_8c_a160fda6c876743727468b5dfee21f0e3_icgraph" alt=""/></div>
<map name="adebug_8c_a160fda6c876743727468b5dfee21f0e3_icgraph" id="adebug_8c_a160fda6c876743727468b5dfee21f0e3_icgraph">
<area shape="rect" title=" " alt="" coords="645,31,841,57"/>
<area shape="rect" href="arm_8c.html#ae2ebf37d8daf1a8b43a9823bae4ab32b" title=" " alt="" coords="425,5,597,32"/>
<area shape="rect" href="debug_8c.html#a55c5a83ff9f95fb9e6ae8fa50fa07d9a" title=" " alt="" coords="426,56,597,83"/>
<area shape="rect" href="kvm__main_8c.html#ab8870469dadfadf9a204346c62016293" title=" " alt="" coords="177,5,377,32"/>
<area shape="rect" href="arm_8c.html#adbabb8b4e50c9c51eec6373fcbc833aa" title=" " alt="" coords="184,56,371,83"/>
<area shape="rect" href="kvm__main_8c.html#a2f2d3734c4cf61a1f4f94e9d47c37d55" title=" " alt="" coords="5,56,129,83"/>
</map>
</div>

</div>
</div>
<a id="ac5de7d8da7d4a0e7d01583f9bab9590b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac5de7d8da7d4a0e7d01583f9bab9590b">&#9670;&nbsp;</a></span>kvm_arm_setup_debug()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void kvm_arm_setup_debug </td>
          <td>(</td>
          <td class="paramtype">struct kvm_vcpu *&#160;</td>
          <td class="paramname"><em>vcpu</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>kvm_arm_setup_debug - set up debug related stuff</p>
<p>@vcpu: the vcpu pointer</p>
<p>This is called before each entry into the hypervisor to setup any debug related registers.</p>
<p>Additionally, KVM only traps guest accesses to the debug registers if the guest is not actively using them (see the DEBUG_DIRTY flag on vcpu-&gt;arch.iflags). Since the guest must not interfere with the hardware state when debugging the guest, we must ensure that trapping is enabled whenever we are debugging the guest using the debug registers. </p>

<p class="definition">Definition at line <a class="el" href="debug_8c_source.html#l00169">169</a> of file <a class="el" href="debug_8c_source.html">debug.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;{</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> mdscr, orig_mdcr_el2 = vcpu-&gt;arch.mdcr_el2;</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160; </div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    trace_kvm_arm_setup_debug(vcpu, vcpu-&gt;guest_debug);</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160; </div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    <a class="code" href="debug_8c.html#a2623ab6af1e4a2daefd1808433477b84">kvm_arm_setup_mdcr_el2</a>(vcpu);</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160; </div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    <span class="comment">/* Check if we need to use the debug registers. */</span></div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    <span class="keywordflow">if</span> (vcpu-&gt;guest_debug || kvm_vcpu_os_lock_enabled(vcpu)) {</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;        <span class="comment">/* Save guest debug state */</span></div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;        <a class="code" href="debug_8c.html#a8341c1ad3b486b6fbcec3681518f3d14">save_guest_debug_regs</a>(vcpu);</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160; </div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;<span class="comment">         * Single Step (ARM ARM D2.12.3 The software step state</span></div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;<span class="comment">         * machine)</span></div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;<span class="comment">         *</span></div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;<span class="comment">         * If we are doing Single Step we need to manipulate</span></div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;<span class="comment">         * the guest&#39;s MDSCR_EL1.SS and PSTATE.SS. Once the</span></div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;<span class="comment">         * step has occurred the hypervisor will trap the</span></div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;<span class="comment">         * debug exception and we return to userspace.</span></div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;<span class="comment">         *</span></div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;<span class="comment">         * If the guest attempts to single step its userspace</span></div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;<span class="comment">         * we would have to deal with a trapped exception</span></div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;<span class="comment">         * while in the guest kernel. Because this would be</span></div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;<span class="comment">         * hard to unwind we suppress the guest&#39;s ability to</span></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;<span class="comment">         * do so by masking MDSCR_EL.SS.</span></div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;<span class="comment">         *</span></div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;<span class="comment">         * This confuses guest debuggers which use</span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;<span class="comment">         * single-step behind the scenes but everything</span></div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;<span class="comment">         * returns to normal once the host is no longer</span></div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;<span class="comment">         * debugging the system.</span></div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;<span class="comment">         */</span></div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;        <span class="keywordflow">if</span> (vcpu-&gt;guest_debug &amp; KVM_GUESTDBG_SINGLESTEP) {</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;            <span class="comment">/*</span></div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;<span class="comment">             * If the software step state at the last guest exit</span></div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;<span class="comment">             * was Active-pending, we don&#39;t set DBG_SPSR_SS so</span></div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;<span class="comment">             * that the state is maintained (to not run another</span></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;<span class="comment">             * single-step until the pending Software Step</span></div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;<span class="comment">             * exception is taken).</span></div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;<span class="comment">             */</span></div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;            <span class="keywordflow">if</span> (!vcpu_get_flag(vcpu, DBG_SS_ACTIVE_PENDING))</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;                *vcpu_cpsr(vcpu) |= DBG_SPSR_SS;</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;                *vcpu_cpsr(vcpu) &amp;= ~DBG_SPSR_SS;</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160; </div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;            mdscr = <a class="code" href="sys__regs_8c.html#a79848758fc91bd6081326514833ffafa">vcpu_read_sys_reg</a>(vcpu, MDSCR_EL1);</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;            mdscr |= DBG_MDSCR_SS;</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;            <a class="code" href="sys__regs_8c.html#adf66277e472bdae2cc839d450085bc4b">vcpu_write_sys_reg</a>(vcpu, mdscr, MDSCR_EL1);</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;            mdscr = <a class="code" href="sys__regs_8c.html#a79848758fc91bd6081326514833ffafa">vcpu_read_sys_reg</a>(vcpu, MDSCR_EL1);</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;            mdscr &amp;= ~DBG_MDSCR_SS;</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;            <a class="code" href="sys__regs_8c.html#adf66277e472bdae2cc839d450085bc4b">vcpu_write_sys_reg</a>(vcpu, mdscr, MDSCR_EL1);</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;        }</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160; </div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;        trace_kvm_arm_set_dreg32(<span class="stringliteral">&quot;SPSR_EL2&quot;</span>, *vcpu_cpsr(vcpu));</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160; </div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;<span class="comment">         * HW Breakpoints and watchpoints</span></div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;<span class="comment">         *</span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;<span class="comment">         * We simply switch the debug_ptr to point to our new</span></div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;<span class="comment">         * external_debug_state which has been populated by the</span></div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;<span class="comment">         * debug ioctl. The existing DEBUG_DIRTY mechanism ensures</span></div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;<span class="comment">         * the registers are updated on the world switch.</span></div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;<span class="comment">         */</span></div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;        <span class="keywordflow">if</span> (vcpu-&gt;guest_debug &amp; KVM_GUESTDBG_USE_HW) {</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;            <span class="comment">/* Enable breakpoints/watchpoints */</span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;            mdscr = <a class="code" href="sys__regs_8c.html#a79848758fc91bd6081326514833ffafa">vcpu_read_sys_reg</a>(vcpu, MDSCR_EL1);</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;            mdscr |= DBG_MDSCR_MDE;</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;            <a class="code" href="sys__regs_8c.html#adf66277e472bdae2cc839d450085bc4b">vcpu_write_sys_reg</a>(vcpu, mdscr, MDSCR_EL1);</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160; </div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;            vcpu-&gt;arch.debug_ptr = &amp;vcpu-&gt;arch.external_debug_state;</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;            vcpu_set_flag(vcpu, DEBUG_DIRTY);</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160; </div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;            trace_kvm_arm_set_regset(<span class="stringliteral">&quot;BKPTS&quot;</span>, get_num_brps(),</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;                        &amp;vcpu-&gt;arch.debug_ptr-&gt;dbg_bcr[0],</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;                        &amp;vcpu-&gt;arch.debug_ptr-&gt;dbg_bvr[0]);</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160; </div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;            trace_kvm_arm_set_regset(<span class="stringliteral">&quot;WAPTS&quot;</span>, get_num_wrps(),</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;                        &amp;vcpu-&gt;arch.debug_ptr-&gt;dbg_wcr[0],</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;                        &amp;vcpu-&gt;arch.debug_ptr-&gt;dbg_wvr[0]);</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160; </div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;<span class="comment">         * The OS Lock blocks debug exceptions in all ELs when it is</span></div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;<span class="comment">         * enabled. If the guest has enabled the OS Lock, constrain its</span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;<span class="comment">         * effects to the guest. Emulate the behavior by clearing</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="comment">         * MDSCR_EL1.MDE. In so doing, we ensure that host debug</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="comment">         * exceptions are unaffected by guest configuration of the OS</span></div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;<span class="comment">         * Lock.</span></div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;<span class="comment">         */</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kvm_vcpu_os_lock_enabled(vcpu)) {</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;            mdscr = <a class="code" href="sys__regs_8c.html#a79848758fc91bd6081326514833ffafa">vcpu_read_sys_reg</a>(vcpu, MDSCR_EL1);</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;            mdscr &amp;= ~DBG_MDSCR_MDE;</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;            <a class="code" href="sys__regs_8c.html#adf66277e472bdae2cc839d450085bc4b">vcpu_write_sys_reg</a>(vcpu, mdscr, MDSCR_EL1);</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;        }</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    }</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160; </div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;    BUG_ON(!vcpu-&gt;guest_debug &amp;&amp;</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;        vcpu-&gt;arch.debug_ptr != &amp;vcpu-&gt;arch.vcpu_debug_state);</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160; </div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;    <span class="comment">/* If KDE or MDE are set, perform a full save/restore cycle. */</span></div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="sys__regs_8c.html#a79848758fc91bd6081326514833ffafa">vcpu_read_sys_reg</a>(vcpu, MDSCR_EL1) &amp; (DBG_MDSCR_KDE | DBG_MDSCR_MDE))</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;        vcpu_set_flag(vcpu, DEBUG_DIRTY);</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160; </div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;    <span class="comment">/* Write mdcr_el2 changes since vcpu_load on VHE systems */</span></div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    <span class="keywordflow">if</span> (has_vhe() &amp;&amp; orig_mdcr_el2 != vcpu-&gt;arch.mdcr_el2)</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;        write_sysreg(vcpu-&gt;arch.mdcr_el2, mdcr_el2);</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160; </div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    trace_kvm_arm_set_dreg32(<span class="stringliteral">&quot;MDSCR_EL1&quot;</span>, <a class="code" href="sys__regs_8c.html#a79848758fc91bd6081326514833ffafa">vcpu_read_sys_reg</a>(vcpu, MDSCR_EL1));</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;}</div>
<div class="ttc" id="adebug_8c_html_a2623ab6af1e4a2daefd1808433477b84"><div class="ttname"><a href="debug_8c.html#a2623ab6af1e4a2daefd1808433477b84">kvm_arm_setup_mdcr_el2</a></div><div class="ttdeci">static void kvm_arm_setup_mdcr_el2(struct kvm_vcpu *vcpu)</div><div class="ttdef"><b>Definition:</b> <a href="debug_8c_source.html#l00096">debug.c:96</a></div></div>
<div class="ttc" id="adebug_8c_html_a8341c1ad3b486b6fbcec3681518f3d14"><div class="ttname"><a href="debug_8c.html#a8341c1ad3b486b6fbcec3681518f3d14">save_guest_debug_regs</a></div><div class="ttdeci">static void save_guest_debug_regs(struct kvm_vcpu *vcpu)</div><div class="ttdef"><b>Definition:</b> <a href="debug_8c_source.html#l00040">debug.c:40</a></div></div>
<div class="ttc" id="asys__regs_8c_html_a79848758fc91bd6081326514833ffafa"><div class="ttname"><a href="sys__regs_8c.html#a79848758fc91bd6081326514833ffafa">vcpu_read_sys_reg</a></div><div class="ttdeci">u64 vcpu_read_sys_reg(const struct kvm_vcpu *vcpu, int reg)</div><div class="ttdef"><b>Definition:</b> <a href="sys__regs_8c_source.html#l00128">sys_regs.c:128</a></div></div>
<div class="ttc" id="asys__regs_8c_html_adf66277e472bdae2cc839d450085bc4b"><div class="ttname"><a href="sys__regs_8c.html#adf66277e472bdae2cc839d450085bc4b">vcpu_write_sys_reg</a></div><div class="ttdeci">void vcpu_write_sys_reg(struct kvm_vcpu *vcpu, u64 val, int reg)</div><div class="ttdef"><b>Definition:</b> <a href="sys__regs_8c_source.html#l00172">sys_regs.c:172</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="debug_8c_ac5de7d8da7d4a0e7d01583f9bab9590b_cgraph.png" border="0" usemap="#adebug_8c_ac5de7d8da7d4a0e7d01583f9bab9590b_cgraph" alt=""/></div>
<map name="adebug_8c_ac5de7d8da7d4a0e7d01583f9bab9590b_cgraph" id="adebug_8c_ac5de7d8da7d4a0e7d01583f9bab9590b_cgraph">
<area shape="rect" title=" " alt="" coords="5,81,180,108"/>
<area shape="rect" href="debug_8c.html#a2623ab6af1e4a2daefd1808433477b84" title=" " alt="" coords="228,5,423,32"/>
<area shape="rect" href="debug_8c.html#a8341c1ad3b486b6fbcec3681518f3d14" title=" " alt="" coords="236,56,415,83"/>
<area shape="rect" href="sys__regs_8c.html#a79848758fc91bd6081326514833ffafa" title=" " alt="" coords="473,107,619,133"/>
<area shape="rect" href="sys__regs_8c.html#adf66277e472bdae2cc839d450085bc4b" title=" " alt="" coords="471,157,621,184"/>
<area shape="rect" href="sys__regs_8c.html#a8f5bcf4d21c4d9b1881dd3fec5bd6178" title=" " alt="" coords="669,132,851,159"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="debug_8c_ac5de7d8da7d4a0e7d01583f9bab9590b_icgraph.png" border="0" usemap="#adebug_8c_ac5de7d8da7d4a0e7d01583f9bab9590b_icgraph" alt=""/></div>
<map name="adebug_8c_ac5de7d8da7d4a0e7d01583f9bab9590b_icgraph" id="adebug_8c_ac5de7d8da7d4a0e7d01583f9bab9590b_icgraph">
<area shape="rect" title=" " alt="" coords="412,5,587,32"/>
<area shape="rect" href="arm_8c.html#adbabb8b4e50c9c51eec6373fcbc833aa" title=" " alt="" coords="177,5,364,32"/>
<area shape="rect" href="kvm__main_8c.html#a2f2d3734c4cf61a1f4f94e9d47c37d55" title=" " alt="" coords="5,5,129,32"/>
</map>
</div>

</div>
</div>
<a id="a2623ab6af1e4a2daefd1808433477b84"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2623ab6af1e4a2daefd1808433477b84">&#9670;&nbsp;</a></span>kvm_arm_setup_mdcr_el2()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void kvm_arm_setup_mdcr_el2 </td>
          <td>(</td>
          <td class="paramtype">struct kvm_vcpu *&#160;</td>
          <td class="paramname"><em>vcpu</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>kvm_arm_setup_mdcr_el2 - configure vcpu mdcr_el2 value</p>
<p>@vcpu: the vcpu pointer</p>
<p>This ensures we will trap access to:</p><ul>
<li>Performance monitors (MDCR_EL2_TPM/MDCR_EL2_TPMCR)</li>
<li>Debug ROM Address (MDCR_EL2_TDRA)</li>
<li>OS related registers (MDCR_EL2_TDOSA)</li>
<li>Statistical profiler (MDCR_EL2_TPMS/MDCR_EL2_E2PB)</li>
<li>Self-hosted Trace Filter controls (MDCR_EL2_TTRF)</li>
<li>Self-hosted Trace (MDCR_EL2_TTRF/MDCR_EL2_E2TB) </li>
</ul>

<p class="definition">Definition at line <a class="el" href="debug_8c_source.html#l00096">96</a> of file <a class="el" href="debug_8c_source.html">debug.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;{</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="comment">     * This also clears MDCR_EL2_E2PB_MASK and MDCR_EL2_E2TB_MASK</span></div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;<span class="comment">     * to disable guest access to the profiling and trace buffers</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;    vcpu-&gt;arch.mdcr_el2 = __this_cpu_read(mdcr_el2) &amp; MDCR_EL2_HPMN_MASK;</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    vcpu-&gt;arch.mdcr_el2 |= (MDCR_EL2_TPM |</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;                MDCR_EL2_TPMS |</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;                MDCR_EL2_TTRF |</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;                MDCR_EL2_TPMCR |</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;                MDCR_EL2_TDRA |</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;                MDCR_EL2_TDOSA);</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160; </div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    <span class="comment">/* Is the VM being debugged by userspace? */</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    <span class="keywordflow">if</span> (vcpu-&gt;guest_debug)</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;        <span class="comment">/* Route all software debug exceptions to EL2 */</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;        vcpu-&gt;arch.mdcr_el2 |= MDCR_EL2_TDE;</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160; </div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;<span class="comment">     * Trap debug register access when one of the following is true:</span></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;<span class="comment">     *  - Userspace is using the hardware to debug the guest</span></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;<span class="comment">     *  (KVM_GUESTDBG_USE_HW is set).</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="comment">     *  - The guest is not using debug (DEBUG_DIRTY clear).</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;<span class="comment">     *  - The guest has enabled the OS Lock (debug exceptions are blocked).</span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="comment">     */</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    <span class="keywordflow">if</span> ((vcpu-&gt;guest_debug &amp; KVM_GUESTDBG_USE_HW) ||</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;        !vcpu_get_flag(vcpu, DEBUG_DIRTY) ||</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;        kvm_vcpu_os_lock_enabled(vcpu))</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;        vcpu-&gt;arch.mdcr_el2 |= MDCR_EL2_TDA;</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160; </div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    trace_kvm_arm_set_dreg32(<span class="stringliteral">&quot;MDCR_EL2&quot;</span>, vcpu-&gt;arch.mdcr_el2);</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="debug_8c_a2623ab6af1e4a2daefd1808433477b84_icgraph.png" border="0" usemap="#adebug_8c_a2623ab6af1e4a2daefd1808433477b84_icgraph" alt=""/></div>
<map name="adebug_8c_a2623ab6af1e4a2daefd1808433477b84_icgraph" id="adebug_8c_a2623ab6af1e4a2daefd1808433477b84_icgraph">
<area shape="rect" title=" " alt="" coords="657,35,852,61"/>
<area shape="rect" href="debug_8c.html#ac5de7d8da7d4a0e7d01583f9bab9590b" title=" " alt="" coords="423,8,598,35"/>
<area shape="rect" href="debug_8c.html#a0cdd5b533e40bfb30ba62a5c9d8f52a2" title=" " alt="" coords="412,60,609,87"/>
<area shape="rect" href="arm_8c.html#adbabb8b4e50c9c51eec6373fcbc833aa" title=" " alt="" coords="177,5,364,32"/>
<area shape="rect" href="kvm__main_8c.html#a2f2d3734c4cf61a1f4f94e9d47c37d55" title=" " alt="" coords="5,35,129,61"/>
<area shape="rect" href="arm_8c.html#a163f3db5fe1d973be2855f4a479a5c8c" title=" " alt="" coords="181,57,360,98"/>
</map>
</div>

</div>
</div>
<a id="a0cdd5b533e40bfb30ba62a5c9d8f52a2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0cdd5b533e40bfb30ba62a5c9d8f52a2">&#9670;&nbsp;</a></span>kvm_arm_vcpu_init_debug()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void kvm_arm_vcpu_init_debug </td>
          <td>(</td>
          <td class="paramtype">struct kvm_vcpu *&#160;</td>
          <td class="paramname"><em>vcpu</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>kvm_arm_vcpu_init_debug - setup vcpu debug traps</p>
<p>@vcpu: the vcpu pointer</p>
<p>Set vcpu initial mdcr_el2 value. </p>

<p class="definition">Definition at line <a class="el" href="debug_8c_source.html#l00137">137</a> of file <a class="el" href="debug_8c_source.html">debug.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;{</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    preempt_disable();</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    <a class="code" href="debug_8c.html#a2623ab6af1e4a2daefd1808433477b84">kvm_arm_setup_mdcr_el2</a>(vcpu);</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    preempt_enable();</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="debug_8c_a0cdd5b533e40bfb30ba62a5c9d8f52a2_cgraph.png" border="0" usemap="#adebug_8c_a0cdd5b533e40bfb30ba62a5c9d8f52a2_cgraph" alt=""/></div>
<map name="adebug_8c_a0cdd5b533e40bfb30ba62a5c9d8f52a2_cgraph" id="adebug_8c_a0cdd5b533e40bfb30ba62a5c9d8f52a2_cgraph">
<area shape="rect" title=" " alt="" coords="5,5,203,32"/>
<area shape="rect" href="debug_8c.html#a2623ab6af1e4a2daefd1808433477b84" title=" " alt="" coords="251,5,445,32"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="debug_8c_a0cdd5b533e40bfb30ba62a5c9d8f52a2_icgraph.png" border="0" usemap="#adebug_8c_a0cdd5b533e40bfb30ba62a5c9d8f52a2_icgraph" alt=""/></div>
<map name="adebug_8c_a0cdd5b533e40bfb30ba62a5c9d8f52a2_icgraph" id="adebug_8c_a0cdd5b533e40bfb30ba62a5c9d8f52a2_icgraph">
<area shape="rect" title=" " alt="" coords="404,13,601,39"/>
<area shape="rect" href="arm_8c.html#a163f3db5fe1d973be2855f4a479a5c8c" title=" " alt="" coords="177,5,356,47"/>
<area shape="rect" href="kvm__main_8c.html#a2f2d3734c4cf61a1f4f94e9d47c37d55" title=" " alt="" coords="5,13,129,39"/>
</map>
</div>

</div>
</div>
<a id="a33e80ad65049d17deebb0d5fbe7cc7da"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a33e80ad65049d17deebb0d5fbe7cc7da">&#9670;&nbsp;</a></span>restore_guest_debug_regs()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void restore_guest_debug_regs </td>
          <td>(</td>
          <td class="paramtype">struct kvm_vcpu *&#160;</td>
          <td class="paramname"><em>vcpu</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="debug_8c_source.html#l00053">53</a> of file <a class="el" href="debug_8c_source.html">debug.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;{</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    u64 val = vcpu-&gt;arch.guest_debug_preserved.mdscr_el1;</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160; </div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;    <a class="code" href="sys__regs_8c.html#adf66277e472bdae2cc839d450085bc4b">vcpu_write_sys_reg</a>(vcpu, val, MDSCR_EL1);</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160; </div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    trace_kvm_arm_set_dreg32(<span class="stringliteral">&quot;Restored MDSCR_EL1&quot;</span>,</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;                <a class="code" href="sys__regs_8c.html#a79848758fc91bd6081326514833ffafa">vcpu_read_sys_reg</a>(vcpu, MDSCR_EL1));</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160; </div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    <span class="keywordflow">if</span> (vcpu-&gt;arch.guest_debug_preserved.pstate_ss)</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;        *vcpu_cpsr(vcpu) |= DBG_SPSR_SS;</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;        *vcpu_cpsr(vcpu) &amp;= ~DBG_SPSR_SS;</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="debug_8c_a33e80ad65049d17deebb0d5fbe7cc7da_cgraph.png" border="0" usemap="#adebug_8c_a33e80ad65049d17deebb0d5fbe7cc7da_cgraph" alt=""/></div>
<map name="adebug_8c_a33e80ad65049d17deebb0d5fbe7cc7da_cgraph" id="adebug_8c_a33e80ad65049d17deebb0d5fbe7cc7da_cgraph">
<area shape="rect" title=" " alt="" coords="5,31,199,57"/>
<area shape="rect" href="sys__regs_8c.html#a79848758fc91bd6081326514833ffafa" title=" " alt="" coords="249,5,395,32"/>
<area shape="rect" href="sys__regs_8c.html#adf66277e472bdae2cc839d450085bc4b" title=" " alt="" coords="247,56,397,83"/>
<area shape="rect" href="sys__regs_8c.html#a8f5bcf4d21c4d9b1881dd3fec5bd6178" title=" " alt="" coords="445,31,627,57"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="debug_8c_a33e80ad65049d17deebb0d5fbe7cc7da_icgraph.png" border="0" usemap="#adebug_8c_a33e80ad65049d17deebb0d5fbe7cc7da_icgraph" alt=""/></div>
<map name="adebug_8c_a33e80ad65049d17deebb0d5fbe7cc7da_icgraph" id="adebug_8c_a33e80ad65049d17deebb0d5fbe7cc7da_icgraph">
<area shape="rect" title=" " alt="" coords="631,5,824,32"/>
<area shape="rect" href="debug_8c.html#a55c5a83ff9f95fb9e6ae8fa50fa07d9a" title=" " alt="" coords="412,5,583,32"/>
<area shape="rect" href="arm_8c.html#adbabb8b4e50c9c51eec6373fcbc833aa" title=" " alt="" coords="177,5,364,32"/>
<area shape="rect" href="kvm__main_8c.html#a2f2d3734c4cf61a1f4f94e9d47c37d55" title=" " alt="" coords="5,5,129,32"/>
</map>
</div>

</div>
</div>
<a id="a8341c1ad3b486b6fbcec3681518f3d14"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8341c1ad3b486b6fbcec3681518f3d14">&#9670;&nbsp;</a></span>save_guest_debug_regs()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void save_guest_debug_regs </td>
          <td>(</td>
          <td class="paramtype">struct kvm_vcpu *&#160;</td>
          <td class="paramname"><em>vcpu</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>save/restore_guest_debug_regs</p>
<p>For some debug operations we need to tweak some guest registers. As a result we need to save the state of those registers before we make those modifications.</p>
<p>Guest access to MDSCR_EL1 is trapped by the hypervisor and handled after we have restored the preserved value to the main context.</p>
<p>When single-step is enabled by userspace, we tweak PSTATE.SS on every guest entry. Preserve PSTATE.SS so we can restore the original value for the vcpu after the single-step is disabled. </p>

<p class="definition">Definition at line <a class="el" href="debug_8c_source.html#l00040">40</a> of file <a class="el" href="debug_8c_source.html">debug.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;{</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    u64 val = <a class="code" href="sys__regs_8c.html#a79848758fc91bd6081326514833ffafa">vcpu_read_sys_reg</a>(vcpu, MDSCR_EL1);</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160; </div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    vcpu-&gt;arch.guest_debug_preserved.mdscr_el1 = val;</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160; </div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    trace_kvm_arm_set_dreg32(<span class="stringliteral">&quot;Saved MDSCR_EL1&quot;</span>,</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;                vcpu-&gt;arch.guest_debug_preserved.mdscr_el1);</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160; </div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    vcpu-&gt;arch.guest_debug_preserved.pstate_ss =</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;                    (*vcpu_cpsr(vcpu) &amp; DBG_SPSR_SS);</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="debug_8c_a8341c1ad3b486b6fbcec3681518f3d14_cgraph.png" border="0" usemap="#adebug_8c_a8341c1ad3b486b6fbcec3681518f3d14_cgraph" alt=""/></div>
<map name="adebug_8c_a8341c1ad3b486b6fbcec3681518f3d14_cgraph" id="adebug_8c_a8341c1ad3b486b6fbcec3681518f3d14_cgraph">
<area shape="rect" title=" " alt="" coords="5,5,184,32"/>
<area shape="rect" href="sys__regs_8c.html#a79848758fc91bd6081326514833ffafa" title=" " alt="" coords="232,5,379,32"/>
<area shape="rect" href="sys__regs_8c.html#a8f5bcf4d21c4d9b1881dd3fec5bd6178" title=" " alt="" coords="427,5,608,32"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="debug_8c_a8341c1ad3b486b6fbcec3681518f3d14_icgraph.png" border="0" usemap="#adebug_8c_a8341c1ad3b486b6fbcec3681518f3d14_icgraph" alt=""/></div>
<map name="adebug_8c_a8341c1ad3b486b6fbcec3681518f3d14_icgraph" id="adebug_8c_a8341c1ad3b486b6fbcec3681518f3d14_icgraph">
<area shape="rect" title=" " alt="" coords="635,5,813,32"/>
<area shape="rect" href="debug_8c.html#ac5de7d8da7d4a0e7d01583f9bab9590b" title=" " alt="" coords="412,5,587,32"/>
<area shape="rect" href="arm_8c.html#adbabb8b4e50c9c51eec6373fcbc833aa" title=" " alt="" coords="177,5,364,32"/>
<area shape="rect" href="kvm__main_8c.html#a2f2d3734c4cf61a1f4f94e9d47c37d55" title=" " alt="" coords="5,5,129,32"/>
</map>
</div>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
