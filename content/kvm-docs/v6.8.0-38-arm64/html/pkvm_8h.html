<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>KVM: arch/arm64/kvm/hyp/include/nvhe/pkvm.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">KVM
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_ea9599923402ca8ab47fc3e495999dea.html">arch</a></li><li class="navelem"><a class="el" href="dir_67a9e021ce8db5d46236c6154ee454bc.html">arm64</a></li><li class="navelem"><a class="el" href="dir_42f87ef63ac4150166bf7887f68288e2.html">kvm</a></li><li class="navelem"><a class="el" href="dir_478c73b493f5da08054e18cfdaadae60.html">hyp</a></li><li class="navelem"><a class="el" href="dir_699d3a4d7f2698fd989aae71fa47885c.html">include</a></li><li class="navelem"><a class="el" href="dir_14cd684501203394bcf0de468bac1dda.html">nvhe</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">pkvm.h File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;asm/kvm_pkvm.h&gt;</code><br />
<code>#include &lt;<a class="el" href="gfp_8h_source.html">nvhe/gfp.h</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="spinlock_8h_source.html">nvhe/spinlock.h</a>&gt;</code><br />
</div><div class="textblock"><div class="dynheader">
Include dependency graph for pkvm.h:</div>
<div class="dyncontent">
<div class="center"><img src="pkvm_8h__incl.png" border="0" usemap="#aarch_2arm64_2kvm_2hyp_2include_2nvhe_2pkvm_8h" alt=""/></div>
<map name="aarch_2arm64_2kvm_2hyp_2include_2nvhe_2pkvm_8h" id="aarch_2arm64_2kvm_2hyp_2include_2nvhe_2pkvm_8h">
<area shape="rect" title=" " alt="" coords="276,5,439,47"/>
<area shape="rect" title=" " alt="" coords="149,95,288,121"/>
<area shape="rect" href="gfp_8h.html" title=" " alt="" coords="312,95,403,121"/>
<area shape="rect" href="spinlock_8h.html" title=" " alt="" coords="426,169,550,196"/>
<area shape="rect" title=" " alt="" coords="164,169,255,196"/>
<area shape="rect" href="memory_8h.html" title=" " alt="" coords="279,169,401,196"/>
<area shape="rect" title=" " alt="" coords="5,244,141,271"/>
<area shape="rect" title=" " alt="" coords="165,244,264,271"/>
<area shape="rect" title=" " alt="" coords="288,244,395,271"/>
<area shape="rect" title=" " alt="" coords="419,244,557,271"/>
<area shape="rect" title=" " alt="" coords="581,244,667,271"/>
<area shape="rect" title=" " alt="" coords="691,244,805,271"/>
</map>
</div>
</div><div class="textblock"><div class="dynheader">
This graph shows which files directly or indirectly include this file:</div>
<div class="dyncontent">
<div class="center"><img src="pkvm_8h__dep__incl.png" border="0" usemap="#aarch_2arm64_2kvm_2hyp_2include_2nvhe_2pkvm_8hdep" alt=""/></div>
<map name="aarch_2arm64_2kvm_2hyp_2include_2nvhe_2pkvm_8hdep" id="aarch_2arm64_2kvm_2hyp_2include_2nvhe_2pkvm_8hdep">
<area shape="rect" title=" " alt="" coords="293,5,456,47"/>
<area shape="rect" href="hyp-constants_8c.html" title=" " alt="" coords="129,95,287,136"/>
<area shape="rect" href="mem__protect_8h.html" title=" " alt="" coords="522,95,734,136"/>
<area shape="rect" href="hyp-main_8c.html" title=" " alt="" coords="5,184,163,225"/>
<area shape="rect" href="setup_8c.html" title=" " alt="" coords="187,184,344,225"/>
<area shape="rect" href="hyp_2nvhe_2pkvm_8c.html" title=" " alt="" coords="1277,184,1435,225"/>
<area shape="rect" href="ffa_8c.html" title=" " alt="" coords="549,184,707,225"/>
<area shape="rect" href="mm_8c.html" title=" " alt="" coords="731,184,888,225"/>
<area shape="rect" href="mem__protect_8c.html" title=" " alt="" coords="912,184,1072,225"/>
<area shape="rect" href="nvhe_2switch_8c.html" title=" " alt="" coords="1096,184,1253,225"/>
<area shape="rect" href="nvhe_2tlb_8c.html" title=" " alt="" coords="368,184,525,225"/>
</map>
</div>
</div>
<p><a href="pkvm_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structpkvm__hyp__vcpu.html">pkvm_hyp_vcpu</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structpkvm__hyp__vm.html">pkvm_hyp_vm</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:af309540fc98994ba55e970bf4ec14b65"><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structpkvm__hyp__vm.html">pkvm_hyp_vm</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pkvm_8h.html#af309540fc98994ba55e970bf4ec14b65">pkvm_hyp_vcpu_to_hyp_vm</a> (struct <a class="el" href="structpkvm__hyp__vcpu.html">pkvm_hyp_vcpu</a> *hyp_vcpu)</td></tr>
<tr class="separator:af309540fc98994ba55e970bf4ec14b65"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a465d3fd1802ee92a75147953f36f685e"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pkvm_8h.html#a465d3fd1802ee92a75147953f36f685e">pkvm_hyp_vm_table_init</a> (void *tbl)</td></tr>
<tr class="separator:a465d3fd1802ee92a75147953f36f685e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a284d0118156922a170aff08dae02356c"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pkvm_8h.html#a284d0118156922a170aff08dae02356c">__pkvm_init_vm</a> (struct kvm *host_kvm, unsigned long vm_hva, unsigned long pgd_hva)</td></tr>
<tr class="separator:a284d0118156922a170aff08dae02356c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7216bb296fb7f7480fbc91d0fa389b21"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pkvm_8h.html#a7216bb296fb7f7480fbc91d0fa389b21">__pkvm_init_vcpu</a> (pkvm_handle_t handle, struct kvm_vcpu *host_vcpu, unsigned long vcpu_hva)</td></tr>
<tr class="separator:a7216bb296fb7f7480fbc91d0fa389b21"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adedaa2ebee60585a9aab7d80293a5ad2"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pkvm_8h.html#adedaa2ebee60585a9aab7d80293a5ad2">__pkvm_teardown_vm</a> (pkvm_handle_t handle)</td></tr>
<tr class="separator:adedaa2ebee60585a9aab7d80293a5ad2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a26c97c43a67f2b519b95a2d4f3f3e56d"><td class="memItemLeft" align="right" valign="top">struct <a class="el" href="structpkvm__hyp__vcpu.html">pkvm_hyp_vcpu</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pkvm_8h.html#a26c97c43a67f2b519b95a2d4f3f3e56d">pkvm_load_hyp_vcpu</a> (pkvm_handle_t handle, unsigned int vcpu_idx)</td></tr>
<tr class="separator:a26c97c43a67f2b519b95a2d4f3f3e56d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af533677cbf7e0a82423e25e6ab146d3a"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pkvm_8h.html#af533677cbf7e0a82423e25e6ab146d3a">pkvm_put_hyp_vcpu</a> (struct <a class="el" href="structpkvm__hyp__vcpu.html">pkvm_hyp_vcpu</a> *hyp_vcpu)</td></tr>
<tr class="separator:af533677cbf7e0a82423e25e6ab146d3a"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a id="a7216bb296fb7f7480fbc91d0fa389b21"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7216bb296fb7f7480fbc91d0fa389b21">&#9670;&nbsp;</a></span>__pkvm_init_vcpu()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int __pkvm_init_vcpu </td>
          <td>(</td>
          <td class="paramtype">pkvm_handle_t&#160;</td>
          <td class="paramname"><em>handle</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct kvm_vcpu *&#160;</td>
          <td class="paramname"><em>host_vcpu</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned long&#160;</td>
          <td class="paramname"><em>vcpu_hva</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="hyp_2nvhe_2pkvm_8c_source.html#l00539">539</a> of file <a class="el" href="hyp_2nvhe_2pkvm_8c_source.html">pkvm.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;{</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;    <span class="keyword">struct </span><a class="code" href="structpkvm__hyp__vcpu.html">pkvm_hyp_vcpu</a> *hyp_vcpu;</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;    <span class="keyword">struct </span><a class="code" href="structpkvm__hyp__vm.html">pkvm_hyp_vm</a> *hyp_vm;</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> idx;</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;    <span class="keywordtype">int</span> ret;</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160; </div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;    hyp_vcpu = <a class="code" href="hyp_2nvhe_2pkvm_8c.html#a12992d9e43e154429da5e2a85cf12dd8">map_donated_memory</a>(vcpu_hva, <span class="keyword">sizeof</span>(*hyp_vcpu));</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;    <span class="keywordflow">if</span> (!hyp_vcpu)</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;        <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160; </div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;    <a class="code" href="spinlock_8h.html#ae942ff0e878cb0f4d55ddc4cc6275ec9">hyp_spin_lock</a>(&amp;vm_table_lock);</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160; </div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;    hyp_vm = <a class="code" href="hyp_2nvhe_2pkvm_8c.html#af3a9f8da5f6f1ac6c51d8b4cf7be26ca">get_vm_by_handle</a>(handle);</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;    <span class="keywordflow">if</span> (!hyp_vm) {</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;        ret = -ENOENT;</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;        <span class="keywordflow">goto</span> unlock;</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;    }</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160; </div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;    idx = hyp_vm-&gt;<a class="code" href="structpkvm__hyp__vm.html#a0492fc593f138f3148964a551861a888">nr_vcpus</a>;</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;    <span class="keywordflow">if</span> (idx &gt;= hyp_vm-&gt;<a class="code" href="structpkvm__hyp__vm.html#a19b7e84c5400ed0c05d082ad0c220ef3">kvm</a>.created_vcpus) {</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;        ret = -EINVAL;</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;        <span class="keywordflow">goto</span> unlock;</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;    }</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160; </div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;    ret = <a class="code" href="hyp_2nvhe_2pkvm_8c.html#a62e6bc810202341dfe789a22d676a469">init_pkvm_hyp_vcpu</a>(hyp_vcpu, hyp_vm, host_vcpu, idx);</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;    <span class="keywordflow">if</span> (ret)</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;        <span class="keywordflow">goto</span> unlock;</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160; </div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;    hyp_vm-&gt;<a class="code" href="structpkvm__hyp__vm.html#af611e6bd4d351599211f2ea0d2799750">vcpus</a>[idx] = hyp_vcpu;</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;    hyp_vm-&gt;<a class="code" href="structpkvm__hyp__vm.html#a0492fc593f138f3148964a551861a888">nr_vcpus</a>++;</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;unlock:</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;    <a class="code" href="spinlock_8h.html#a2c6e9db70599188dbe031e2ce8ec6b08">hyp_spin_unlock</a>(&amp;vm_table_lock);</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160; </div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;    <span class="keywordflow">if</span> (ret)</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;        <a class="code" href="hyp_2nvhe_2pkvm_8c.html#a5f7ab23a4eb39c09d0a5b9f461a6cb9b">unmap_donated_memory</a>(hyp_vcpu, <span class="keyword">sizeof</span>(*hyp_vcpu));</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160; </div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;    <span class="keywordflow">return</span> ret;</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;}</div>
<div class="ttc" id="ahyp_2nvhe_2pkvm_8c_html_a12992d9e43e154429da5e2a85cf12dd8"><div class="ttname"><a href="hyp_2nvhe_2pkvm_8c.html#a12992d9e43e154429da5e2a85cf12dd8">map_donated_memory</a></div><div class="ttdeci">static void * map_donated_memory(unsigned long host_va, size_t size)</div><div class="ttdef"><b>Definition:</b> <a href="hyp_2nvhe_2pkvm_8c_source.html#l00421">pkvm.c:421</a></div></div>
<div class="ttc" id="ahyp_2nvhe_2pkvm_8c_html_a5f7ab23a4eb39c09d0a5b9f461a6cb9b"><div class="ttname"><a href="hyp_2nvhe_2pkvm_8c.html#a5f7ab23a4eb39c09d0a5b9f461a6cb9b">unmap_donated_memory</a></div><div class="ttdeci">static void unmap_donated_memory(void *va, size_t size)</div><div class="ttdef"><b>Definition:</b> <a href="hyp_2nvhe_2pkvm_8c_source.html#l00437">pkvm.c:437</a></div></div>
<div class="ttc" id="ahyp_2nvhe_2pkvm_8c_html_a62e6bc810202341dfe789a22d676a469"><div class="ttname"><a href="hyp_2nvhe_2pkvm_8c.html#a62e6bc810202341dfe789a22d676a469">init_pkvm_hyp_vcpu</a></div><div class="ttdeci">static int init_pkvm_hyp_vcpu(struct pkvm_hyp_vcpu *hyp_vcpu, struct pkvm_hyp_vm *hyp_vm, struct kvm_vcpu *host_vcpu, unsigned int vcpu_idx)</div><div class="ttdef"><b>Definition:</b> <a href="hyp_2nvhe_2pkvm_8c_source.html#l00313">pkvm.c:313</a></div></div>
<div class="ttc" id="ahyp_2nvhe_2pkvm_8c_html_af3a9f8da5f6f1ac6c51d8b4cf7be26ca"><div class="ttname"><a href="hyp_2nvhe_2pkvm_8c.html#af3a9f8da5f6f1ac6c51d8b4cf7be26ca">get_vm_by_handle</a></div><div class="ttdeci">static struct pkvm_hyp_vm * get_vm_by_handle(pkvm_handle_t handle)</div><div class="ttdef"><b>Definition:</b> <a href="hyp_2nvhe_2pkvm_8c_source.html#l00253">pkvm.c:253</a></div></div>
<div class="ttc" id="aspinlock_8h_html_a2c6e9db70599188dbe031e2ce8ec6b08"><div class="ttname"><a href="spinlock_8h.html#a2c6e9db70599188dbe031e2ce8ec6b08">hyp_spin_unlock</a></div><div class="ttdeci">static void hyp_spin_unlock(hyp_spinlock_t *lock)</div><div class="ttdef"><b>Definition:</b> <a href="spinlock_8h_source.html#l00082">spinlock.h:82</a></div></div>
<div class="ttc" id="aspinlock_8h_html_ae942ff0e878cb0f4d55ddc4cc6275ec9"><div class="ttname"><a href="spinlock_8h.html#ae942ff0e878cb0f4d55ddc4cc6275ec9">hyp_spin_lock</a></div><div class="ttdeci">static void hyp_spin_lock(hyp_spinlock_t *lock)</div><div class="ttdef"><b>Definition:</b> <a href="spinlock_8h_source.html#l00044">spinlock.h:44</a></div></div>
<div class="ttc" id="astructpkvm__hyp__vcpu_html"><div class="ttname"><a href="structpkvm__hyp__vcpu.html">pkvm_hyp_vcpu</a></div><div class="ttdef"><b>Definition:</b> <a href="pkvm_8h_source.html#l00018">pkvm.h:18</a></div></div>
<div class="ttc" id="astructpkvm__hyp__vm_html"><div class="ttname"><a href="structpkvm__hyp__vm.html">pkvm_hyp_vm</a></div><div class="ttdef"><b>Definition:</b> <a href="pkvm_8h_source.html#l00028">pkvm.h:28</a></div></div>
<div class="ttc" id="astructpkvm__hyp__vm_html_a0492fc593f138f3148964a551861a888"><div class="ttname"><a href="structpkvm__hyp__vm.html#a0492fc593f138f3148964a551861a888">pkvm_hyp_vm::nr_vcpus</a></div><div class="ttdeci">unsigned int nr_vcpus</div><div class="ttdef"><b>Definition:</b> <a href="pkvm_8h_source.html#l00044">pkvm.h:44</a></div></div>
<div class="ttc" id="astructpkvm__hyp__vm_html_a19b7e84c5400ed0c05d082ad0c220ef3"><div class="ttname"><a href="structpkvm__hyp__vm.html#a19b7e84c5400ed0c05d082ad0c220ef3">pkvm_hyp_vm::kvm</a></div><div class="ttdeci">struct kvm kvm</div><div class="ttdef"><b>Definition:</b> <a href="pkvm_8h_source.html#l00022">pkvm.h:29</a></div></div>
<div class="ttc" id="astructpkvm__hyp__vm_html_af611e6bd4d351599211f2ea0d2799750"><div class="ttname"><a href="structpkvm__hyp__vm.html#af611e6bd4d351599211f2ea0d2799750">pkvm_hyp_vm::vcpus</a></div><div class="ttdeci">struct pkvm_hyp_vcpu * vcpus[]</div><div class="ttdef"><b>Definition:</b> <a href="pkvm_8h_source.html#l00047">pkvm.h:47</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="pkvm_8h_a7216bb296fb7f7480fbc91d0fa389b21_cgraph.png" border="0" usemap="#apkvm_8h_a7216bb296fb7f7480fbc91d0fa389b21_cgraph" alt=""/></div>
<map name="apkvm_8h_a7216bb296fb7f7480fbc91d0fa389b21_cgraph" id="apkvm_8h_a7216bb296fb7f7480fbc91d0fa389b21_cgraph">
<area shape="rect" title=" " alt="" coords="5,319,144,345"/>
<area shape="rect" href="hyp_2nvhe_2pkvm_8c.html#af3a9f8da5f6f1ac6c51d8b4cf7be26ca" title=" " alt="" coords="214,5,359,32"/>
<area shape="rect" href="spinlock_8h.html#ae942ff0e878cb0f4d55ddc4cc6275ec9" title=" " alt="" coords="1155,259,1269,285"/>
<area shape="rect" href="spinlock_8h.html#a2c6e9db70599188dbe031e2ce8ec6b08" title=" " alt="" coords="1147,335,1277,361"/>
<area shape="rect" href="hyp_2nvhe_2pkvm_8c.html#a62e6bc810202341dfe789a22d676a469" title=" " alt="" coords="209,293,365,320"/>
<area shape="rect" href="hyp_2nvhe_2pkvm_8c.html#a12992d9e43e154429da5e2a85cf12dd8" title=" " alt="" coords="200,348,373,375"/>
<area shape="rect" href="hyp_2nvhe_2pkvm_8c.html#a5f7ab23a4eb39c09d0a5b9f461a6cb9b" title=" " alt="" coords="192,405,381,432"/>
<area shape="rect" href="hyp_2nvhe_2pkvm_8c.html#a44f3b33f9c9af29ae5def49898ff81dd" title=" " alt="" coords="460,5,601,32"/>
<area shape="rect" href="mem__protect_8h.html#a8d93d64c69622f186ce841ed9b1c608b" title=" " alt="" coords="693,243,858,269"/>
<area shape="rect" href="hyp_2nvhe_2pkvm_8c.html#a9503b9e29dd4b2337feef252f5a57103" title=" " alt="" coords="465,293,596,320"/>
<area shape="rect" href="mem__protect_8c.html#ab45dbaed102ffbf3ccda18c0cc20a6dc" title=" " alt="" coords="1772,110,1960,151"/>
<area shape="rect" href="mem__protect_8c.html#a4ee4815f49f2d2a8397d1e2430193a3e" title=" " alt="" coords="1540,234,1724,275"/>
<area shape="rect" href="mem__protect_8c.html#aa70b12df63f9379efa7fe11ade510b7c" title=" " alt="" coords="927,259,1091,285"/>
<area shape="rect" href="mem__protect_8c.html#a21f32ced99ed31332ac532029100e42d" title=" " alt="" coords="919,411,1099,437"/>
<area shape="rect" href="mem__protect_8c.html#abbc50e372d72deb41a021219c35e3589" title=" " alt="" coords="929,309,1089,336"/>
<area shape="rect" href="memory_8h.html#a52854ece4f50a52b454b91f1a144b189" title=" " alt="" coords="941,107,1077,133"/>
<area shape="rect" href="mem__protect_8c.html#a024de911d90c8e8d57cc96c87fecb4d3" title=" " alt="" coords="921,360,1097,387"/>
<area shape="rect" href="mem__protect_8c.html#a3ea605c8779e3d79d674c81a6d64919c" title=" " alt="" coords="2012,179,2195,205"/>
<area shape="rect" href="mem__protect_8c.html#a39c30c3fbf244570912cbd38c6e5606a" title=" " alt="" coords="2025,117,2182,144"/>
<area shape="rect" href="spinlock_8h.html#ae92c9f4a09d239d6060880c35d12a48b" title=" " alt="" coords="2022,280,2185,307"/>
<area shape="rect" href="mem__protect_8c.html#acef59d69975c27a7815896535bbb4e65" title=" " alt="" coords="2247,171,2400,213"/>
<area shape="rect" href="pgtable_8c.html#a2a6ed7242e033a1f32360cbe0e5c2281" title=" " alt="" coords="2251,284,2396,311"/>
<area shape="rect" href="pgtable_8c.html#ac74b17e065ba3e68a10f28b594d21e40" title=" " alt="" coords="2448,284,2600,311"/>
<area shape="rect" href="pgtable_8c.html#a4819ac158aa1b43844c3a3b5e5a82ac3" title=" " alt="" coords="2648,259,2807,285"/>
<area shape="rect" href="pgtable_8c.html#af01e17f60125c9e093e082e70a43f362" title=" " alt="" coords="2653,309,2801,336"/>
<area shape="rect" href="pgtable_8c.html#a5aa0f5d1f7f2540fea515eb0b198caba" title=" " alt="" coords="2855,259,3011,285"/>
<area shape="rect" href="mem__protect_8c.html#a906b44af03f69892941d0b4e87d52fbd" title=" " alt="" coords="1789,229,1943,256"/>
<area shape="rect" href="mem__protect_8h.html#a16fa0918fd8f50705e15341038d58fd8" title=" " alt="" coords="685,301,866,328"/>
<area shape="rect" href="memory_8h.html#a3cc326fe973add2b2ea91f6b04dd8fde" title=" " alt="" coords="939,208,1079,235"/>
<area shape="rect" href="hyp_2nvhe_2pkvm_8c.html#a9ac0a95585deaa45106e201ede7a21ec" title=" " alt="" coords="444,345,617,386"/>
<area shape="rect" href="mem__protect_8h.html#a0a0107b185016d850cc3912f2cd2cc09" title=" " alt="" coords="680,356,871,383"/>
<area shape="rect" href="mem__protect_8c.html#a7e4a0c65211d20b4e8adc2d323699489" title=" " alt="" coords="963,512,1054,539"/>
<area shape="rect" href="mem__protect_8c.html#a09511b2fc9e756f5849a9a10c21946f2" title=" " alt="" coords="1357,499,1461,525"/>
<area shape="rect" href="mem__protect_8c.html#a4738d2842abcf74309391d6e6c677537" title=" " alt="" coords="1150,385,1274,412"/>
<area shape="rect" href="mem__protect_8c.html#a673fb7f8a0e4a07b1d69687f8e0e0ba1" title=" " alt="" coords="1541,499,1723,525"/>
<area shape="rect" href="mem__protect_8c.html#ad1da243415ccdd263b42151ea524c09b" title=" " alt="" coords="1549,549,1715,576"/>
<area shape="rect" href="mem__protect_8c.html#ae4aa540ec02ab30863a99b67f90471e5" title=" " alt="" coords="1543,397,1721,424"/>
<area shape="rect" href="mem__protect_8c.html#a41715fcfd37184a9ffdef5c049390537" title=" " alt="" coords="1551,448,1713,475"/>
<area shape="rect" href="mem__protect_8c.html#afb7f8781ecbfa50324009fac4a8a68a8" title=" " alt="" coords="1779,521,1953,562"/>
<area shape="rect" href="mm_8h.html#a36a82f8cc52bf1bf431f904beddc6c18" title=" " alt="" coords="1777,331,1955,373"/>
<area shape="rect" href="mem__protect_8h.html#a2cf886e3d56ed4cd5ddb78944ac0a152" title=" " alt="" coords="1806,397,1926,424"/>
<area shape="rect" href="pgtable_8c.html#af16196aa505cacc0ca294719f9575ce4" title=" " alt="" coords="2008,389,2199,416"/>
<area shape="rect" href="mem__protect_8c.html#a04ee34c0284691282c8c6b71cd477b6a" title=" " alt="" coords="1337,125,1481,152"/>
<area shape="rect" href="mem__protect_8c.html#a5d4226b7d58b6d55f4d6d7195914f4c2" title=" " alt="" coords="1331,59,1487,101"/>
<area shape="rect" href="mem__protect_8c.html#a14fb7245d65588761a3639a3186f18d2" title=" " alt="" coords="1339,176,1479,203"/>
<area shape="rect" href="mem__protect_8c.html#a9dbbee933218e562a7eca625a3b6695b" title=" " alt="" coords="1325,344,1492,371"/>
<area shape="rect" href="mem__protect_8c.html#a793d27f9ec8b2dabd2c158c94d8b7a43" title=" " alt="" coords="1551,117,1713,144"/>
<area shape="rect" href="mem__protect_8c.html#a89057e6dfc7b241de73b439208bcf7d5" title=" " alt="" coords="1542,169,1722,210"/>
<area shape="rect" href="hyp_2nvhe_2pkvm_8c.html#a57ca4bd54f074772ac03c6401856d122" title=" " alt="" coords="429,411,632,437"/>
<area shape="rect" href="mem__protect_8h.html#ac46723bcc56baf1618eacb213151c926" title=" " alt="" coords="680,409,871,436"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="pkvm_8h_a7216bb296fb7f7480fbc91d0fa389b21_icgraph.png" border="0" usemap="#apkvm_8h_a7216bb296fb7f7480fbc91d0fa389b21_icgraph" alt=""/></div>
<map name="apkvm_8h_a7216bb296fb7f7480fbc91d0fa389b21_icgraph" id="apkvm_8h_a7216bb296fb7f7480fbc91d0fa389b21_icgraph">
<area shape="rect" title=" " alt="" coords="857,38,996,65"/>
<area shape="rect" href="pkvm_8c.html#ac6f8b05fc1474ed8f561ddb8f7fa3a96" title=" " alt="" coords="624,13,804,39"/>
<area shape="rect" href="hyp-main_8c.html#ae49bc086c41cfafcbf8f708aba0fc64b" title=" " alt="" coords="619,63,809,90"/>
<area shape="rect" href="pkvm_8c.html#a9c8ae8a0a845f44545cd6b7819f3430e" title=" " alt="" coords="404,13,571,39"/>
<area shape="rect" href="arm_8c.html#a163f3db5fe1d973be2855f4a479a5c8c" title=" " alt="" coords="177,5,356,47"/>
<area shape="rect" href="kvm__main_8c.html#a2f2d3734c4cf61a1f4f94e9d47c37d55" title=" " alt="" coords="5,13,129,39"/>
</map>
</div>

</div>
</div>
<a id="a284d0118156922a170aff08dae02356c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a284d0118156922a170aff08dae02356c">&#9670;&nbsp;</a></span>__pkvm_init_vm()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int __pkvm_init_vm </td>
          <td>(</td>
          <td class="paramtype">struct kvm *&#160;</td>
          <td class="paramname"><em>host_kvm</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned long&#160;</td>
          <td class="paramname"><em>vm_hva</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned long&#160;</td>
          <td class="paramname"><em>pgd_hva</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="hyp_2nvhe_2pkvm_8c_source.html#l00470">470</a> of file <a class="el" href="hyp_2nvhe_2pkvm_8c_source.html">pkvm.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;{</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;    <span class="keyword">struct </span><a class="code" href="structpkvm__hyp__vm.html">pkvm_hyp_vm</a> *hyp_vm = NULL;</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;    <span class="keywordtype">size_t</span> vm_size, pgd_size;</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structpkvm__hyp__vm.html#a0492fc593f138f3148964a551861a888">nr_vcpus</a>;</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;    <span class="keywordtype">void</span> *pgd = NULL;</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;    <span class="keywordtype">int</span> ret;</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160; </div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;    ret = <a class="code" href="mem__protect_8h.html#a8d93d64c69622f186ce841ed9b1c608b">hyp_pin_shared_mem</a>(<a class="code" href="structpkvm__hyp__vm.html#aabc69503a3c0c2f3aad0ceae78b2f9bf">host_kvm</a>, <a class="code" href="structpkvm__hyp__vm.html#aabc69503a3c0c2f3aad0ceae78b2f9bf">host_kvm</a> + 1);</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;    <span class="keywordflow">if</span> (ret)</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;        <span class="keywordflow">return</span> ret;</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160; </div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;    <a class="code" href="structpkvm__hyp__vm.html#a0492fc593f138f3148964a551861a888">nr_vcpus</a> = READ_ONCE(<a class="code" href="structpkvm__hyp__vm.html#aabc69503a3c0c2f3aad0ceae78b2f9bf">host_kvm</a>-&gt;created_vcpus);</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="structpkvm__hyp__vm.html#a0492fc593f138f3148964a551861a888">nr_vcpus</a> &lt; 1) {</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;        ret = -EINVAL;</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;        <span class="keywordflow">goto</span> err_unpin_kvm;</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;    }</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160; </div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;    vm_size = <a class="code" href="hyp_2nvhe_2pkvm_8c.html#a424af5862f022dc4c7a63b34219cd0f8">pkvm_get_hyp_vm_size</a>(<a class="code" href="structpkvm__hyp__vm.html#a0492fc593f138f3148964a551861a888">nr_vcpus</a>);</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;    pgd_size = <a class="code" href="pgtable_8c.html#ac79c497e1cec1ab3d0b89e4ce87e5f51">kvm_pgtable_stage2_pgd_size</a>(<a class="code" href="structhost__mmu.html">host_mmu</a>.<a class="code" href="structhost__mmu.html#a158be8f20ffaf8467b5b56bd2ba109d1">arch</a>.mmu.vtcr);</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160; </div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;    ret = -ENOMEM;</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160; </div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;    hyp_vm = <a class="code" href="hyp_2nvhe_2pkvm_8c.html#a12992d9e43e154429da5e2a85cf12dd8">map_donated_memory</a>(vm_hva, vm_size);</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;    <span class="keywordflow">if</span> (!hyp_vm)</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;        <span class="keywordflow">goto</span> err_remove_mappings;</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160; </div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;    pgd = <a class="code" href="hyp_2nvhe_2pkvm_8c.html#a9ac0a95585deaa45106e201ede7a21ec">map_donated_memory_noclear</a>(pgd_hva, pgd_size);</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    <span class="keywordflow">if</span> (!pgd)</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;        <span class="keywordflow">goto</span> err_remove_mappings;</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160; </div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;    <a class="code" href="hyp_2nvhe_2pkvm_8c.html#ad91b8ef9f472d054091ac0d0c7f1d249">init_pkvm_hyp_vm</a>(<a class="code" href="structpkvm__hyp__vm.html#aabc69503a3c0c2f3aad0ceae78b2f9bf">host_kvm</a>, hyp_vm, <a class="code" href="structpkvm__hyp__vm.html#a0492fc593f138f3148964a551861a888">nr_vcpus</a>);</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160; </div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;    <a class="code" href="spinlock_8h.html#ae942ff0e878cb0f4d55ddc4cc6275ec9">hyp_spin_lock</a>(&amp;vm_table_lock);</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;    ret = <a class="code" href="hyp_2nvhe_2pkvm_8c.html#a5c0b7226654c586286248bea9b106540">insert_vm_table_entry</a>(<a class="code" href="structpkvm__hyp__vm.html#aabc69503a3c0c2f3aad0ceae78b2f9bf">host_kvm</a>, hyp_vm);</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;        <span class="keywordflow">goto</span> err_unlock;</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160; </div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;    ret = <a class="code" href="mem__protect_8h.html#aede5343a98d17e8fdc0146e1908c69dd">kvm_guest_prepare_stage2</a>(hyp_vm, pgd);</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;    <span class="keywordflow">if</span> (ret)</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;        <span class="keywordflow">goto</span> err_remove_vm_table_entry;</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;    <a class="code" href="spinlock_8h.html#a2c6e9db70599188dbe031e2ce8ec6b08">hyp_spin_unlock</a>(&amp;vm_table_lock);</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160; </div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;    <span class="keywordflow">return</span> hyp_vm-&gt;<a class="code" href="structpkvm__hyp__vm.html#a19b7e84c5400ed0c05d082ad0c220ef3">kvm</a>.arch.pkvm.handle;</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160; </div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;err_remove_vm_table_entry:</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;    <a class="code" href="hyp_2nvhe_2pkvm_8c.html#a296892c18e515626259e369403a4d3d0">remove_vm_table_entry</a>(hyp_vm-&gt;<a class="code" href="structpkvm__hyp__vm.html#a19b7e84c5400ed0c05d082ad0c220ef3">kvm</a>.arch.pkvm.handle);</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;err_unlock:</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;    <a class="code" href="spinlock_8h.html#a2c6e9db70599188dbe031e2ce8ec6b08">hyp_spin_unlock</a>(&amp;vm_table_lock);</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;err_remove_mappings:</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;    <a class="code" href="hyp_2nvhe_2pkvm_8c.html#a5f7ab23a4eb39c09d0a5b9f461a6cb9b">unmap_donated_memory</a>(hyp_vm, vm_size);</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;    <a class="code" href="hyp_2nvhe_2pkvm_8c.html#a5f7ab23a4eb39c09d0a5b9f461a6cb9b">unmap_donated_memory</a>(pgd, pgd_size);</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;err_unpin_kvm:</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;    <a class="code" href="mem__protect_8h.html#a16fa0918fd8f50705e15341038d58fd8">hyp_unpin_shared_mem</a>(<a class="code" href="structpkvm__hyp__vm.html#aabc69503a3c0c2f3aad0ceae78b2f9bf">host_kvm</a>, <a class="code" href="structpkvm__hyp__vm.html#aabc69503a3c0c2f3aad0ceae78b2f9bf">host_kvm</a> + 1);</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;    <span class="keywordflow">return</span> ret;</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;}</div>
<div class="ttc" id="ahyp_2nvhe_2pkvm_8c_html_a296892c18e515626259e369403a4d3d0"><div class="ttname"><a href="hyp_2nvhe_2pkvm_8c.html#a296892c18e515626259e369403a4d3d0">remove_vm_table_entry</a></div><div class="ttdeci">static void remove_vm_table_entry(pkvm_handle_t handle)</div><div class="ttdef"><b>Definition:</b> <a href="hyp_2nvhe_2pkvm_8c_source.html#l00395">pkvm.c:395</a></div></div>
<div class="ttc" id="ahyp_2nvhe_2pkvm_8c_html_a424af5862f022dc4c7a63b34219cd0f8"><div class="ttname"><a href="hyp_2nvhe_2pkvm_8c.html#a424af5862f022dc4c7a63b34219cd0f8">pkvm_get_hyp_vm_size</a></div><div class="ttdeci">static size_t pkvm_get_hyp_vm_size(unsigned int nr_vcpus)</div><div class="ttdef"><b>Definition:</b> <a href="hyp_2nvhe_2pkvm_8c_source.html#l00401">pkvm.c:401</a></div></div>
<div class="ttc" id="ahyp_2nvhe_2pkvm_8c_html_a5c0b7226654c586286248bea9b106540"><div class="ttname"><a href="hyp_2nvhe_2pkvm_8c.html#a5c0b7226654c586286248bea9b106540">insert_vm_table_entry</a></div><div class="ttdeci">static pkvm_handle_t insert_vm_table_entry(struct kvm *host_kvm, struct pkvm_hyp_vm *hyp_vm)</div><div class="ttdef"><b>Definition:</b> <a href="hyp_2nvhe_2pkvm_8c_source.html#l00360">pkvm.c:360</a></div></div>
<div class="ttc" id="ahyp_2nvhe_2pkvm_8c_html_a9ac0a95585deaa45106e201ede7a21ec"><div class="ttname"><a href="hyp_2nvhe_2pkvm_8c.html#a9ac0a95585deaa45106e201ede7a21ec">map_donated_memory_noclear</a></div><div class="ttdeci">static void * map_donated_memory_noclear(unsigned long host_va, size_t size)</div><div class="ttdef"><b>Definition:</b> <a href="hyp_2nvhe_2pkvm_8c_source.html#l00407">pkvm.c:407</a></div></div>
<div class="ttc" id="ahyp_2nvhe_2pkvm_8c_html_ad91b8ef9f472d054091ac0d0c7f1d249"><div class="ttname"><a href="hyp_2nvhe_2pkvm_8c.html#ad91b8ef9f472d054091ac0d0c7f1d249">init_pkvm_hyp_vm</a></div><div class="ttdeci">static void init_pkvm_hyp_vm(struct kvm *host_kvm, struct pkvm_hyp_vm *hyp_vm, unsigned int nr_vcpus)</div><div class="ttdef"><b>Definition:</b> <a href="hyp_2nvhe_2pkvm_8c_source.html#l00305">pkvm.c:305</a></div></div>
<div class="ttc" id="amem__protect_8h_html_a16fa0918fd8f50705e15341038d58fd8"><div class="ttname"><a href="mem__protect_8h.html#a16fa0918fd8f50705e15341038d58fd8">hyp_unpin_shared_mem</a></div><div class="ttdeci">void hyp_unpin_shared_mem(void *from, void *to)</div><div class="ttdef"><b>Definition:</b> <a href="mem__protect_8c_source.html#l01246">mem_protect.c:1246</a></div></div>
<div class="ttc" id="amem__protect_8h_html_a8d93d64c69622f186ce841ed9b1c608b"><div class="ttname"><a href="mem__protect_8h.html#a8d93d64c69622f186ce841ed9b1c608b">hyp_pin_shared_mem</a></div><div class="ttdeci">int hyp_pin_shared_mem(void *from, void *to)</div><div class="ttdef"><b>Definition:</b> <a href="mem__protect_8c_source.html#l01216">mem_protect.c:1216</a></div></div>
<div class="ttc" id="amem__protect_8h_html_aede5343a98d17e8fdc0146e1908c69dd"><div class="ttname"><a href="mem__protect_8h.html#aede5343a98d17e8fdc0146e1908c69dd">kvm_guest_prepare_stage2</a></div><div class="ttdeci">int kvm_guest_prepare_stage2(struct pkvm_hyp_vm *vm, void *pgd)</div><div class="ttdef"><b>Definition:</b> <a href="mem__protect_8c_source.html#l00232">mem_protect.c:232</a></div></div>
<div class="ttc" id="apgtable_8c_html_ac79c497e1cec1ab3d0b89e4ce87e5f51"><div class="ttname"><a href="pgtable_8c.html#ac79c497e1cec1ab3d0b89e4ce87e5f51">kvm_pgtable_stage2_pgd_size</a></div><div class="ttdeci">size_t kvm_pgtable_stage2_pgd_size(u64 vtcr)</div><div class="ttdef"><b>Definition:</b> <a href="pgtable_8c_source.html#l01561">pgtable.c:1561</a></div></div>
<div class="ttc" id="astructhost__mmu_html"><div class="ttname"><a href="structhost__mmu.html">host_mmu</a></div><div class="ttdef"><b>Definition:</b> <a href="mem__protect_8h_source.html#l00048">mem_protect.h:48</a></div></div>
<div class="ttc" id="astructhost__mmu_html_a158be8f20ffaf8467b5b56bd2ba109d1"><div class="ttname"><a href="structhost__mmu.html#a158be8f20ffaf8467b5b56bd2ba109d1">host_mmu::arch</a></div><div class="ttdeci">struct kvm_arch arch</div><div class="ttdef"><b>Definition:</b> <a href="mem__protect_8h_source.html#l00086">mem_protect.h:49</a></div></div>
<div class="ttc" id="astructpkvm__hyp__vm_html_aabc69503a3c0c2f3aad0ceae78b2f9bf"><div class="ttname"><a href="structpkvm__hyp__vm.html#aabc69503a3c0c2f3aad0ceae78b2f9bf">pkvm_hyp_vm::host_kvm</a></div><div class="ttdeci">struct kvm * host_kvm</div><div class="ttdef"><b>Definition:</b> <a href="pkvm_8h_source.html#l00032">pkvm.h:32</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="pkvm_8h_a284d0118156922a170aff08dae02356c_cgraph.png" border="0" usemap="#apkvm_8h_a284d0118156922a170aff08dae02356c_cgraph" alt=""/></div>
<map name="apkvm_8h_a284d0118156922a170aff08dae02356c_cgraph" id="apkvm_8h_a284d0118156922a170aff08dae02356c_cgraph">
<area shape="rect" title=" " alt="" coords="5,755,135,782"/>
<area shape="rect" href="mem__protect_8h.html#a8d93d64c69622f186ce841ed9b1c608b" title=" " alt="" coords="697,478,863,504"/>
<area shape="rect" href="spinlock_8h.html#ae942ff0e878cb0f4d55ddc4cc6275ec9" title=" " alt="" coords="1207,528,1322,555"/>
<area shape="rect" href="spinlock_8h.html#a2c6e9db70599188dbe031e2ce8ec6b08" title=" " alt="" coords="1199,782,1330,808"/>
<area shape="rect" href="mem__protect_8h.html#a16fa0918fd8f50705e15341038d58fd8" title=" " alt="" coords="689,579,871,606"/>
<area shape="rect" href="hyp_2nvhe_2pkvm_8c.html#ad91b8ef9f472d054091ac0d0c7f1d249" title=" " alt="" coords="204,1402,351,1428"/>
<area shape="rect" href="hyp_2nvhe_2pkvm_8c.html#a5c0b7226654c586286248bea9b106540" title=" " alt="" coords="193,164,361,191"/>
<area shape="rect" href="mem__protect_8h.html#aede5343a98d17e8fdc0146e1908c69dd" title=" " alt="" coords="420,1000,623,1027"/>
<area shape="rect" href="pgtable_8c.html#ac79c497e1cec1ab3d0b89e4ce87e5f51" title=" " alt="" coords="701,1437,859,1478"/>
<area shape="rect" href="hyp_2nvhe_2pkvm_8c.html#a12992d9e43e154429da5e2a85cf12dd8" title=" " alt="" coords="191,704,364,731"/>
<area shape="rect" href="hyp_2nvhe_2pkvm_8c.html#a9ac0a95585deaa45106e201ede7a21ec" title=" " alt="" coords="435,646,608,688"/>
<area shape="rect" href="hyp_2nvhe_2pkvm_8c.html#a424af5862f022dc4c7a63b34219cd0f8" title=" " alt="" coords="188,1452,367,1479"/>
<area shape="rect" href="hyp_2nvhe_2pkvm_8c.html#a296892c18e515626259e369403a4d3d0" title=" " alt="" coords="187,26,368,52"/>
<area shape="rect" href="hyp_2nvhe_2pkvm_8c.html#a5f7ab23a4eb39c09d0a5b9f461a6cb9b" title=" " alt="" coords="183,1503,372,1530"/>
<area shape="rect" href="mem__protect_8c.html#ab45dbaed102ffbf3ccda18c0cc20a6dc" title=" " alt="" coords="937,245,1125,286"/>
<area shape="rect" href="mem__protect_8c.html#a4ee4815f49f2d2a8397d1e2430193a3e" title=" " alt="" coords="939,310,1123,352"/>
<area shape="rect" href="mem__protect_8c.html#aa70b12df63f9379efa7fe11ade510b7c" title=" " alt="" coords="949,528,1113,555"/>
<area shape="rect" href="mem__protect_8c.html#a21f32ced99ed31332ac532029100e42d" title=" " alt="" coords="941,630,1121,656"/>
<area shape="rect" href="mem__protect_8c.html#abbc50e372d72deb41a021219c35e3589" title=" " alt="" coords="951,478,1111,504"/>
<area shape="rect" href="memory_8h.html#a52854ece4f50a52b454b91f1a144b189" title=" " alt="" coords="963,427,1099,454"/>
<area shape="rect" href="mem__protect_8c.html#a024de911d90c8e8d57cc96c87fecb4d3" title=" " alt="" coords="943,579,1119,606"/>
<area shape="rect" href="mem__protect_8c.html#a3ea605c8779e3d79d674c81a6d64919c" title=" " alt="" coords="1173,302,1356,328"/>
<area shape="rect" href="mem__protect_8c.html#a39c30c3fbf244570912cbd38c6e5606a" title=" " alt="" coords="1186,251,1343,278"/>
<area shape="rect" href="spinlock_8h.html#ae92c9f4a09d239d6060880c35d12a48b" title=" " alt="" coords="1183,196,1346,223"/>
<area shape="rect" href="mem__protect_8c.html#a906b44af03f69892941d0b4e87d52fbd" title=" " alt="" coords="1188,352,1341,379"/>
<area shape="rect" href="memory_8h.html#a3cc326fe973add2b2ea91f6b04dd8fde" title=" " alt="" coords="961,680,1101,707"/>
<area shape="rect" href="hyp_2nvhe_2pkvm_8c.html#a29d3fa50cc8ae1d0b023ca30ab0ceffc" title=" " alt="" coords="448,128,595,169"/>
<area shape="rect" href="hyp_2nvhe_2pkvm_8c.html#a5d9f0046f5027226ee083947e55ef151" title=" " alt="" coords="451,76,592,103"/>
<area shape="rect" href="pgtable_8c.html#a9588301531fc2cca84ebf22bd7e9fd1f" title=" " alt="" coords="680,1386,880,1412"/>
<area shape="rect" href="mem__protect_8c.html#a7b75c96fdca4f9e2423274d19539732e" title=" " alt="" coords="684,1102,876,1128"/>
<area shape="rect" href="mem__protect_8c.html#a908466d681d5e97d3703f5cdbb74195d" title=" " alt="" coords="945,731,1117,758"/>
<area shape="rect" href="mem__protect_8c.html#ae8436f4ddcbf41ee699d5ad641d8b7a1" title=" " alt="" coords="701,681,859,722"/>
<area shape="rect" href="mem__protect_8c.html#a49ffb76aced02bafea21c2db094875f9" title=" " alt="" coords="707,1203,853,1230"/>
<area shape="rect" href="mem__protect_8c.html#aec2e458217e1cf49169b545e7753ff13" title=" " alt="" coords="707,747,853,774"/>
<area shape="rect" href="mem__protect_8c.html#a5b200ee75f7323df4f3906ae2c88ab9f" title=" " alt="" coords="698,1000,862,1027"/>
<area shape="rect" href="memory_8h.html#a14e874dea4f604e8102b20809cc5eae4" title=" " alt="" coords="965,1026,1098,1052"/>
<area shape="rect" href="mem__protect_8c.html#ab632fa704709729b0dd0fca500937c6a" title=" " alt="" coords="695,1254,865,1296"/>
<area shape="rect" href="mem__protect_8c.html#a207ffb88750ad30144dd966ed427151a" title=" " alt="" coords="705,1320,855,1361"/>
<area shape="rect" href="mem__protect_8c.html#ab39943fa5a8f70eca9309055e9a0e46d" title=" " alt="" coords="937,840,1125,867"/>
<area shape="rect" href="memory_8h.html#a3858889abb828afd54e20be3a55947d8" title=" " alt="" coords="716,798,844,824"/>
<area shape="rect" href="gfp_8h.html#a0861db7d9969f386a9a429f7554b8311" title=" " alt="" coords="725,899,835,926"/>
<area shape="rect" href="memory_8h.html#aae436fb2b3f13c0954cde727104e80ac" title=" " alt="" coords="713,950,847,976"/>
<area shape="rect" href="mem__protect_8c.html#aaec0113601639e091ef92762b6dd8651" title=" " alt="" coords="671,1152,889,1179"/>
<area shape="rect" href="pgtable_8c.html#ab68001fdf94eab0c95183a0d99df3576" title=" " alt="" coords="967,1415,1095,1442"/>
<area shape="rect" href="mm_8h.html#ad0da942b8d7da8d3cde5a7c767d025eb" title=" " alt="" coords="964,1152,1099,1179"/>
<area shape="rect" href="mm_8h.html#a0747acdab70dfab415663e73eaae8d92" title=" " alt="" coords="956,1102,1107,1128"/>
<area shape="rect" href="gfp_8h.html#ac66c23236ea3da14d0a38962609014dc" title=" " alt="" coords="975,782,1088,808"/>
<area shape="rect" href="mem__protect_8h.html#a0a0107b185016d850cc3912f2cd2cc09" title=" " alt="" coords="685,528,875,555"/>
<area shape="rect" href="hyp_2nvhe_2pkvm_8c.html#a44f3b33f9c9af29ae5def49898ff81dd" title=" " alt="" coords="451,26,592,52"/>
<area shape="rect" href="hyp_2nvhe_2pkvm_8c.html#a57ca4bd54f074772ac03c6401856d122" title=" " alt="" coords="420,1503,623,1530"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="pkvm_8h_a284d0118156922a170aff08dae02356c_icgraph.png" border="0" usemap="#apkvm_8h_a284d0118156922a170aff08dae02356c_icgraph" alt=""/></div>
<map name="apkvm_8h_a284d0118156922a170aff08dae02356c_icgraph" id="apkvm_8h_a284d0118156922a170aff08dae02356c_icgraph">
<area shape="rect" title=" " alt="" coords="847,38,976,65"/>
<area shape="rect" href="pkvm_8c.html#ac6f8b05fc1474ed8f561ddb8f7fa3a96" title=" " alt="" coords="619,13,799,39"/>
<area shape="rect" href="hyp-main_8c.html#a31ad01bbbb8a492515863ede046e1697" title=" " alt="" coords="619,63,799,90"/>
<area shape="rect" href="pkvm_8c.html#a9c8ae8a0a845f44545cd6b7819f3430e" title=" " alt="" coords="404,13,571,39"/>
<area shape="rect" href="arm_8c.html#a163f3db5fe1d973be2855f4a479a5c8c" title=" " alt="" coords="177,5,356,47"/>
<area shape="rect" href="kvm__main_8c.html#a2f2d3734c4cf61a1f4f94e9d47c37d55" title=" " alt="" coords="5,13,129,39"/>
</map>
</div>

</div>
</div>
<a id="adedaa2ebee60585a9aab7d80293a5ad2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adedaa2ebee60585a9aab7d80293a5ad2">&#9670;&nbsp;</a></span>__pkvm_teardown_vm()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int __pkvm_teardown_vm </td>
          <td>(</td>
          <td class="paramtype">pkvm_handle_t&#160;</td>
          <td class="paramname"><em>handle</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="hyp_2nvhe_2pkvm_8c_source.html#l00592">592</a> of file <a class="el" href="hyp_2nvhe_2pkvm_8c_source.html">pkvm.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;{</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;    <span class="keyword">struct </span>kvm_hyp_memcache *mc;</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;    <span class="keyword">struct </span><a class="code" href="structpkvm__hyp__vm.html">pkvm_hyp_vm</a> *hyp_vm;</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;    <span class="keyword">struct </span>kvm *host_kvm;</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> idx;</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;    <span class="keywordtype">size_t</span> vm_size;</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;    <span class="keywordtype">int</span> err;</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160; </div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;    <a class="code" href="spinlock_8h.html#ae942ff0e878cb0f4d55ddc4cc6275ec9">hyp_spin_lock</a>(&amp;vm_table_lock);</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;    hyp_vm = <a class="code" href="hyp_2nvhe_2pkvm_8c.html#af3a9f8da5f6f1ac6c51d8b4cf7be26ca">get_vm_by_handle</a>(handle);</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;    <span class="keywordflow">if</span> (!hyp_vm) {</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;        err = -ENOENT;</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;        <span class="keywordflow">goto</span> err_unlock;</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;    }</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160; </div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;    <span class="keywordflow">if</span> (WARN_ON(<a class="code" href="memory_8h.html#a3858889abb828afd54e20be3a55947d8">hyp_page_count</a>(hyp_vm))) {</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;        err = -EBUSY;</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;        <span class="keywordflow">goto</span> err_unlock;</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;    }</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160; </div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;    host_kvm = hyp_vm-&gt;<a class="code" href="structpkvm__hyp__vm.html#aabc69503a3c0c2f3aad0ceae78b2f9bf">host_kvm</a>;</div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160; </div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;    <span class="comment">/* Ensure the VMID is clean before it can be reallocated */</span></div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;    <a class="code" href="nvhe_2tlb_8c.html#acd12cf2005a2acf1ce92ff165096726a">__kvm_tlb_flush_vmid</a>(&amp;hyp_vm-&gt;<a class="code" href="structpkvm__hyp__vm.html#a19b7e84c5400ed0c05d082ad0c220ef3">kvm</a>.arch.mmu);</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;    <a class="code" href="hyp_2nvhe_2pkvm_8c.html#a296892c18e515626259e369403a4d3d0">remove_vm_table_entry</a>(handle);</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;    <a class="code" href="spinlock_8h.html#a2c6e9db70599188dbe031e2ce8ec6b08">hyp_spin_unlock</a>(&amp;vm_table_lock);</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160; </div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;    <span class="comment">/* Reclaim guest pages (including page-table pages) */</span></div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;    mc = &amp;host_kvm-&gt;arch.pkvm.teardown_mc;</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;    <a class="code" href="mem__protect_8h.html#af31ab34b10dfe2d918b3d0aedaaefc90">reclaim_guest_pages</a>(hyp_vm, mc);</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;    <a class="code" href="hyp_2nvhe_2pkvm_8c.html#a9fb5ca8500d8ba2e1c140f3dd549d832">unpin_host_vcpus</a>(hyp_vm-&gt;<a class="code" href="structpkvm__hyp__vm.html#af611e6bd4d351599211f2ea0d2799750">vcpus</a>, hyp_vm-&gt;<a class="code" href="structpkvm__hyp__vm.html#a0492fc593f138f3148964a551861a888">nr_vcpus</a>);</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160; </div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;    <span class="comment">/* Push the metadata pages to the teardown memcache */</span></div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;    <span class="keywordflow">for</span> (idx = 0; idx &lt; hyp_vm-&gt;<a class="code" href="structpkvm__hyp__vm.html#a0492fc593f138f3148964a551861a888">nr_vcpus</a>; ++idx) {</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;        <span class="keyword">struct </span><a class="code" href="structpkvm__hyp__vcpu.html">pkvm_hyp_vcpu</a> *hyp_vcpu = hyp_vm-&gt;<a class="code" href="structpkvm__hyp__vm.html#af611e6bd4d351599211f2ea0d2799750">vcpus</a>[idx];</div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160; </div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;        <a class="code" href="hyp_2nvhe_2pkvm_8c.html#a315a65a066329bcea7b74d4eb11c963c">teardown_donated_memory</a>(mc, hyp_vcpu, <span class="keyword">sizeof</span>(*hyp_vcpu));</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;    }</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160; </div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;    vm_size = <a class="code" href="hyp_2nvhe_2pkvm_8c.html#a424af5862f022dc4c7a63b34219cd0f8">pkvm_get_hyp_vm_size</a>(hyp_vm-&gt;<a class="code" href="structpkvm__hyp__vm.html#a19b7e84c5400ed0c05d082ad0c220ef3">kvm</a>.created_vcpus);</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;    <a class="code" href="hyp_2nvhe_2pkvm_8c.html#a315a65a066329bcea7b74d4eb11c963c">teardown_donated_memory</a>(mc, hyp_vm, vm_size);</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;    <a class="code" href="mem__protect_8h.html#a16fa0918fd8f50705e15341038d58fd8">hyp_unpin_shared_mem</a>(host_kvm, host_kvm + 1);</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160; </div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;err_unlock:</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;    <a class="code" href="spinlock_8h.html#a2c6e9db70599188dbe031e2ce8ec6b08">hyp_spin_unlock</a>(&amp;vm_table_lock);</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;    <span class="keywordflow">return</span> err;</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;}</div>
<div class="ttc" id="ahyp_2nvhe_2pkvm_8c_html_a315a65a066329bcea7b74d4eb11c963c"><div class="ttname"><a href="hyp_2nvhe_2pkvm_8c.html#a315a65a066329bcea7b74d4eb11c963c">teardown_donated_memory</a></div><div class="ttdeci">static void teardown_donated_memory(struct kvm_hyp_memcache *mc, void *addr, size_t size)</div><div class="ttdef"><b>Definition:</b> <a href="hyp_2nvhe_2pkvm_8c_source.html#l00581">pkvm.c:581</a></div></div>
<div class="ttc" id="ahyp_2nvhe_2pkvm_8c_html_a9fb5ca8500d8ba2e1c140f3dd549d832"><div class="ttname"><a href="hyp_2nvhe_2pkvm_8c.html#a9fb5ca8500d8ba2e1c140f3dd549d832">unpin_host_vcpus</a></div><div class="ttdeci">static void unpin_host_vcpus(struct pkvm_hyp_vcpu *hyp_vcpus[], unsigned int nr_vcpus)</div><div class="ttdef"><b>Definition:</b> <a href="hyp_2nvhe_2pkvm_8c_source.html#l00296">pkvm.c:296</a></div></div>
<div class="ttc" id="amem__protect_8h_html_af31ab34b10dfe2d918b3d0aedaaefc90"><div class="ttname"><a href="mem__protect_8h.html#af31ab34b10dfe2d918b3d0aedaaefc90">reclaim_guest_pages</a></div><div class="ttdeci">void reclaim_guest_pages(struct pkvm_hyp_vm *vm, struct kvm_hyp_memcache *mc)</div><div class="ttdef"><b>Definition:</b> <a href="mem__protect_8c_source.html#l00269">mem_protect.c:269</a></div></div>
<div class="ttc" id="amemory_8h_html_a3858889abb828afd54e20be3a55947d8"><div class="ttname"><a href="memory_8h.html#a3858889abb828afd54e20be3a55947d8">hyp_page_count</a></div><div class="ttdeci">static int hyp_page_count(void *addr)</div><div class="ttdef"><b>Definition:</b> <a href="memory_8h_source.html#l00045">memory.h:45</a></div></div>
<div class="ttc" id="anvhe_2tlb_8c_html_acd12cf2005a2acf1ce92ff165096726a"><div class="ttname"><a href="nvhe_2tlb_8c.html#acd12cf2005a2acf1ce92ff165096726a">__kvm_tlb_flush_vmid</a></div><div class="ttdeci">void __kvm_tlb_flush_vmid(struct kvm_s2_mmu *mmu)</div><div class="ttdef"><b>Definition:</b> <a href="nvhe_2tlb_8c_source.html#l00168">tlb.c:168</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="pkvm_8h_adedaa2ebee60585a9aab7d80293a5ad2_cgraph.png" border="0" usemap="#apkvm_8h_adedaa2ebee60585a9aab7d80293a5ad2_cgraph" alt=""/></div>
<map name="apkvm_8h_adedaa2ebee60585a9aab7d80293a5ad2_cgraph" id="apkvm_8h_adedaa2ebee60585a9aab7d80293a5ad2_cgraph">
<area shape="rect" title=" " alt="" coords="5,309,175,336"/>
<area shape="rect" href="nvhe_2tlb_8c.html#acd12cf2005a2acf1ce92ff165096726a" title=" " alt="" coords="242,56,409,83"/>
<area shape="rect" href="hyp_2nvhe_2pkvm_8c.html#af3a9f8da5f6f1ac6c51d8b4cf7be26ca" title=" " alt="" coords="253,208,398,235"/>
<area shape="rect" href="memory_8h.html#a3858889abb828afd54e20be3a55947d8" title=" " alt="" coords="261,157,389,184"/>
<area shape="rect" href="spinlock_8h.html#ae942ff0e878cb0f4d55ddc4cc6275ec9" title=" " alt="" coords="1468,344,1583,371"/>
<area shape="rect" href="spinlock_8h.html#a2c6e9db70599188dbe031e2ce8ec6b08" title=" " alt="" coords="1460,597,1591,624"/>
<area shape="rect" href="mem__protect_8h.html#a16fa0918fd8f50705e15341038d58fd8" title=" " alt="" coords="969,344,1150,371"/>
<area shape="rect" href="hyp_2nvhe_2pkvm_8c.html#a424af5862f022dc4c7a63b34219cd0f8" title=" " alt="" coords="236,360,415,387"/>
<area shape="rect" href="mem__protect_8h.html#af31ab34b10dfe2d918b3d0aedaaefc90" title=" " alt="" coords="735,564,895,591"/>
<area shape="rect" href="hyp_2nvhe_2pkvm_8c.html#a296892c18e515626259e369403a4d3d0" title=" " alt="" coords="235,259,416,285"/>
<area shape="rect" href="hyp_2nvhe_2pkvm_8c.html#a315a65a066329bcea7b74d4eb11c963c" title=" " alt="" coords="223,461,428,488"/>
<area shape="rect" href="hyp_2nvhe_2pkvm_8c.html#a9fb5ca8500d8ba2e1c140f3dd549d832" title=" " alt="" coords="256,309,395,336"/>
<area shape="rect" href="nvhe_2tlb_8c.html#ac4dc226b1ecb9bca38c3096eb27c4c1d" title=" " alt="" coords="488,56,653,83"/>
<area shape="rect" href="nvhe_2tlb_8c.html#afffa64d5f9de2ef7a026837a2b9a0629" title=" " alt="" coords="492,5,649,32"/>
<area shape="rect" href="mem__protect_8h.html#a30e07c8d8daaddaecfb787562883f88d" title=" " alt="" coords="739,5,890,32"/>
<area shape="rect" href="hyp_2nvhe_2pkvm_8c.html#a44f3b33f9c9af29ae5def49898ff81dd" title=" " alt="" coords="500,208,641,235"/>
<area shape="rect" href="mem__protect_8c.html#aa70b12df63f9379efa7fe11ade510b7c" title=" " alt="" coords="1211,293,1375,320"/>
<area shape="rect" href="mem__protect_8c.html#a21f32ced99ed31332ac532029100e42d" title=" " alt="" coords="1203,445,1383,472"/>
<area shape="rect" href="mem__protect_8c.html#abbc50e372d72deb41a021219c35e3589" title=" " alt="" coords="1213,344,1373,371"/>
<area shape="rect" href="memory_8h.html#a3cc326fe973add2b2ea91f6b04dd8fde" title=" " alt="" coords="1223,243,1363,269"/>
<area shape="rect" href="mem__protect_8c.html#a024de911d90c8e8d57cc96c87fecb4d3" title=" " alt="" coords="1205,395,1381,421"/>
<area shape="rect" href="mem__protect_8c.html#ac46723bcc56baf1618eacb213151c926" title=" " alt="" coords="964,496,1155,523"/>
<area shape="rect" href="mem__protect_8c.html#a908466d681d5e97d3703f5cdbb74195d" title=" " alt="" coords="973,547,1145,573"/>
<area shape="rect" href="mem__protect_8c.html#ab39943fa5a8f70eca9309055e9a0e46d" title=" " alt="" coords="965,597,1153,624"/>
<area shape="rect" href="gfp_8h.html#a7a740bb58e275f0307a86b02008f751a" title=" " alt="" coords="1227,699,1358,725"/>
<area shape="rect" href="memory_8h.html#aae436fb2b3f13c0954cde727104e80ac" title=" " alt="" coords="993,445,1126,472"/>
<area shape="rect" href="pgtable_8c.html#ab0ed17e7108aa47fbba6cbdfea0b6606" title=" " alt="" coords="980,855,1139,897"/>
<area shape="rect" href="mem__protect_8c.html#a7e4a0c65211d20b4e8adc2d323699489" title=" " alt="" coords="1247,547,1338,573"/>
<area shape="rect" href="mem__protect_8c.html#a09511b2fc9e756f5849a9a10c21946f2" title=" " alt="" coords="1473,496,1577,523"/>
<area shape="rect" href="mem__protect_8c.html#a4738d2842abcf74309391d6e6c677537" title=" " alt="" coords="1463,547,1587,573"/>
<area shape="rect" href="mem__protect_8c.html#a673fb7f8a0e4a07b1d69687f8e0e0ba1" title=" " alt="" coords="1668,496,1851,523"/>
<area shape="rect" href="page__alloc_8c.html#a8ac88fa38a81f4de49d9e80665b1ffc0" title=" " alt="" coords="1449,648,1601,675"/>
<area shape="rect" href="memory_8h.html#af9e2f139c35baaaccb3e11cfe21cf182" title=" " alt="" coords="1431,699,1620,725"/>
<area shape="rect" href="page__alloc_8c.html#ab41323251ac55b72defe671d568dcce7" title=" " alt="" coords="1469,749,1582,776"/>
<area shape="rect" href="page__alloc_8c.html#ae518629a69c1b296e4ade7f9bd7041b8" title=" " alt="" coords="1675,699,1843,725"/>
<area shape="rect" href="page__alloc_8c.html#a02f9a2f04d282f7c4026c60bc2c8d81c" title=" " alt="" coords="1693,597,1825,624"/>
<area shape="rect" href="page__alloc_8c.html#ab55ed9a753f81792da659a3b165fefee" title=" " alt="" coords="1671,648,1847,675"/>
<area shape="rect" href="pgtable_8c.html#ab68001fdf94eab0c95183a0d99df3576" title=" " alt="" coords="1229,965,1357,992"/>
<area shape="rect" href="pgtable_8c.html#a2a6ed7242e033a1f32360cbe0e5c2281" title=" " alt="" coords="1220,825,1365,852"/>
<area shape="rect" href="pgtable_8c.html#a28c492866ecf19d7caee51ffa130c6cb" title=" " alt="" coords="1218,889,1367,916"/>
<area shape="rect" href="pgtable_8c.html#af01e17f60125c9e093e082e70a43f362" title=" " alt="" coords="1685,901,1833,928"/>
<area shape="rect" href="pgtable_8c.html#ac74b17e065ba3e68a10f28b594d21e40" title=" " alt="" coords="1449,800,1601,827"/>
<area shape="rect" href="pgtable_8c.html#a2f4269267d0718905af8540821a6de3d" title=" " alt="" coords="1462,952,1589,979"/>
<area shape="rect" href="pgtable_8c.html#a6e3f339456d5a01daa47962cc12f080e" title=" " alt="" coords="1466,851,1585,877"/>
<area shape="rect" href="pgtable_8c.html#a59b91ffe6fadc53223e667c87148c43c" title=" " alt="" coords="1440,901,1611,928"/>
<area shape="rect" href="spinlock_8h.html#ae92c9f4a09d239d6060880c35d12a48b" title=" " alt="" coords="489,259,652,285"/>
<area shape="rect" href="hyp_2nvhe_2pkvm_8c.html#ae0206a7c88d213b1ff24538337468249" title=" " alt="" coords="476,447,665,489"/>
<area shape="rect" href="hyp_2nvhe_2pkvm_8c.html#a57ca4bd54f074772ac03c6401856d122" title=" " alt="" coords="713,451,916,477"/>
<area shape="rect" href="mem__protect_8h.html#ac46723bcc56baf1618eacb213151c926" title=" " alt="" coords="964,395,1155,421"/>
<area shape="rect" href="hyp_2nvhe_2pkvm_8c.html#a9503b9e29dd4b2337feef252f5a57103" title=" " alt="" coords="749,328,880,355"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="pkvm_8h_adedaa2ebee60585a9aab7d80293a5ad2_icgraph.png" border="0" usemap="#apkvm_8h_adedaa2ebee60585a9aab7d80293a5ad2_icgraph" alt=""/></div>
<map name="apkvm_8h_adedaa2ebee60585a9aab7d80293a5ad2_icgraph" id="apkvm_8h_adedaa2ebee60585a9aab7d80293a5ad2_icgraph">
<area shape="rect" title=" " alt="" coords="1569,71,1739,98"/>
<area shape="rect" href="pkvm_8c.html#abd259bb0db17ae7c75a8940360667c32" title=" " alt="" coords="1317,46,1505,73"/>
<area shape="rect" href="hyp-main_8c.html#acd9baa0fe0fe70ef810d8675e69aa87d" title=" " alt="" coords="1301,97,1521,123"/>
<area shape="rect" href="pkvm_8c.html#ac6f8b05fc1474ed8f561ddb8f7fa3a96" title=" " alt="" coords="1073,21,1253,47"/>
<area shape="rect" href="pkvm_8c.html#a0de2dfe512399e7f17c01091bc3e8ae8" title=" " alt="" coords="1076,71,1251,98"/>
<area shape="rect" href="pkvm_8c.html#a9c8ae8a0a845f44545cd6b7819f3430e" title=" " alt="" coords="857,17,1023,43"/>
<area shape="rect" href="arm_8c.html#a163f3db5fe1d973be2855f4a479a5c8c" title=" " alt="" coords="628,5,807,47"/>
<area shape="rect" href="kvm__main_8c.html#a2f2d3734c4cf61a1f4f94e9d47c37d55" title=" " alt="" coords="455,13,579,39"/>
<area shape="rect" href="arm_8c.html#ad84dda268db5d48c48f3ef2f438c62a7" title=" " alt="" coords="855,71,1025,98"/>
<area shape="rect" href="kvm__main_8c.html#a54b22e6be98d31db1a83e7993fbcf4bc" title=" " alt="" coords="453,67,580,94"/>
<area shape="rect" href="kvm__main_8c.html#afd922c538c448ab1248cdb9dccae9410" title=" " alt="" coords="650,133,785,159"/>
<area shape="rect" href="kvm__main_8c.html#a955de4f2a1b3371438636eccab732b27" title=" " alt="" coords="212,58,405,85"/>
<area shape="rect" href="kvm__main_8c.html#a013962010b954d8597e5987fd27c8241" title=" " alt="" coords="459,154,574,181"/>
<area shape="rect" href="kvm__main_8c.html#a37fa7805021941c56fe174eae4c8c377" title=" " alt="" coords="234,109,383,135"/>
<area shape="rect" href="kvm__main_8c.html#af19040bdcea372f13eab66499d99201c" title=" " alt="" coords="226,159,391,186"/>
<area shape="rect" href="guest__memfd_8c.html#ad8912fbda61cdcb6d9e5a3c0f839e001" title=" " alt="" coords="231,210,386,237"/>
<area shape="rect" href="kvm__main_8c.html#af67afbdcee89641f21573ac643d8e693" title=" " alt="" coords="241,261,376,287"/>
<area shape="rect" href="kvm__main_8c.html#a87bcafdc42ee32aedb84df5e564f9872" title=" " alt="" coords="5,109,164,135"/>
</map>
</div>

</div>
</div>
<a id="af309540fc98994ba55e970bf4ec14b65"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af309540fc98994ba55e970bf4ec14b65">&#9670;&nbsp;</a></span>pkvm_hyp_vcpu_to_hyp_vm()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structpkvm__hyp__vm.html">pkvm_hyp_vm</a>* pkvm_hyp_vcpu_to_hyp_vm </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structpkvm__hyp__vcpu.html">pkvm_hyp_vcpu</a> *&#160;</td>
          <td class="paramname"><em>hyp_vcpu</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="pkvm_8h_source.html#l00051">51</a> of file <a class="el" href="pkvm_8h_source.html">pkvm.h</a>.</p>
<div class="fragment"><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;{</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    <span class="keywordflow">return</span> container_of(hyp_vcpu-&gt;<a class="code" href="structpkvm__hyp__vcpu.html#a4c0a73fea5ae1993444129cf102451a6">vcpu</a>.kvm, <span class="keyword">struct</span> <a class="code" href="structpkvm__hyp__vm.html">pkvm_hyp_vm</a>, kvm);</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;}</div>
<div class="ttc" id="astructpkvm__hyp__vcpu_html_a4c0a73fea5ae1993444129cf102451a6"><div class="ttname"><a href="structpkvm__hyp__vcpu.html#a4c0a73fea5ae1993444129cf102451a6">pkvm_hyp_vcpu::vcpu</a></div><div class="ttdeci">struct kvm_vcpu vcpu</div><div class="ttdef"><b>Definition:</b> <a href="pkvm_8h_source.html#l00066">pkvm.h:19</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="pkvm_8h_af309540fc98994ba55e970bf4ec14b65_icgraph.png" border="0" usemap="#apkvm_8h_af309540fc98994ba55e970bf4ec14b65_icgraph" alt=""/></div>
<map name="apkvm_8h_af309540fc98994ba55e970bf4ec14b65_icgraph" id="apkvm_8h_af309540fc98994ba55e970bf4ec14b65_icgraph">
<area shape="rect" title=" " alt="" coords="440,5,647,32"/>
<area shape="rect" href="pkvm_8h.html#af533677cbf7e0a82423e25e6ab146d3a" title=" " alt="" coords="236,5,392,32"/>
<area shape="rect" href="hyp-main_8c.html#a4ee0e6f5a31d21183ee7fea340479a2a" title=" " alt="" coords="5,5,188,32"/>
</map>
</div>

</div>
</div>
<a id="a465d3fd1802ee92a75147953f36f685e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a465d3fd1802ee92a75147953f36f685e">&#9670;&nbsp;</a></span>pkvm_hyp_vm_table_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void pkvm_hyp_vm_table_init </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>tbl</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="hyp_2nvhe_2pkvm_8c_source.html#l00244">244</a> of file <a class="el" href="hyp_2nvhe_2pkvm_8c_source.html">pkvm.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;{</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    WARN_ON(<a class="code" href="hyp_2nvhe_2pkvm_8c.html#a17425ab40cd41e111f5331be6e644d83">vm_table</a>);</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    <a class="code" href="hyp_2nvhe_2pkvm_8c.html#a17425ab40cd41e111f5331be6e644d83">vm_table</a> = tbl;</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;}</div>
<div class="ttc" id="ahyp_2nvhe_2pkvm_8c_html_a17425ab40cd41e111f5331be6e644d83"><div class="ttname"><a href="hyp_2nvhe_2pkvm_8c.html#a17425ab40cd41e111f5331be6e644d83">vm_table</a></div><div class="ttdeci">static struct pkvm_hyp_vm ** vm_table</div><div class="ttdef"><b>Definition:</b> <a href="hyp_2nvhe_2pkvm_8c_source.html#l00242">pkvm.c:242</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="pkvm_8h_a465d3fd1802ee92a75147953f36f685e_icgraph.png" border="0" usemap="#apkvm_8h_a465d3fd1802ee92a75147953f36f685e_icgraph" alt=""/></div>
<map name="apkvm_8h_a465d3fd1802ee92a75147953f36f685e_icgraph" id="apkvm_8h_a465d3fd1802ee92a75147953f36f685e_icgraph">
<area shape="rect" title=" " alt="" coords="1115,31,1301,57"/>
<area shape="rect" href="setup_8c.html#ab5bdfd8a9c40da5d8de013de4f049dbe" title=" " alt="" coords="912,31,1067,57"/>
<area shape="rect" href="setup_8c.html#a69148fd8ebc6b8dd5f602c1dae42544d" title=" " alt="" coords="763,31,864,57"/>
<area shape="rect" href="arm_8c.html#a45a99f5a1905e2b85f69a767313abfd7" title=" " alt="" coords="583,5,694,32"/>
<area shape="rect" href="hyp-main_8c.html#a26b0350e219d42d5ea7f7df36d17d9e8" title=" " alt="" coords="563,56,715,83"/>
<area shape="rect" href="arm_8c.html#a3c73ef13f7491129779b02da5a9a7442" title=" " alt="" coords="332,5,515,32"/>
<area shape="rect" href="arm_8c.html#a289457d5cabd2e7e2cda634bc6277311" title=" " alt="" coords="165,5,284,32"/>
<area shape="rect" href="arm_8c.html#a625df4221f73b13d9f23aa818f60e547" title=" " alt="" coords="5,5,117,32"/>
</map>
</div>

</div>
</div>
<a id="a26c97c43a67f2b519b95a2d4f3f3e56d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a26c97c43a67f2b519b95a2d4f3f3e56d">&#9670;&nbsp;</a></span>pkvm_load_hyp_vcpu()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structpkvm__hyp__vcpu.html">pkvm_hyp_vcpu</a>* pkvm_load_hyp_vcpu </td>
          <td>(</td>
          <td class="paramtype">pkvm_handle_t&#160;</td>
          <td class="paramname"><em>handle</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&#160;</td>
          <td class="paramname"><em>vcpu_idx</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="hyp_2nvhe_2pkvm_8c_source.html#l00263">263</a> of file <a class="el" href="hyp_2nvhe_2pkvm_8c_source.html">pkvm.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;{</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;    <span class="keyword">struct </span><a class="code" href="structpkvm__hyp__vcpu.html">pkvm_hyp_vcpu</a> *hyp_vcpu = NULL;</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    <span class="keyword">struct </span><a class="code" href="structpkvm__hyp__vm.html">pkvm_hyp_vm</a> *hyp_vm;</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160; </div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;    <a class="code" href="spinlock_8h.html#ae942ff0e878cb0f4d55ddc4cc6275ec9">hyp_spin_lock</a>(&amp;vm_table_lock);</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;    hyp_vm = <a class="code" href="hyp_2nvhe_2pkvm_8c.html#af3a9f8da5f6f1ac6c51d8b4cf7be26ca">get_vm_by_handle</a>(handle);</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;    <span class="keywordflow">if</span> (!hyp_vm || hyp_vm-&gt;<a class="code" href="structpkvm__hyp__vm.html#a0492fc593f138f3148964a551861a888">nr_vcpus</a> &lt;= vcpu_idx)</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;        <span class="keywordflow">goto</span> unlock;</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160; </div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    hyp_vcpu = hyp_vm-&gt;<a class="code" href="structpkvm__hyp__vm.html#af611e6bd4d351599211f2ea0d2799750">vcpus</a>[vcpu_idx];</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    <a class="code" href="memory_8h.html#a52854ece4f50a52b454b91f1a144b189">hyp_page_ref_inc</a>(<a class="code" href="memory_8h.html#a1ce5e4fc197c0773bbd80fb4b5270369">hyp_virt_to_page</a>(hyp_vm));</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;unlock:</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    <a class="code" href="spinlock_8h.html#a2c6e9db70599188dbe031e2ce8ec6b08">hyp_spin_unlock</a>(&amp;vm_table_lock);</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    <span class="keywordflow">return</span> hyp_vcpu;</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;}</div>
<div class="ttc" id="amemory_8h_html_a1ce5e4fc197c0773bbd80fb4b5270369"><div class="ttname"><a href="memory_8h.html#a1ce5e4fc197c0773bbd80fb4b5270369">hyp_virt_to_page</a></div><div class="ttdeci">#define hyp_virt_to_page(virt)</div><div class="ttdef"><b>Definition:</b> <a href="memory_8h_source.html#l00033">memory.h:33</a></div></div>
<div class="ttc" id="amemory_8h_html_a52854ece4f50a52b454b91f1a144b189"><div class="ttname"><a href="memory_8h.html#a52854ece4f50a52b454b91f1a144b189">hyp_page_ref_inc</a></div><div class="ttdeci">static void hyp_page_ref_inc(struct hyp_page *p)</div><div class="ttdef"><b>Definition:</b> <a href="memory_8h_source.html#l00052">memory.h:52</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="pkvm_8h_a26c97c43a67f2b519b95a2d4f3f3e56d_cgraph.png" border="0" usemap="#apkvm_8h_a26c97c43a67f2b519b95a2d4f3f3e56d_cgraph" alt=""/></div>
<map name="apkvm_8h_a26c97c43a67f2b519b95a2d4f3f3e56d_cgraph" id="apkvm_8h_a26c97c43a67f2b519b95a2d4f3f3e56d_cgraph">
<area shape="rect" title=" " alt="" coords="5,81,168,108"/>
<area shape="rect" href="hyp_2nvhe_2pkvm_8c.html#af3a9f8da5f6f1ac6c51d8b4cf7be26ca" title=" " alt="" coords="216,5,361,32"/>
<area shape="rect" href="memory_8h.html#a52854ece4f50a52b454b91f1a144b189" title=" " alt="" coords="221,56,357,83"/>
<area shape="rect" href="spinlock_8h.html#ae942ff0e878cb0f4d55ddc4cc6275ec9" title=" " alt="" coords="231,107,346,133"/>
<area shape="rect" href="spinlock_8h.html#a2c6e9db70599188dbe031e2ce8ec6b08" title=" " alt="" coords="223,157,354,184"/>
<area shape="rect" href="hyp_2nvhe_2pkvm_8c.html#a44f3b33f9c9af29ae5def49898ff81dd" title=" " alt="" coords="409,5,551,32"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="pkvm_8h_a26c97c43a67f2b519b95a2d4f3f3e56d_icgraph.png" border="0" usemap="#apkvm_8h_a26c97c43a67f2b519b95a2d4f3f3e56d_icgraph" alt=""/></div>
<map name="apkvm_8h_a26c97c43a67f2b519b95a2d4f3f3e56d_icgraph" id="apkvm_8h_a26c97c43a67f2b519b95a2d4f3f3e56d_icgraph">
<area shape="rect" title=" " alt="" coords="236,5,399,32"/>
<area shape="rect" href="hyp-main_8c.html#a4ee0e6f5a31d21183ee7fea340479a2a" title=" " alt="" coords="5,5,188,32"/>
</map>
</div>

</div>
</div>
<a id="af533677cbf7e0a82423e25e6ab146d3a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af533677cbf7e0a82423e25e6ab146d3a">&#9670;&nbsp;</a></span>pkvm_put_hyp_vcpu()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void pkvm_put_hyp_vcpu </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structpkvm__hyp__vcpu.html">pkvm_hyp_vcpu</a> *&#160;</td>
          <td class="paramname"><em>hyp_vcpu</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="hyp_2nvhe_2pkvm_8c_source.html#l00281">281</a> of file <a class="el" href="hyp_2nvhe_2pkvm_8c_source.html">pkvm.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;{</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    <span class="keyword">struct </span><a class="code" href="structpkvm__hyp__vm.html">pkvm_hyp_vm</a> *hyp_vm = <a class="code" href="pkvm_8h.html#af309540fc98994ba55e970bf4ec14b65">pkvm_hyp_vcpu_to_hyp_vm</a>(hyp_vcpu);</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160; </div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    <a class="code" href="spinlock_8h.html#ae942ff0e878cb0f4d55ddc4cc6275ec9">hyp_spin_lock</a>(&amp;vm_table_lock);</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;    <a class="code" href="memory_8h.html#a3cc326fe973add2b2ea91f6b04dd8fde">hyp_page_ref_dec</a>(<a class="code" href="memory_8h.html#a1ce5e4fc197c0773bbd80fb4b5270369">hyp_virt_to_page</a>(hyp_vm));</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    <a class="code" href="spinlock_8h.html#a2c6e9db70599188dbe031e2ce8ec6b08">hyp_spin_unlock</a>(&amp;vm_table_lock);</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;}</div>
<div class="ttc" id="amemory_8h_html_a3cc326fe973add2b2ea91f6b04dd8fde"><div class="ttname"><a href="memory_8h.html#a3cc326fe973add2b2ea91f6b04dd8fde">hyp_page_ref_dec</a></div><div class="ttdeci">static void hyp_page_ref_dec(struct hyp_page *p)</div><div class="ttdef"><b>Definition:</b> <a href="memory_8h_source.html#l00058">memory.h:58</a></div></div>
<div class="ttc" id="apkvm_8h_html_af309540fc98994ba55e970bf4ec14b65"><div class="ttname"><a href="pkvm_8h.html#af309540fc98994ba55e970bf4ec14b65">pkvm_hyp_vcpu_to_hyp_vm</a></div><div class="ttdeci">static struct pkvm_hyp_vm * pkvm_hyp_vcpu_to_hyp_vm(struct pkvm_hyp_vcpu *hyp_vcpu)</div><div class="ttdef"><b>Definition:</b> <a href="pkvm_8h_source.html#l00051">pkvm.h:51</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="pkvm_8h_af533677cbf7e0a82423e25e6ab146d3a_cgraph.png" border="0" usemap="#apkvm_8h_af533677cbf7e0a82423e25e6ab146d3a_cgraph" alt=""/></div>
<map name="apkvm_8h_af533677cbf7e0a82423e25e6ab146d3a_cgraph" id="apkvm_8h_af533677cbf7e0a82423e25e6ab146d3a_cgraph">
<area shape="rect" title=" " alt="" coords="5,81,161,108"/>
<area shape="rect" href="memory_8h.html#a3cc326fe973add2b2ea91f6b04dd8fde" title=" " alt="" coords="243,5,383,32"/>
<area shape="rect" href="spinlock_8h.html#ae942ff0e878cb0f4d55ddc4cc6275ec9" title=" " alt="" coords="255,56,370,83"/>
<area shape="rect" href="spinlock_8h.html#a2c6e9db70599188dbe031e2ce8ec6b08" title=" " alt="" coords="247,107,378,133"/>
<area shape="rect" href="pkvm_8h.html#af309540fc98994ba55e970bf4ec14b65" title=" " alt="" coords="209,157,416,184"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="pkvm_8h_af533677cbf7e0a82423e25e6ab146d3a_icgraph.png" border="0" usemap="#apkvm_8h_af533677cbf7e0a82423e25e6ab146d3a_icgraph" alt=""/></div>
<map name="apkvm_8h_af533677cbf7e0a82423e25e6ab146d3a_icgraph" id="apkvm_8h_af533677cbf7e0a82423e25e6ab146d3a_icgraph">
<area shape="rect" title=" " alt="" coords="236,5,392,32"/>
<area shape="rect" href="hyp-main_8c.html#a4ee0e6f5a31d21183ee7fea340479a2a" title=" " alt="" coords="5,5,188,32"/>
</map>
</div>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
